!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Apple2=t():e.Apple2=t()}(self,(function(){return(()=>{var e,t,s={800:(e,t,s)=>{var i={"./apple2_char":[975,975],"./apple2_char.ts":[975,975],"./apple2e_char":[189,189],"./apple2e_char.ts":[189,189],"./apple2enh_char":[64,64],"./apple2enh_char.ts":[64,64],"./apple2j_char":[132,132],"./apple2j_char.ts":[132,132],"./apple2lc_char":[957,957],"./apple2lc_char.ts":[957,957],"./pigfont_char":[30,30],"./pigfont_char.ts":[30,30],"./rmfont_char":[601,601],"./rmfont_char.ts":[601,601]};function r(e){if(!s.o(i,e))return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=i[e],r=t[0];return s.e(t[1]).then((()=>s(r)))}r.keys=()=>Object.keys(i),r.id=800,e.exports=r},190:(e,t,s)=>{var i={"./apple2e":[553,553],"./apple2e.ts":[553,553],"./apple2enh":[45,45],"./apple2enh.ts":[45,45],"./apple2ex":[875,875],"./apple2ex.ts":[875,875],"./apple2j":[156,156],"./apple2j.ts":[156,156],"./fpbasic":[94,94],"./fpbasic.ts":[94,94],"./intbasic":[89,89],"./intbasic.ts":[89,89],"./original":[663,663],"./original.ts":[663,663]};function r(e){if(!s.o(i,e))return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=i[e],r=t[0];return s.e(t[1]).then((()=>s(r)))}r.keys=()=>Object.keys(i),r.id=190,e.exports=r},911:e=>{"use strict";const t=function(){const e=class{constructor(e,t){this.x=e,this.y=t}},t=class{constructor(e,t){this.width=e,this.height=t}copy(){return new t(this.width,this.height)}get ratio(){return this.width/this.height}},s=class{constructor(s,i,r,a){this.origin=new e(s,i),this.size=new t(r,a)}get x(){return this.origin.x}get y(){return this.origin.y}get width(){return this.size.width}get height(){return this.size.height}get l(){return this.origin.x}get r(){return this.origin.x+this.size.width}get t(){return this.origin.y}get b(){return this.origin.y+this.size.height}},i=class{constructor(e){this.data=new Float32Array(e)}normalize(){const e=this.data;let t=0;for(const s of e)t+=s;const s=1/t;for(const t in e)e[t]*=s;return this}mul(e){const t=new i(0);if("number"!=typeof e&&this.data.length!=e.data.length)return t;t.data=new Float32Array(this.data);for(let s=0;s<t.data.length;s++)t.data[s]*="number"==typeof e?e:e.data[s];return t}realIDFT(){const e=this.data.length,t=new i(e);for(let s=0;s<e;s++){const i=2*Math.PI*s/e;for(let r=0;r<e;r++)t.data[s]+=this.data[r]*Math.cos(r*i)}for(let s=0;s<e;s++)t.data[s]/=e;return t}resize(e){const t=new Float32Array(e);for(let e=0;e<Math.min(t.length,this.data.length);e++)t[e]=this.data[e];return this.data=t,this}static chebyshevWindow(e,t){const s=e-1;let r=new i(s);const a=Math.cosh(Math.acosh(Math.pow(10,t/20))/s);for(let e=0;e<s;e++){const t=Math.abs(a*Math.cos(Math.PI*e/s));r.data[e]=t>1?Math.pow(-1,e)*Math.cosh(s*Math.acosh(t)):Math.pow(-1,e)*Math.cos(s*Math.acos(t))}r=r.realIDFT(),r.resize(e),r.data[0]/=2,r.data[e-1]=r.data[0];const o=r.data.reduce(((e,t)=>Math.max(e,Math.abs(t))));for(const e in r.data)r.data[e]/=o;return r}static lanczosWindow(e,t){let s=new i(e);t=Math.min(t,.5);const r=Math.floor(e/2);for(let i=0;i<e;i++){const e=2*Math.PI*t*(i-r);s.data[i]=0==e?1:Math.sin(e)/e}return s}},r=class{constructor(e,t,s,i,r,a,o,n,h){this.data=new Float32Array([e,t,s,i,r,a,o,n,h])}at(e,t){return this.data[3*e+t]}mul(e){const t=new r(0,0,0,0,0,0,0,0,0);if("number"==typeof e)t.data=this.data.map((t=>t*e));else for(let s=0;s<3;s++)for(let i=0;i<3;i++)for(let r=0;r<3;r++)t.data[3*s+i]+=e.data[3*s+r]*this.data[3*r+i];return t}},a=315/88*1e6,o=4*a,n=7e5,h=new s(9.411134370015947,19,53.97228867623605,240),d=new s(16,38,40,192),c=new s(11.54839708211501,21,52.81416776315789,288),l=new s(16,48,40,192),m="\n// an attribute will receive data from a buffer\nattribute vec4 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_texCoord;\n\n// all shaders have a main function\nvoid main() {\n  gl_Position = a_position;\n  v_texCoord = a_texCoord;\n}\n";function u(s,i,r,a,o){const n=i.y,h=65*a,d=Math.floor(i.x),c=new t(Math.floor(14*r.width),Math.floor(r.height)),l=Math.floor(14*(d-r.x));return{fsc:o,clockFrequency:s,displayRect:i,visibleRect:r,vertStart:n,vertTotal:a,frameCycleNum:h,horizStart:d,imageSize:c,imageLeft:l,colorBurst:[2*Math.PI*(-33/360+l%4/4)],cycleNum:h+16,topLeft:new e(l,n-r.y),topLeft80Col:new e(l-7,n-r.y)}}const p=u(1020484.4497607657,d,h,262,a),g=u(926279250/912,l,c,312,4433618.75),f=e=>new Promise(((t,s)=>{const i=new Image;i.onload=()=>t(i),i.onerror=()=>s(`error loading '${e}'`),i.src=e})),A=["SHADOWMASK_TRIAD","SHADOWMASK_INLINE","SHADOWMASK_APERTURE","SHADOWMASK_LCD","SHADOWMASK_BAYER","IMAGE_PHASEINFO","IMAGE_IN","IMAGE_DECODED","IMAGE_PERSISTENCE"],b=["COMPOSITE","DISPLAY","RGB"],_=e=>{const t=e.clientWidth,s=e.clientHeight;e.width==t&&e.height==s||(e.width=t,e.height=s)},w=(e,t,s,i)=>{const r=e.createShader(s);if(e.shaderSource(r,i),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS))return r;const a=e.getShaderInfoLog(r);throw e.deleteShader(r),new Error(`unable to compile shader ${t}: \n${a}`)},y=(e,t,...s)=>{const i=e.createProgram();for(let t of s)e.attachShader(i,t);if(e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS))return i;const r=e.getProgramInfoLog(i);throw e.deleteProgram(i),new Error(`unable to compile program ${t}: \n${r}`)},S=class{constructor(e,t,s){this.width=e,this.height=t,this.glTexture=s}get size(){return new t(this.width,this.height)}};return{C:{HORIZ_START:16,HORIZ_BLANK:25,HORIZ_DISPLAY:40,HORIZ_TOTAL:65,CELL_WIDTH:14,CELL_HEIGHT:8,VERT_NTSC_START:38,VERT_PAL_START:48,VERT_DISPLAY:192,BLOCK_WIDTH:40,BLOCK_HEIGHT:24,NTSC_I_CUTOFF:13e5,NTSC_Q_CUTOFF:6e5,NTSC_IQ_DELTA:n,NTSC_DETAILS:p,PAL_DETAILS:g},loadImage:f,screenData:(e,t,s=!0)=>{if(560!=e.naturalWidth||192!=e.naturalHeight)throw new Error(`screenData expects an image 560x192; got ${e.naturalWidth}x${e.naturalHeight}`);const i=document.createElement("canvas"),r=i.getContext("2d"),a=t.imageSize.width,o=t.imageSize.height;i.width=a,i.height=o,r.fillStyle="rgba(0,0,0,1)",r.fillRect(0,0,a,o);const n=s?t.topLeft80Col:t.topLeft;return r.drawImage(e,n.x,n.y),[i,r.getImageData(0,0,a,o)]},resizeCanvas:_,createShader:w,createProgram:y,ScreenView:class{constructor(e){const i=e.getContext("webgl");if(null==i.getExtension("OES_texture_float"))throw new Error("WebGL extension 'OES_texture_float' unavailable");this.canvas=e,this.gl=i,this.textures={},this.shaders={},this.buffers=[],this.image=null,this.display=null,this.imageSampleRate=null,this.imageBlackLevel=null,this.imageWhiteLevel=null,this.imageSubcarrier=null,this.viewportSize=new t(0,0),this.persistenceTexRect=new s(0,0,0,0),this.configurationChanged=!0,this.imageChanged=!0}get image(){return this._image}set image(e){this._image=e,this.imageChanged=!0}set displayConfiguration(e){this.display=e,this.configurationChanged=!0}async initOpenGL(){const e=this.gl;e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.textures={};for(let t of A)this.textures[t]=new S(0,0,e.createTexture());for(let t=0;t<3;t++)this.buffers.push(e.createBuffer());await this.loadTextures(),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),this.loadShaders()}freeOpenGL(){const e=this.gl;for(let t of A)e.deleteTexture(this.textures[t].glTexture);for(let t of this.buffers)e.deleteBuffer(t);this.deleteShaders()}loadTextures(){return Promise.all([this.loadTexture("data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAIAAABdtOgoAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAB5hJREFUeNrsXEtolUcU/u6NNT4SH0SNbyUlrVpTlPRBqykq0RjpQsT6WATFhbowLrS4KEKhRaorFxZEixSkipviwvoIFVtiVSq+tW1qia8mPmpFk6gx5tX/frcX0jT3n5l/zrEU7seskpn5zpkz/8ycM2duDKEoAGYD04GJwFCgP//4BLgP/AL8AHwLXIMaXgKKKcFbFGUwkA20AU1APXABOAZUAw/1JAgo3wNmAVOAUUAu0AtoIWWg92kOwFmgVZ55DnAIeAZ0hpZnrDZHnD7QdA1w2UQflHvANqBQXIJC9nvPQoLLlDVXjHkScNiCtls5zIYy+ACodaR/CnwG5IjQ57Cvp44S1FJubywHGtxHP1ka2NwLwRq3Myp9UM4BRZ4SFLGXyBLsTK3T7ujnp3tXEfpFk2AycMab/qHPLFjO9p4SnKEm7tglMfrJsisC/TigRoi+HVgSQYIlbCkiQQ31cUGl3OgnS6UTfXCyOCBK/4frWlTENoISHKBWdnjVbrN3KvfYrS1WSdMHZb+TAfYrSLDKlvxLBfJOdmuFke5nHsuyyFKCRTr0tdTNhCl0rDT4n7BzMzbo0AfleyBupI+znpIEG8z0pZEPLRbHqlJjpRhQrubGvmlzHpnMekoop4ahBngXijB3Pjbimc12ChQbKxWrzcCkdccaDPCypgGCzvuG1xgPDNGUYKJADQ8MoYahBhiizG+IDgyDLkYK1PCDQcN4XJM8blwCY8rqxwRqqEoQb9Qkb2S41FBDFQ8FaniPQagB7miS3zHy1wPNmhLcEKjhgWZqGGqAak1+c+dXgStq9G3ACWOlE6ynhCvUMNQAR1SucxIIuj1irNQCVKmpf56hZQPOsZ4SqqihaY84quMFHrXc4Iq4TmlIsM5ymNbp0DfaRgTn6/DPt58oOxTof7U/4w5jbXEJdjh8Ktulybc7faljuFoK0j8HFjpJsJBtBCW4Qq2s0Yd361Lkh9ihG4pFA/LrI6zX60WvI4qd+YcDJyXIT7KriJGrBgkJtkTeM7dI0DdEjy8OjZQP0S03YqjPqWEmUOdB3wFs9Dy3bGQvkSWoow4eyAY+ovPgylzPhtn+J7cCYJ/7HUUHL8PniZwd57GvDvfrj32UXgI5TDWqsb6BXiOVktM1jvo58MCCvpWn7VJIo5T9tlpI8ICyRgwrx8K/hmnA+8A7tOzA1ARv4Tp3DTgFfENXsgU6CJazuUAZMJVRy1wgiyo3p5Ijv6MEP+v58pM4ADNTuZl9OWLtTI68TQ+uiu7mfcVoYRLB6OelgvvNNHoDXiCySD8I6E31H1PlZy9Sgj40QA5FCQ6sjzgG7cgggwwy+D8jpk+Ry5jUFG7keVzFnzBxq4ab2FXNaHACI7mFBxKM5k4G7l51TCo/z51UF72AVyjBBCCfmbvPuX1c4/uGQIhEEnypEvl0ZmfdTn+Aa6MIHxtvrqOdpCv4fKIpPX0TK1SIn6GTGE/NLlPLdBIENvjb5TkJLOPsFEBv9lXt4ssEk/IrHnoFMAr41DHZrpZNRkkN/TRq02CXy/2PUapyC+GlCWxWRfXjg6nyCc950VHuEcuo808Sy6IGbS6J3N3/dNXnjUMR23sGs/ZEiKUmsdLOcw13q1f6uAp73Cl7+NNv0Z5cFbKlSDh3t01SZzcsE0rvb2dXzohT6k4RA3QyyJDvxJ/PNoIXGm4x5bmhm61raWKHLyiSHTYLHbBb4Upvqf22c12a+7rTbrjUgylsOZxhyT/De+3tsZy1fPC2WedOe7Ol9v0pqbwBHD6C3TojEJTFRu4RwC0d7lvs3IzFXjShe91suo8GjGY9JSywCduP0eEeY+mhLvBiCTXAcKDE2ENJ5DtgO196hPHgr4dymw9wup4BYOMTFGmOwPDwS75shlj0MMF4yVrgO/3iZgt71/ATb1h4wCdPkz7P5n1DXNUAZp+0D3SRHR5qzFbm7hVdOgt0Gg1gvnjUvppsCvlfC28n9fDYeN3dJPCNh+KmsYebmiPQEp5fHxj/rib9XeP8qvfLSIgZDXDB2McFzRG4RZ805AvGRU36i0lXKQTXKaPWF3CTPp4BZzU/ghPGKXhM0wDmzhts3oCY9oG0ZatlF1t1XNF2pgQZMAi4pEN/iZ2bUeYXhk37j9/tf3JlHGuLj8BeS/oKHQNU2E/ivRoGWOv0Ha2VVv9PexcvCzgoTX/Q6WauiPJKGuBr15vBLLYRHIHVTvST/LKq/3036fz7d6sFDVDtehuTRD5biozApgj0ZXa5vDaptmXRdtNNIgbY5pMb0ZvtfdR/ZBOCTodC/pKnD/1pzx/AXEwN3AzQ1sX0K0QObyuizsXTzGDywkCPF387UplbXpjqOAsSjymDU9QXxt9VccJY9vjU5fKjUjCuMws47jIIx9lEMoRUaXdPlPCiP9QL6Rbwxc8ZRkw6esoCus/jRnDeG6ARRy3hb2jWUs0eda9lhRLfgGYaDKBmB6llW09PeloTTlws8fvMSk/lEwh6fx14g2lng/nAIIt8j1MJkqdUf60h8KTeBl7jCWFAlwcmjcxO/Qn4kYu2Isan3rfkcYFLxo6f89h6gwmJGWSQQQb/Hf4SYABjDjkS7NbBvAAAAABJRU5ErkJggg==",!0,"SHADOWMASK_TRIAD"),this.loadTexture("data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAIAAABdtOgoAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAxdJREFUeNrsnDtoVEEUhr9do0YwAR9YiGJhoYIiFiJooSJoI6KFj8KIIAQRIwQsLI2IYhHBQkGxUolgowQtREEJPlAxEhstYnwQNBLQJMSYxI3xetLkce7dCUuKvfv/TLP3nHNnmG927mPOXDKwE5rgB/yC3lEl+tkNb6EGyonRDGiA3NjIcSWyXiBe1eb0Oz7+D7yExRMjK62Fw2Flg1v5reD482787uD4VuJOMBAQfTKu9w6H1d5vnB2thC9hp7iYSgDZEzaI8+oorHANGwnSTFjvGpa5Q9vTFtKo7NIwv3kwxzVMC66qzG9AgfFFDyAT7JpBmgIA6gIBEABJAARAEgABkARAACQBEABJAASgVDQsAIXpb4Fd/TU4/pt79GdwE9pTCKAPXoR5fojr6ivwOSD+DVx3DU22qJZXA1CfQgA5OAXfA9xOwyfX9g72wwOD6aoHbsNB6HDNg1Bry6Wd8ZU3W/xd11z0y0zPYDMcgTW2tjp6nsnAELTBVXiUcIonsAPmwnRvnhq0fIXBhPiIzDGog1kxc2SXpRaQTgAjg7imwFP0T+Zi4Pdyp+6CdBsqCYAASAIgAJIACIAUpjQ8iC2CA7DaMoDHPQnn4CPcgJaE+GrL3B6Id4iekK8lvPJZB8et8qEYh8j0Gs76rzuKPb17lRmSI3tgV1zvbbXH4LyVd9q7DkcLbO9CSPtrUzgFZW3jQt4E7wp7U7PQte2xAZpX8+P2N0TDf21YY6tSCGA2bArzjP4oS1xDZXBlFe7R8uD4ynRehMsm83fRXZAkAAIgCYAASAIgAJIACIAkAAIgAJIACIBUrAAKzc8fLnUAfcGuOffoq7DgIUvSdtQWnNb6NJ0A7oT5PYb3ruEy3A+Ib4CbrqE5bufCWLXCmVQCKKuzrILtiU4ttuzf7dp6YR8cgm32Ta1xM1LGxnejZRXETlbnLMO8yr5dlh07KWXtY37P4VLYRpYiBNABe22Pw/IJGxRGNji0w8PkaaLLBnF9Ic1otFKK+r+kGl0G7lmRdBsqAJIACIAkAAIgCYAASFOvfwIMAIJ7Za+ecZHPAAAAAElFTkSuQmCC",!0,"SHADOWMASK_INLINE"),this.loadTexture("data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAIAAABdtOgoAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAJ9JREFUeNrs0bEJgEAURMHFWGzIOmzLQqzJJkyMBDUw85DLRJzHpQv/mCzJXvf6lJqq92NxP1Tv5/u4Sz59/1kTvRoAAAAEAIAAABAAAAIAQAAACAAAAQAgAA+tAN5tAyAAAAQAgAAAEAAAAgBAAAC4/hdfaAEIAAABACAAAAQAgAAAEAAAAgBAAAAIAAABACAAAAQAgAAAEAAAujoEGADEOVdpwC68FwAAAABJRU5ErkJggg==",!0,"SHADOWMASK_APERTURE"),this.loadTexture("data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAIAAABdtOgoAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAedJREFUeNrsnL9rFEEcR9+uPwhyXBQbm1QWRsg/kcomiCCWVoLYpE5rbWehFnYWpk9lIQhCCCgKWgmCoNglCIomBs/EzVReMnd+RTj94ntMczv72f3OvpvhDpahgQvwGD7AF/j8U+s+foSXsAhTjOAo3IfBcHJf63pvMpqr5aSt0flv8ARmDib7kL1+LsE27P6qXR9192uBcNe+ludUYQ7exS5xqzqA7PXzLJbegLPVApZj+a7dqOYvhvOvqgPIXn97mhAn4US14xBRDlePtn+Yz15/24QvED9zkmSvv0UUoABRgAJEAQoQBShAFKAAUYACRAEK+NfZTP70N7MLGCQXMHAJcglSgChAAaIABYgCFCAKUIAoQAFWP7H6cw+hl1xAzyXISawAUYACRAEKEAUoQBSgAFGAAkQBCpAcAnbCZ+7+xtHJ8bfrb+Ov2NffBX8aC3+H59WON7Aeu8Rq9Wj2+rkT2+7pEUxX8z14EMjfGzPZlgL513DmYLKfv/7mFNyFhbHuXsCVsjlYneOl+1zZk2rfjG7K92OlDGBrzB3Ow+WyrV07PKnbEluD2/C2OoBjyevf20aqG8M8zMKR4XRTZt57eBieZhOmG8Cn5PXnpp+/fn+G+j9AAaIABYgCFCAK+P/4IcAAEwdyjgWX2v0AAAAASUVORK5CYII=",!0,"SHADOWMASK_LCD"),this.loadTexture("data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAIAAABdtOgoAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAACPNJREFUeNrsXFuMFEUUPdUzs7vsg13XZRVlgQUiKhJFjYhiQnxFIyHqjxHlx2j48c8fE01MjMZHYjTGD2NEVDB+YYgJiYogIT54BJ+orKgQwkN5LC9hd2dnuu051TXTM1vd0z0zDRThZjKZ7qmqe27fW7du3bozAiQBOMBFwFFeXg9cB9wMXAV0884g8DuwCfgR+J53ZGPZsTrJdu3Af7ycAUzn6JOBDt45Cewhj7+AP3lHNo7AwHTwHl0MHAG6gCXAw0A/+wrVwlGXu4CPgRXAMdUlKo0HThDZncACYKIasUjy8gCwAfiSAsguEchc8N4YXcQ0E3gWuBtI+XA7ql1RnhywFngBGFAdq5O0iEnAI8ANgKUYwMeg+J6noX4E7PXZXTAZDT4lxz/BafsacDtgq1fF7CnetDj/ZgPbgd3sng1nMg44zWm7lGzkgxnLoPjAXAZ9NGN39H/ZPRf2cMwFX1BAG3AKuIIC3AIM+yavGDNZijPaVfM0Gt0WTjt3kNEgDi0cdBIFmEVxozBwJbyMvQbowlv0YhgNvqQAl8UrwF3ASMWyEOq23DGncJX7VMngBMng4n6ci+NoHAbuc+rlKvedksHRKMBc8J4CXAEWA08ATWxmRVuTBNVsUc0Hga30p8Paplm6hnuBDPuIyAykv+gBjtOU2jTOwmjwUB4Li4ggG1mAYs8sOy7ipWsfzUFN59HX5iILUBQjx47zlE1lNK2MBl9A8iCnV9zx/VzmAA9wtW/VNprPwDmPGinPBfBWYEjzkIwG7ylgNp1VPTJcwqBCXqbGNuqnpeVrZZDnrqlfXZbbudHgPQX016HgYgA2mR+OaufZpfSedTLo5QfXUNOVz8dc8J4CpozZ09XAoo/rjaM1ot66Gbg0AehUK5uPjAbvKaA7Yj4kVIZulXXRsOhoBIMOlXURZQupueBLUqTrZiH306mwvXbdZOnNx2jw3pen655h4F59yJcaKaORRsgwohnHIV9DwZcUcLBuGdzuh4B9KuVSSccaweC4Sl3aZQowF3xJAQN1T2SLafBR5l81SZW9nMhOfTLsZ8zYWhn0GA3eA7CTE1DUMf4QZQDzARoZ9nHTWQ+DLHNmYJxYntUyGryngPXA38wX1RDv2uzodl8f4jB/IIKmmuzIYccDHASadIrR4EsuaDMnhxWTi4xr8+w+wAOmk9p27izeoTJZcRnItNkODjJerZXlLshc8KU46w9gLlODcbfczTxlfUatVYFZdRfBldzt2DEZZOgglqtzJZ0PNRp8QQFdwD8c/EZuFyLmVWwKcBh4A9jIfMnJoKbtPJRweG7SGvk5ORTAjR8+AX7hIDoLMhq8pwCJZhun4Wx1giYiCOCGzx8AbxLYSEhOxiaanZyG/exZVQwpwDBPb1ezy6jezRsN3lNAXgUAG2gL05i/yysn5pQv6dJ1jmPsvAJ4TsUPw+ESywDgZ9rCRL7boQya6BfWAR+quZwNTPeaC95TgIyU5LHcV8pf9dE0HN/gFpeLZtqLGza8D7zOr+SprKia9pXHcj8pcSfwjuOrJ7AU+lGGDV8Aq/iVPJUVYWGeoeCLHAp9ZUzWTMfVCzzKI+hruLiNY7shrkbbgV+BldyCdlKeYdW9ChMZk2UosWurdwBT+epRJxUj9Mq7+VpHI5LPNVslAjEafClBV5xA3RxK0n2UoY2fT1GGNeqrHi5OdtziMkFnelzdnMuBWvh5mIw3q686WW3ixKiMMxR8ZeAU62Q1NqUbkTw7v8BbFQu4nagMTiPSx8Fjmwv+fKD0hUdwgc5ZEmPdXWK9DAMvyhb6ZErgfdTNAMSlm1jRM5/hYjdHOcJA8RtubLeUN44WpZgJ3reuJ1m/T5IV+e77Y6zjn6GiR39Rq8WNv7uJfDdeEb+x4EUp65RUCbw0M4nG3SE9Dyz0MajYzguVmvwMeJqpYmlKoRsmk8Hz2D/hEnhmaAaZsnyLhcyOqtfXRpKyQmcW02sDtKlu4gvI+RsLPiMKiaBU8iXwneoHLMtYqppVm1ARPCOlhNOAq5lb2cVBdEkzU8EXRmi2hEuphEvgWzio2/Rtms9wMHotg6lMvqxilG9p0sYmg885hVcq4RL4dmZiFgNPxmQAxeBylhVsozBjzjWMBl8KVJMqgc8oX7mE0zAfn8EoF8CHeHlEJTfLyWjwBQUkWALfykBvIavwRU2ZFPmc5tLI5fFJORkN3lNAgiXwUqZ7GAnUXF7jMGK/Te/gjQbvKSCpEviMssw+33SugWwOOscX1fvIaPCeApIqgU+rfeD4aNFJyBNKMWaEpnbEaPCeApIqgZfmNJMrXf0kl8jTlbeNBu9xSrYEPtOgGvuwjbyh4DNCMk+qBF5a5mB42Uc0Ey2+pzR8TQUvUkKkhbASK4HPcXuzn3sZ1OEphEooQxNKGwzeGbadIduxEiuBz6qahEP1rWPyN9Xb9TPAaPBei6RK4G11sYmGmqn1OVmMH77WPwijwXstEiyBl9mPlbQxq1YfmuJj/rbCR3hkNHhPAQmWwGdVMn1j/OJu/251DXmM1yyJRoMvJeNW87C0hrqONDuuDgpI8moivwr8xs193IRiMx3oMp+/GENGgy/MkWRL4LPMpRxgJLCA7UYjM5B1xi/xhK9H/SVfORkN3lNA4iXwMu27lQzmqdYiggCuWb4DvEwBDgfmWswFX6aABEvgbZVpXMv8+HQmMO1Q19nMEublwFNKpFyYAgwF7ykg8RJ4yUDazufMOlr8m40WX3BWLOIvGqdrPi/yq7awH8QbDb40RMIl8KpFC3eDRznoUlY1XcviqVaVq9rDp+ga83ssWOgi16EqDIwGX1kZl2AJfJHBBM5QSfdThnaVj9+jghKZaD4cNcA0GnxlZNaYEvjw6oE2dQiipV6VBogfVpoLvpHZ3YaR/Bcxq7RfOR/BizOLyfLVU8L3f7ZOcC4FSf/w4uyCT59RGYRVeHli0KsW8Nt6GSxYaUcU3i2rCSOD9rmhAB947/k6oYcBVdRgnQ1J/LWDwfGlDTvrODlqLS0yHda5MQ8igC9TAAL/MNF1Ui3ifwEGAI7Rd9mplcoZAAAAAElFTkSuQmCC",!0,"SHADOWMASK_BAYER")])}async loadTexture(e,t,s){const i=this.gl,r=this.textures[s],a=await f(e);i.bindTexture(i.TEXTURE_2D,r.glTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,a),t&&i.generateMipmap(i.TEXTURE_2D),r.width=a.naturalWidth,r.height=a.naturalHeight}loadShaders(){this.loadShader("COMPOSITE","\nprecision mediump float;\n\nvarying vec2 v_texCoord;\n\nuniform sampler2D texture;\nuniform vec2 textureSize;\nuniform float subcarrier;\nuniform sampler2D phaseInfo;\nuniform vec3 c0, c1, c2, c3, c4, c5, c6, c7, c8;\nuniform mat3 decoderMatrix;\nuniform vec3 decoderOffset;\n\nfloat PI = 3.14159265358979323846264;\n\nvec3 pixel(in vec2 q)\n{\n  vec3 c = texture2D(texture, q).rgb;\n  vec2 p = texture2D(phaseInfo, vec2(0, q.y)).rg;\n  float phase = 2.0 * PI * (subcarrier * textureSize.x * q.x + p.x);\n  return c * vec3(1.0, sin(phase), (1.0 - 2.0 * p.y) * cos(phase));\n}\n\nvec3 pixels(vec2 q, float i)\n{\n  return pixel(vec2(q.x + i, q.y)) + pixel(vec2(q.x - i, q.y));\n}\n\nvoid main(void)\n{\n  vec2 q = v_texCoord;\n  vec3 c = pixel(q) * c0;\n  c += pixels(q, 1.0 / textureSize.x) * c1;\n  c += pixels(q, 2.0 / textureSize.x) * c2;\n  c += pixels(q, 3.0 / textureSize.x) * c3;\n  c += pixels(q, 4.0 / textureSize.x) * c4;\n  c += pixels(q, 5.0 / textureSize.x) * c5;\n  c += pixels(q, 6.0 / textureSize.x) * c6;\n  c += pixels(q, 7.0 / textureSize.x) * c7;\n  c += pixels(q, 8.0 / textureSize.x) * c8;\n  gl_FragColor = vec4(decoderMatrix * c + decoderOffset, 1.0);\n}\n",m),this.loadShader("RGB","\nprecision mediump float;\n\nvarying vec2 v_texCoord;\n\nuniform sampler2D texture;\nuniform vec2 textureSize;\nuniform vec3 c0, c1, c2, c3, c4, c5, c6, c7, c8;\nuniform mat3 decoderMatrix;\nuniform vec3 decoderOffset;\n\nvec3 pixel(vec2 q)\n{\n  return texture2D(texture, q).rgb;\n}\n\nvec3 pixels(in vec2 q, in float i)\n{\n  return pixel(vec2(q.x + i, q.y)) + pixel(vec2(q.x - i, q.y));\n}\n\nvoid main(void)\n{\n  vec2 q = v_texCoord;\n  vec3 c = pixel(q) * c0;\n  c += pixels(q, 1.0 / textureSize.x) * c1;\n  c += pixels(q, 2.0 / textureSize.x) * c2;\n  c += pixels(q, 3.0 / textureSize.x) * c3;\n  c += pixels(q, 4.0 / textureSize.x) * c4;\n  c += pixels(q, 5.0 / textureSize.x) * c5;\n  c += pixels(q, 6.0 / textureSize.x) * c6;\n  c += pixels(q, 7.0 / textureSize.x) * c7;\n  c += pixels(q, 8.0 / textureSize.x) * c8;\n  gl_FragColor = vec4(decoderMatrix * c + decoderOffset, 1.0);\n}\n",m),this.loadShader("DISPLAY","\nprecision mediump float;\n\nvarying vec2 v_texCoord;\nvarying vec2 v_texCoord2;\n\nuniform sampler2D texture;\nuniform vec2 textureSize;\nuniform float barrel;\nuniform vec2 barrelSize;\nuniform float scanlineLevel;\nuniform sampler2D shadowMask;\nuniform vec2 shadowMaskSize;\nuniform float shadowMaskLevel;\nuniform float centerLighting;\nuniform sampler2D persistence;\nuniform vec2 persistenceSize;\nuniform vec2 persistenceOrigin;\nuniform float persistenceLevel;\nuniform float luminanceGain;\n\nfloat PI = 3.14159265358979323846264;\n\nvoid main(void)\n{\n  vec2 qc = (v_texCoord2 - vec2(0.5, 0.5)) * barrelSize;\n  vec2 qb = barrel * qc * dot(qc, qc);\n  vec2 q = v_texCoord + qb;\n\n  vec3 c = texture2D(texture, q).rgb;\n\n  float scanline = sin(PI * textureSize.y * q.y);\n  c *= mix(1.0, scanline * scanline, scanlineLevel);\n\n  vec3 mask = texture2D(shadowMask, (v_texCoord2 + qb) * shadowMaskSize).rgb;\n  c *= mix(vec3(1.0, 1.0, 1.0), mask, shadowMaskLevel);\n\n  vec2 lighting = qc * centerLighting;\n  c *= exp(-dot(lighting, lighting));\n\n  c *= luminanceGain;\n\n  vec2 qp = v_texCoord2 * persistenceSize + persistenceOrigin;\n  c = max(c, texture2D(persistence, qp).rgb * persistenceLevel - 0.5 / 256.0);\n\n  gl_FragColor = vec4(c, 1.0);\n}\n","\n// an attribute will receive data from a buffer\nattribute vec4 a_position;\nattribute vec2 a_texCoord;\nattribute vec2 a_texCoord2;\nvarying vec2 v_texCoord;\nvarying vec2 v_texCoord2;\n\n// all shaders have a main function\nvoid main() {\n  gl_Position = vec4(a_position.x, -a_position.y, a_position.z, a_position.w);\n  v_texCoord = a_texCoord;\n  v_texCoord2 = a_texCoord2;\n}\n")}loadShader(e,t,s){const i=w(this.gl,e,this.gl.VERTEX_SHADER,s),r=w(this.gl,e,this.gl.FRAGMENT_SHADER,t),a=y(this.gl,e,i,r);this.gl.deleteShader(i),this.gl.deleteShader(r),this.shaders[e]=a}deleteShaders(){for(let e of b)this.shaders[e]&&(this.gl.deleteProgram(this.shaders[e]),this.shaders[e]=!1)}vsync(){const e=this.gl;_(this.canvas);const s=this.canvas.width,i=this.canvas.height;this.viewportSize.width==s&&this.viewportSize.height==this.canvasHeight||(this.viewportSize=new t(s,i),e.viewport(0,0,s,i),this.configurationChanged=!0),this.imageChanged&&this.uploadImage(),this.configurationChanged&&this.configureShaders(),(this.imageChanged||this.configurationChanged)&&this.renderImage(),(this.imageChanged||this.configurationChanged||0!=this.image.displayPersistence)&&this.drawDisplayCanvas(),this.imageChanged=!1,this.configurationChanged=!1}uploadImage(){const e=this.gl,t=this.image;this.resizeTexture("IMAGE_IN",t.width,t.height,!0);const s=this.textures.IMAGE_IN;e.bindTexture(e.TEXTURE_2D,s.glTexture);const i=e.LUMINANCE,r=e.UNSIGNED_BYTE,a=(e=>{const t=e.width,s=e.height,i=e.data,r=t*s,a=new Uint8Array(r);for(let e=0;e<r;e++)a[e]=Math.max(i[4*e],i[4*e+1],i[4*e+2]);return a})(t.data);e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.data.width,t.data.height,i,r,a),t.sampleRate==this.imageSampleRate&&t.blackLevel==this.imageBlackLevel&&t.whiteLevel==this.imageWhiteLevel&&t.subCarrier==this.imageSubcarrier||(this.imageSampleRate=t.sampleRate,this.imageBlackLevel=t.blackLevel,this.imageWhiteLevel=t.whiteLevel,this.imageSubcarrier=t.subCarrier,this.configurationChanged=!0);const o=2**Math.ceil(Math.log2(t.height)),n=t.colorBurst,h=t.phaseAlternation,d=new Float32Array(3*o);for(let e=0;e<t.height;e++){const t=n[e%n.length]/2/Math.PI;d[3*e+0]=t-Math.floor(t),d[3*e+1]=h[e%h.length]}const c=this.textures.IMAGE_PHASEINFO;e.bindTexture(e.TEXTURE_2D,c.glTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGB,1,o,0,e.RGB,e.FLOAT,d)}getRenderShader(){switch(this.display.videoDecoder){case"CANVAS_RGB":case"CANVAS_MONOCHROME":return[this.shaders.RGB,"RGB"];case"CANVAS_YUV":case"CANVAS_YIQ":case"CANVAS_CXA2025AS":return[this.shaders.COMPOSITE,"COMPOSITE"]}const e=this.display.videoDecoder;throw new Error(`unknown displayConfiguration.videoDecoder: ${e}`)}configureShaders(){const e=this.gl,[t,s]=this.getRenderShader(),a=this.shaders.DISPLAY,o="COMPOSITE"==s;e.useProgram(t),o&&e.uniform1f(e.getUniformLocation(t,"subcarrier"),this.imageSubcarrier/this.imageSampleRate);const h=i.chebyshevWindow(17,50).normalize();let d,c,l;const m=this.display.videoBandwidth/this.imageSampleRate;if(o){let e=this.display.videoLumaBandwidth/this.imageSampleRate,t=this.display.videoChromaBandwidth/this.imageSampleRate,s=t;"CANVAS_YIQ"==this.display.videoDecoder&&(t+=n/this.imageSampleRate),(0==this.imageSubcarrier||this.display.videoWhiteOnly)&&(e=m,t=m,s=m),d=h.mul(i.lanczosWindow(17,e)),d=d.normalize(),c=h.mul(i.lanczosWindow(17,t)),c=c.normalize().mul(2),l=h.mul(i.lanczosWindow(17,s)),l=l.normalize().mul(2)}else d=h.mul(i.lanczosWindow(17,m)),c=l=d=d.normalize();e.uniform3f(e.getUniformLocation(t,"c0"),d.data[8],c.data[8],l.data[8]),e.uniform3f(e.getUniformLocation(t,"c1"),d.data[7],c.data[7],l.data[7]),e.uniform3f(e.getUniformLocation(t,"c2"),d.data[6],c.data[6],l.data[6]),e.uniform3f(e.getUniformLocation(t,"c3"),d.data[5],c.data[5],l.data[5]),e.uniform3f(e.getUniformLocation(t,"c4"),d.data[4],c.data[4],l.data[4]),e.uniform3f(e.getUniformLocation(t,"c5"),d.data[3],c.data[3],l.data[3]),e.uniform3f(e.getUniformLocation(t,"c6"),d.data[2],c.data[2],l.data[2]),e.uniform3f(e.getUniformLocation(t,"c7"),d.data[1],c.data[1],l.data[1]),e.uniform3f(e.getUniformLocation(t,"c8"),d.data[0],c.data[0],l.data[0]);let u=new r(1,0,0,0,1,0,0,0,1);o||(u=new r(.299,-.168736,.5,.587,-.331264,-.418688,.114,.5,-.081312).mul(u)),"CANVAS_MONOCHROME"==this.display.videoDecoder&&(u=new r(1,.5,0,0,0,0,0,0,0).mul(u)),o&&(0==this.imageSubcarrier||this.display.videoWhiteOnly)&&(u=new r(1,0,0,0,0,0,0,0,0).mul(u)),u=new r(1,0,0,0,this.display.videoSaturation,0,0,0,this.display.videoSaturation).mul(u);let p=2*Math.PI*this.display.videoHue;switch(u=new r(1,0,0,0,Math.cos(p),-Math.sin(p),0,Math.sin(p),Math.cos(p)).mul(u),this.display.videoDecoder){case"CANVAS_RGB":case"CANVAS_MONOCHROME":u=new r(1,1,1,0,-.344136,1.772,1.402,-.714136,0).mul(u);break;case"CANVAS_YUV":case"CANVAS_YIQ":u=new r(1,1,1,0,-.394642,2.032062,1.139883,-.580622,0).mul(u);break;case"CANVAS_CXA2025AS":u=new r(1,0,0,0,0,1,0,1,0).mul(u),p=33*-Math.PI/180,u=new r(1,0,0,0,Math.cos(p),-Math.sin(p),0,Math.sin(p),Math.cos(p)).mul(u),u=new r(1,1,1,1.63,-.378,-1.089,.317,-.466,1.677).mul(u);break;default:throw new Error(`unknown videoDecoder: ${this.display.videoDecoder}`)}const g=this.display.videoBrightness-this.imageBlackLevel;let f;f=o?u.mul(new r(g,0,0,0,0,0,0,0,0)):u.mul(new r(g,0,0,g,0,0,g,0,0)),e.uniform3f(e.getUniformLocation(t,"decoderOffset"),f.at(0,0),f.at(0,1),f.at(0,2));let A=this.display.videoContrast;const b=this.imageWhiteLevel-this.imageBlackLevel;b>0?A/=b:A=0,A<0&&(A=0),u=u.mul(A),e.uniformMatrix3fv(e.getUniformLocation(t,"decoderMatrix"),!1,u.data),e.useProgram(a),e.uniform1f(e.getUniformLocation(a,"barrel"),this.display.displayBarrel),e.uniform1i(e.getUniformLocation(a,"shadowMask"),1),e.uniform1f(e.getUniformLocation(a,"shadowMaskLevel"),this.display.displayShadowMaskLevel),e.uniform1f(e.getUniformLocation(a,"persistenceLevel"),this.display.displayPersistence/(1/60+this.display.displayPersistence)),0==this.display.displayPersistence&&this.resizeTexture("IMAGE_PERSISTENCE",0,0);let _=this.display.displayCenterLighting;Math.abs(_)<.001&&(_=.001),e.uniform1f(e.getUniformLocation(a,"centerLighting"),1/_-1),e.uniform1f(e.getUniformLocation(a,"luminanceGain"),this.display.displayLuminanceGain)}renderImage(){const e=this.gl,[t,i]=this.getRenderShader(),r="COMPOSITE"==i;e.useProgram(t);const a=this.textures.IMAGE_IN.size;this.resizeTexture("IMAGE_DECODED",a.width,a.height),e.uniform1i(e.getUniformLocation(t,"texture"),0),e.uniform2f(e.getUniformLocation(t,"textureSize"),a.width,a.height),r&&(e.uniform1i(e.getUniformLocation(t,"phaseInfo"),1),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.textures.IMAGE_PHASEINFO.glTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.activeTexture(e.TEXTURE0));const o=this.image.size;for(let i=0;i<this.image.height;i+=this.viewportSize.height)for(let r=0;r<this.image.width;r+=this.viewportSize.width){const n=this.viewportSize.copy();r+n.width>o.width&&(n.width=o.width-r),i+n.height>o.height&&(n.height=o.height-i);const h=new s(r/a.width,i/a.height,n.width/a.width,n.height/a.height),d=new s(-1,-1,2*n.width/this.viewportSize.width,2*n.height/this.viewportSize.height);e.bindTexture(e.TEXTURE_2D,this.textures.IMAGE_IN.glTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),this.drawRectangle(t,d,h),e.bindTexture(e.TEXTURE_2D,this.textures.IMAGE_DECODED.glTexture),e.copyTexSubImage2D(e.TEXTURE_2D,0,r,i,0,0,n.width,n.height)}}drawRectangle(e,t,s,i){const r=this.gl;r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);const a=r.getAttribLocation(e,"a_position"),o=[r.getAttribLocation(e,"a_texCoord")],n=[s];i&&(o.push(r.getAttribLocation(e,"a_texCoord2")),n.push(i));const h=this.buffers[0];r.bindBuffer(r.ARRAY_BUFFER,h);const d=t.l,c=t.r,l=t.t,m=t.b;r.bufferData(r.ARRAY_BUFFER,new Float32Array([d,l,c,l,d,m,d,m,c,l,c,m]),r.STATIC_DRAW),r.enableVertexAttribArray(a),r.bindBuffer(r.ARRAY_BUFFER,h),r.vertexAttribPointer(a,2,r.FLOAT,!1,0,0);for(let e=0;e<n.length;e++){const t=this.buffers[e+1];r.bindBuffer(r.ARRAY_BUFFER,t);const s=n[e].l,i=n[e].r,a=n[e].t,h=n[e].b;r.bufferData(r.ARRAY_BUFFER,new Float32Array([s,a,i,a,s,h,s,h,i,a,i,h]),r.STATIC_DRAW),r.enableVertexAttribArray(o[e]),r.bindBuffer(r.ARRAY_BUFFER,t),r.vertexAttribPointer(o[e],2,r.FLOAT,!1,0,0)}r.drawArrays(r.TRIANGLES,0,6)}drawDisplayCanvas(){const i=this.gl,r=this.shaders.DISPLAY;if(0==this.image.width||0==this.image.height)return void this.resizeTexture("IMAGE_PERSISTENCE",0,0);const a=this.display.displayResolution,o=new s(-1,-1,2,2),n=this.viewportSize.ratio,h=a.ratio,d=n/h;d>1?(o.origin.x/=d,o.size.width/=d):(o.origin.y*=d,o.size.height*=d);const c=new s(0,0,1,1),l=this.image.interlace/this.image.height,m=this.getDisplayCanvasTexPoint(new e(-1,2*l-1)),u=this.getDisplayCanvasTexPoint(new e(1,1+2*l)),p=new s(m.x,m.y,u.x-m.x,u.y-m.y),g=new t(.5*this.viewportSize.width*o.size.width,.5*this.viewportSize.height*o.size.height),f=new t(g.width*this.display.videoSize.width,g.height*this.display.videoSize.height);let A;const b=this.textures.IMAGE_DECODED;i.useProgram(r);const _=b.size;i.uniform1i(i.getUniformLocation(r,"texture"),0),i.uniform2f(i.getUniformLocation(r,"textureSize"),_.width,_.height),A=new s(-.5,-.5/h,1,1/h),i.uniform2f(i.getUniformLocation(r,"barrelSize"),1,1/h);const w=f.height/this.image.height;let y,S,R=this.display.displayScanlineLevel;switch(R=w>2.5?R:w<2?0:(w-2)/.5*R,i.uniform1f(i.getUniformLocation(r,"scanlineLevel"),R),this.display.displayShadowMask){case"SHADOWMASK_TRIAD":y=this.textures.SHADOWMASK_TRIAD,S=2/(274/240);break;case"SHADOWMASK_INLINE":y=this.textures.SHADOWMASK_INLINE,S=2;break;case"SHADOWMASK_APERTURE":y=this.textures.SHADOWMASK_APERTURE,S=2;break;case"SHADOWMASK_LCD":y=this.textures.SHADOWMASK_LCD,S=2;break;case"SHADOWMASK_BAYER":y=this.textures.SHADOWMASK_BAYER,S=2}let E=this.display.displayShadowMaskDotPitch;E<=.001&&(E=.001);const v=a.width/this.display.displayPixelDensity*25.4*.5/E,T=new t(v,v*S/h);i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,y.glTexture),i.uniform2f(i.getUniformLocation(r,"shadowMaskSize"),T.width,T.height),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,this.textures.IMAGE_PERSISTENCE.glTexture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.activeTexture(i.TEXTURE0),i.uniform1i(i.getUniformLocation(r,"persistence"),2),i.uniform2f(i.getUniformLocation(r,"persistenceOrigin"),this.persistenceTexRect.x,this.persistenceTexRect.y),i.uniform2f(i.getUniformLocation(r,"persistenceSize"),this.persistenceTexRect.width,this.persistenceTexRect.height),i.bindTexture(i.TEXTURE_2D,b.glTexture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),this.drawRectangle(r,o,p,c)}getDisplayCanvasTexPoint(t){const s=this.display.videoCenter,i=this.display.videoSize;t=new e((t.x-2*s.x)/i.width,(t.y-2*s.y)/i.height);const r=this.image.size,a=this.textures.IMAGE_IN.size;return t.x=.5*(t.x+1)*r.width/a.width,t.y=.5*(t.y+1)*r.height/a.height,t}resizeTexture(e,t,s,i=!1){const r=this.gl,a=this.textures[e];if(!a)throw new Error(`Cannot find texture named ${e}`);if(t<4&&(t=4),s<4&&(s=4),t=2**Math.ceil(Math.log2(t)),s=2**Math.ceil(Math.log2(s)),a.width!=t||a.height!=s){a.width=t,a.height=s,r.bindTexture(r.TEXTURE_2D,a.glTexture);const e=new Uint8Array(t*s*(i?1:4)),o=i?r.LUMINANCE:r.RGBA;r.texImage2D(r.TEXTURE_2D,0,o,t,s,0,o,r.UNSIGNED_BYTE,e)}}},DisplayConfiguration:class{constructor(){this.videoDecoder="CANVAS_YUV",this.videoBrightness=0,this.videoContrast=1,this.videoSaturation=1,this.videoHue=0,this.videoCenter=new e(0,0),this.videoSize=new t(1.05,1.05),this.videoBandwidth=6e6,this.videoLumaBandwidth=2e6,this.videoChromaBandwidth=6e5,this.videoWhiteOnly=!1,this.displayResolution=new t(640,480),this.displayPixelDensity=72,this.displayBarrel=.05,this.displayScanlineLevel=.05,this.displayShadowMaskLevel=.05,this.displayShadowMaskDotPitch=.5,this.displayShadowMask="SHADOWMASK_TRIAD",this.displayPersistence=0,this.displayCenterLighting=1,this.displayLuminanceGain=1}},ImageInfo:class{constructor(e){if("object"!=typeof e)throw new Error(`want typeof data == 'object'; got '${typeof e}'`);if(!(e instanceof ImageData))throw new Error(`want data instanceof ImageData; got '${e.constructor.name}'`);this.sampleRate=o,this.blackLevel=0,this.whiteLevel=1,this.interlace=0,this.subCarrier=a,this.colorBurst=p.colorBurst,this.phaseAlternation=[!1],this.data=e}get width(){return this.data.width}get height(){return this.data.height}get size(){return new t(this.data.width,this.data.height)}},Vector:i,Size:t,Point:e}}();e.exports={screenEmu:t}}},i={};function r(e){var t=i[e];if(void 0!==t)return t.exports;var a=i[e]={exports:{}};return s[e](a,a.exports,r),a.exports}r.m=s,r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,s)=>(r.f[s](e,t),t)),[])),r.u=e=>e+".bundle.js",r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="Apple2:",r.l=(s,i,a,o)=>{if(e[s])e[s].push(i);else{var n,h;if(void 0!==a)for(var d=document.getElementsByTagName("script"),c=0;c<d.length;c++){var l=d[c];if(l.getAttribute("src")==s||l.getAttribute("data-webpack")==t+a){n=l;break}}n||(h=!0,(n=document.createElement("script")).charset="utf-8",n.timeout=120,r.nc&&n.setAttribute("nonce",r.nc),n.setAttribute("data-webpack",t+a),n.src=s),e[s]=[i];var m=(t,i)=>{n.onerror=n.onload=null,clearTimeout(u);var r=e[s];if(delete e[s],n.parentNode&&n.parentNode.removeChild(n),r&&r.forEach((e=>e(i))),t)return t(i)},u=setTimeout(m.bind(null,void 0,{type:"timeout",target:n}),12e4);n.onerror=m.bind(null,n.onerror),n.onload=m.bind(null,n.onload),h&&document.head.appendChild(n)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="dist/",(()=>{var e={804:0};r.f.j=(t,s)=>{var i=r.o(e,t)?e[t]:void 0;if(0!==i)if(i)s.push(i[2]);else{var a=new Promise(((s,r)=>i=e[t]=[s,r]));s.push(i[2]=a);var o=r.p+r.u(t),n=new Error;r.l(o,(s=>{if(r.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var a=s&&("load"===s.type?"missing":s.type),o=s&&s.target&&s.target.src;n.message="Loading chunk "+t+" failed.\n("+a+": "+o+")",n.name="ChunkLoadError",n.type=a,n.request=o,i[1](n)}}),"chunk-"+t,t)}};var t=(t,s)=>{var i,a,[o,n,h]=s,d=0;for(i in n)r.o(n,i)&&(r.m[i]=n[i]);for(h&&h(r),t&&t(s);d<o.length;d++)a=o[d],r.o(e,a)&&e[a]&&e[a][0](),e[o[d]]=0},s=self.webpackChunkApple2=self.webpackChunkApple2||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var a={};return(()=>{"use strict";r.d(a,{Apple2:()=>ri});var e={};r.r(e),r.d(e,{clearPrinterPaper:()=>yt,clickDisk:()=>ut,compileAppleSoftProgram:()=>Ge,doDelete:()=>tt,doLoad:()=>$e,doLoadHTTP:()=>rt,doSave:()=>et,driveLights:()=>Xe,dumpAppleSoftProgram:()=>He,handleDragEnd:()=>qe,handleDragOver:()=>Ke,handleDrop:()=>je,initUI:()=>Rt,loadAjax:()=>Qe,openAlert:()=>Ye,openLoad:()=>We,openOptions:()=>_t,openPrinterModal:()=>wt,openSave:()=>Ze,pauseRun:()=>bt,reset:()=>ct,selectCategory:()=>lt,selectDisk:()=>mt,toggleShowFPS:()=>nt,toggleSound:()=>ht,updateKHz:()=>ot,updateUI:()=>At});const t=void 0!==window.localStorage;class s{havePrefs(){return t}readPref(e,s=null){var i;return t&&null!==(i=window.localStorage.getItem(e))&&void 0!==i?i:s}writePref(e,s){t&&window.localStorage.setItem(e,s)}}function i(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e){return function(e){if(Array.isArray(e))return n(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return n(e,t);var s=Object.prototype.toString.call(e).slice(8,-1);return"Object"===s&&e.constructor&&(s=e.constructor.name),"Map"===s||"Set"===s?Array.from(s):"Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s)?n(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var s=0,i=new Array(t);s<t;s++)i[s]=e[s];return i}var h,d,c,l,m,u=(h=["a[href]","area[href]",'input:not([disabled]):not([type="hidden"]):not([aria-hidden])',"select:not([disabled]):not([aria-hidden])","textarea:not([disabled]):not([aria-hidden])","button:not([disabled]):not([aria-hidden])","iframe","object","embed","[contenteditable]",'[tabindex]:not([tabindex^="-"])'],d=function(){function e(t){var s=t.targetModal,i=t.triggers,r=void 0===i?[]:i,a=t.onShow,n=void 0===a?function(){}:a,h=t.onClose,d=void 0===h?function(){}:h,c=t.openTrigger,l=void 0===c?"data-micromodal-trigger":c,m=t.closeTrigger,u=void 0===m?"data-micromodal-close":m,p=t.openClass,g=void 0===p?"is-open":p,f=t.disableScroll,A=void 0!==f&&f,b=t.disableFocus,_=void 0!==b&&b,w=t.awaitCloseAnimation,y=void 0!==w&&w,S=t.awaitOpenAnimation,R=void 0!==S&&S,E=t.debugMode,v=void 0!==E&&E;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.modal=document.getElementById(s),this.config={debugMode:v,disableScroll:A,openTrigger:l,closeTrigger:u,openClass:g,onShow:n,onClose:d,awaitCloseAnimation:y,awaitOpenAnimation:R,disableFocus:_},r.length>0&&this.registerTriggers.apply(this,o(r)),this.onClick=this.onClick.bind(this),this.onKeydown=this.onKeydown.bind(this)}var t,s;return t=e,(s=[{key:"registerTriggers",value:function(){for(var e=this,t=arguments.length,s=new Array(t),i=0;i<t;i++)s[i]=arguments[i];s.filter(Boolean).forEach((function(t){t.addEventListener("click",(function(t){return e.showModal(t)}))}))}},{key:"showModal",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(this.activeElement=document.activeElement,this.modal.setAttribute("aria-hidden","false"),this.modal.classList.add(this.config.openClass),this.scrollBehaviour("disable"),this.addEventListeners(),this.config.awaitOpenAnimation){var s=function t(){e.modal.removeEventListener("animationend",t,!1),e.setFocusToFirstNode()};this.modal.addEventListener("animationend",s,!1)}else this.setFocusToFirstNode();this.config.onShow(this.modal,this.activeElement,t)}},{key:"closeModal",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=this.modal;if(this.modal.setAttribute("aria-hidden","true"),this.removeEventListeners(),this.scrollBehaviour("enable"),this.activeElement&&this.activeElement.focus&&this.activeElement.focus(),this.config.onClose(this.modal,this.activeElement,e),this.config.awaitCloseAnimation){var s=this.config.openClass;this.modal.addEventListener("animationend",(function e(){t.classList.remove(s),t.removeEventListener("animationend",e,!1)}),!1)}else t.classList.remove(this.config.openClass)}},{key:"closeModalById",value:function(e){this.modal=document.getElementById(e),this.modal&&this.closeModal()}},{key:"scrollBehaviour",value:function(e){if(this.config.disableScroll){var t=document.querySelector("body");switch(e){case"enable":Object.assign(t.style,{overflow:""});break;case"disable":Object.assign(t.style,{overflow:"hidden"})}}}},{key:"addEventListeners",value:function(){this.modal.addEventListener("touchstart",this.onClick),this.modal.addEventListener("click",this.onClick),document.addEventListener("keydown",this.onKeydown)}},{key:"removeEventListeners",value:function(){this.modal.removeEventListener("touchstart",this.onClick),this.modal.removeEventListener("click",this.onClick),document.removeEventListener("keydown",this.onKeydown)}},{key:"onClick",value:function(e){e.target.hasAttribute(this.config.closeTrigger)&&this.closeModal(e)}},{key:"onKeydown",value:function(e){27===e.keyCode&&this.closeModal(e),9===e.keyCode&&this.retainFocus(e)}},{key:"getFocusableNodes",value:function(){var e=this.modal.querySelectorAll(h);return Array.apply(void 0,o(e))}},{key:"setFocusToFirstNode",value:function(){var e=this;if(!this.config.disableFocus){var t=this.getFocusableNodes();if(0!==t.length){var s=t.filter((function(t){return!t.hasAttribute(e.config.closeTrigger)}));s.length>0&&s[0].focus(),0===s.length&&t[0].focus()}}}},{key:"retainFocus",value:function(e){var t=this.getFocusableNodes();if(0!==t.length)if(t=t.filter((function(e){return null!==e.offsetParent})),this.modal.contains(document.activeElement)){var s=t.indexOf(document.activeElement);e.shiftKey&&0===s&&(t[t.length-1].focus(),e.preventDefault()),!e.shiftKey&&t.length>0&&s===t.length-1&&(t[0].focus(),e.preventDefault())}else t[0].focus()}}])&&i(t.prototype,s),e}(),c=null,l=function(e){if(!document.getElementById(e))return console.warn("MicroModal: ❗Seems like you have missed %c'".concat(e,"'"),"background-color: #f8f9fa;color: #50596c;font-weight: bold;","ID somewhere in your code. Refer example below to resolve it."),console.warn("%cExample:","background-color: #f8f9fa;color: #50596c;font-weight: bold;",'<div class="modal" id="'.concat(e,'"></div>')),!1},m=function(e,t){if(function(e){e.length<=0&&(console.warn("MicroModal: ❗Please specify at least one %c'micromodal-trigger'","background-color: #f8f9fa;color: #50596c;font-weight: bold;","data attribute."),console.warn("%cExample:","background-color: #f8f9fa;color: #50596c;font-weight: bold;",'<a href="#" data-micromodal-trigger="my-modal"></a>'))}(e),!t)return!0;for(var s in t)l(s);return!0},{init:function(e){var t=Object.assign({},{openTrigger:"data-micromodal-trigger"},e),s=o(document.querySelectorAll("[".concat(t.openTrigger,"]"))),i=function(e,t){var s=[];return e.forEach((function(e){var i=e.attributes[t].value;void 0===s[i]&&(s[i]=[]),s[i].push(e)})),s}(s,t.openTrigger);if(!0!==t.debugMode||!1!==m(s,i))for(var r in i){var a=i[r];t.targetModal=r,t.triggers=o(a),c=new d(t)}},show:function(e,t){var s=t||{};s.targetModal=e,!0===s.debugMode&&!1===l(e)||(c&&c.removeEventListeners(),(c=new d(s)).showModal())},close:function(e){e?c.closeModalById(e):c.closeModal()}});window.MicroModal=u;const p=u,g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function f(e){let t,s,i,r,a,o,n,h,d=0,c=0,l="";const m=[];if(e){do{t=e[d++],s=e[d++],i=e[d++],h=t<<16|s<<8|i,r=h>>18&63,a=h>>12&63,o=h>>6&63,n=63&h,m[c++]=g.charAt(r)+g.charAt(a)+g.charAt(o)+g.charAt(n)}while(d<e.length);switch(l=m.join(""),e.length%3){case 1:l=l.slice(0,-2)+"==";break;case 2:l=l.slice(0,-1)+"="}return l}}function A(e){let t,s,i,r,a,o,n,h,d=0,c=0;const l=[];if(e){do{r=g.indexOf(e.charAt(d++)),a=g.indexOf(e.charAt(d++)),o=g.indexOf(e.charAt(d++)),n=g.indexOf(e.charAt(d++)),h=r<<18|a<<12|o<<6|n,t=h>>16&255,s=h>>8&255,i=255&h,l[c++]=t,64!=o&&(l[c++]=s),64!=n&&(l[c++]=i)}while(d<e.length);return new Uint8Array(l)}}const b="data:application/octet-stream;base64,",_="BOOLEAN_OPTION",w="SELECT_OPTION";function y(){return 256*Math.random()&255}function S(e){const t=new Uint8Array(e);for(let s=0;s<e;s++)t[s]=2&s?0:255;for(let s=0;s<e;s+=512)t[s+40]=y(),t[s+41]=y(),t[s+104]=y(),t[s+105]=y();return t}function R(e){return S(e<<8)}function E(e){return new Uint8Array(e)}function v(...e){console.log.apply(console,e)}function T(e,t){t||(t=e<256?2:4);let s="";for(let i=0;i<t;i++)s="0123456789ABCDEF"[15&e]+s,e>>=4;return s}function P(e){let t="";for(let s=0;s<4;s++)t+=String.fromCharCode(255&e),e>>=8;return t}const C="enable_sound",k=window.AudioContext||window.webkitAudioContext;class O{constructor(e){this.sound=!0,this.samples=[],this.started=!1,this.autoStart=()=>{this.audioContext&&!this.started&&(this.samples=[],this.audioContext.resume().then((()=>{this.started=!0})).catch((e=>{console.warn("audio not started",e)})))},this.start=()=>{this.audioContext&&(this.samples=[],this.audioContext.resume().catch((e=>{console.warn("audio not resumed",e)})))},this.isEnabled=()=>this.sound,this.setOption=(e,t)=>{switch(e){case C:this.sound=t}},this.audioContext=new k({sampleRate:44e3}),window.AudioWorklet?(this.ready=this.audioContext.audioWorklet.addModule("./dist/audio_worker.bundle.js"),this.ready.then((()=>{this.workletNode=new AudioWorkletNode(this.audioContext,"audio_worker"),e.sampleRate(this.audioContext.sampleRate,128),e.addSampleListener((e=>{this.sound&&"running"===this.audioContext.state&&this.workletNode.port.postMessage(e)})),this.workletNode.connect(this.audioContext.destination)})).catch(console.error)):(this.audioNode=this.audioContext.createScriptProcessor(1024,1,1),this.audioNode.onaudioprocess=e=>{const t=e.outputBuffer.getChannelData(0),s=this.samples.shift();let i=0,r=t.length;if(s)for(r=Math.min(s.length,r);i<r;i++)t[i]=s[i];for(;i<t.length;i++)t[i]=0},this.audioNode.connect(this.audioContext.destination),e.sampleRate(this.audioContext.sampleRate,1024),e.addSampleListener((e=>{this.sound&&"running"===this.audioContext.state&&this.samples.length<5&&this.samples.push(e)})),this.ready=Promise.resolve()),window.addEventListener("keydown",this.autoStart),void 0!==window.ontouchstart&&window.addEventListener("touchstart",this.autoStart),window.addEventListener("mousedown",this.autoStart),v("Sound initialized")}getOptions(){return[{name:"Audio",options:[{name:C,label:"Enabled",type:_,defaultVal:!0}]}]}}function M(e,t){return e.includes(t)}const I=[1,2],F="nibble",D="bitstream",L="block",B=["2mg","d13","do","dsk","po","nib","woz"],x=["2mg","hdv","po"],N=[...B,...x],U={A:0,B:1,X:2,Y:3,L1:4,R1:5,L3:6,R3:7,START:8,SELECT:9,LOGO:10,UP:11,DOWN:12,LEFT:13,RIGHT:14};let z=null;const X={A:0,B:1,L1:0,R1:1,START:""},H=[],G=[];function W(e){for(let e=0;e<16;e++)H[e]=void 0;const t=e||X;for(const e of Object.entries(t)){const t=e[0],s=e[1];let i;i="string"==typeof s?s.charCodeAt(0):-s,t in U?H[U[t]]=i:H[parseInt(t,10)]=i}}window.addEventListener("gamepadconnected",(function(e){z=e.gamepad}));const Z={0:[0,0,0],1:[1,1,1],2:[2,2,2],3:[3,3,3],4:[4,4,4],5:[5,5,5],6:[6,6,6],7:[7,7,7],8:[127,127,127],9:[9,9,9],10:[10,10,10],11:[11,11,11],12:[12,12,12],13:[13,13,13],14:[14,14,14],15:[15,15,15],16:[255,255,255],17:[255,255,255],18:[255,255,255],19:[19,19,19],20:[20,20,20],21:[21,21,21],22:[22,22,22],23:[23,23,24],24:[24,24,24],25:[25,25,25],26:[26,26,26],27:[27,27,27],28:[28,28,28],29:[29,29,29],30:[30,30,30],31:[31,31,31],32:[32,32,32],33:[33,33,33],34:[34,34,34],35:[35,35,35],36:[36,36,36],37:[8,8,8],38:[11,11,11],39:[21,21,21],40:[10,10,10],41:[41,41,41],42:[42,42,42],43:[43,43,43],44:[44,44,60],45:[45,45,95],46:[46,46,62],47:[47,47,63],48:[48,48,41],49:[49,49,33],50:[50,0,64],51:[51,51,35],52:[52,52,36],53:[53,53,37],54:[54,54,94],55:[55,55,38],56:[56,56,42],57:[57,57,40],58:[58,58,58],59:[59,59,58],60:[60,60,60],61:[61,61,43],62:[62,62,62],63:[63,63,63],64:[64,0,64],65:[97,1,65],66:[98,2,66],67:[99,3,67],68:[100,4,68],69:[101,5,69],70:[102,6,70],71:[103,7,71],72:[104,8,72],73:[105,9,73],74:[106,10,74],75:[107,11,75],76:[108,12,76],77:[109,13,77],78:[110,14,78],79:[111,15,79],80:[112,16,80],81:[113,17,81],82:[114,18,82],83:[115,19,83],84:[116,20,84],85:[117,21,85],86:[118,22,86],87:[119,23,87],88:[120,24,88],89:[121,25,89],90:[122,26,90],91:[255,255,255],92:[255,255,255],93:[255,255,255],94:[94,30,94],95:[95,31,95],96:[48,48,48],97:[49,49,49],98:[50,50,50],99:[51,51,51],100:[52,52,52],101:[53,53,53],102:[54,54,54],103:[55,55,55],104:[56,56,56],105:[57,57,57],106:[42,42,42],107:[43,43,43],109:[45,45,45],110:[46,46,46],111:[47,47,57],173:[45,45,95],186:[59,59,58],187:[61,61,43],188:[44,44,60],189:[45,45,95],190:[46,46,62],191:[47,47,63],192:[96,96,126],219:[91,27,123],220:[92,28,124],221:[93,29,125],222:[39,34,34],255:[255,255,255]},Y={Dead:255,UIKeyInputLeftArrow:8,UIKeyInputRightArrow:21,UIKeyInputUpArrow:11,UIKeyInputDownArrow:10,UIKeyInputEscape:27},K=[[["1","2","3","4","5","6","7","8","9","0",":","-","RESET"],["ESC","Q","W","E","R","T","Y","U","I","O","P","REPT","RETURN"],["CTRL","A","S","D","F","G","H","J","K","L",";","&larr;","&rarr;"],["SHIFT","Z","X","C","V","B","N","M",",",".","/","SHIFT"],["POWER","&nbsp;"]],[["!",'"',"#","$","%","&","'","(",")","0","*","=","RESET"],["ESC","Q","W","E","R","T","Y","U","I","O","@","REPT","RETURN"],["CTRL","A","S","D","F","BELL","H","J","K","L","+","&larr;","&rarr;"],["SHIFT","Z","X","C","V","B","^","]","<",">","?","SHIFT"],["POWER","&nbsp;"]]],q=[[["ESC","1","2","3","4","5","6","7","8","9","0","-","=","DELETE"],["TAB","Q","W","E","R","T","Y","U","I","O","P","[","]","\\"],["CTRL","A","S","D","F","G","H","J","K","L",";",'"',"RETURN"],["SHIFT","Z","X","C","V","B","N","M",",",".","/","SHIFT"],["LOCK","`","POW","OPEN_APPLE","&nbsp;","CLOSED_APPLE","&larr;","&rarr;","&darr;","&uarr;"]],[["ESC","!","@","#","$","%","^","&","*","(",")","_","+","DELETE"],["TAB","Q","W","E","R","T","Y","U","I","O","P","{","}","|"],["CTRL","A","S","D","F","G","H","J","K","L",":","'","RETURN"],["SHIFT","Z","X","C","V","B","N","M","<",">","?","SHIFT"],["CAPS","~","POW","OPEN_APPLE","&nbsp;","CLOSED_APPLE","&larr;","&rarr;","&darr;","&uarr;"]]];class j{constructor(e,t,s){this.cpu=e,this.io=t,this.e=s,this.shifted=!1,this.controlled=!1,this.capslocked=!0,this.capslockKeyUsed=!1,this.optioned=!1,this.commanded=!1,this.functions={},this.keydown=e=>{if(!this.dialogOpen()&&(!e.metaKey||e.ctrlKey||this.e)){e.preventDefault();const t=this.mapKeyEvent(e);if(255!==t)return void this.io.keyDown(t)}"Shift"===e.key?this.shiftKey(!0):"CapsLock"===e.key?this.capslockKey():"Control"===e.key?this.controlKey(!0):"Meta"===e.key?this.commandKey(!0):"Alt"===e.key?1===e.location?this.commandKey(!0):this.optionKey(!0):e.key in this.functions&&(this.functions[e.key](e),e.preventDefault())},this.keyup=e=>{this.dialogOpen()||this.io.keyUp(),"Shift"===e.key?this.shiftKey(!1):"Control"===e.key?this.controlKey(!1):"Meta"===e.key?this.commandKey(!1):"Alt"===e.key&&(1===e.location?this.commandKey(!1):this.optionKey(!1))},this.keys=s?q:K,window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup)}setFunction(e,t){this.functions[e]=t}mapKeyEvent(e){const t=e.keyCode;let s=255;return e.key in Y?s=Y[e.key]:function(e){return e in Z}(t)?(s=Z[t][e.shiftKey?2:e.ctrlKey?1:0],20!=t&&this.capslockKeyUsed&&this.capslockKey(e.getModifierState("CapsLock")),this.capslocked&&s>=97&&s<=122&&(s-=32)):v("Unhandled key = "+T(t)),127==s&&e.shiftKey&&e.ctrlKey&&(this.cpu.reset(),s=255),s}shiftKey(e){const t=this.kb.querySelectorAll(".key-SHIFT");this.shifted=e,e?(this.io.buttonUp(2),t.forEach((e=>{e.classList.add("active")}))):(this.io.buttonDown(2),t.forEach((e=>{e.classList.remove("active")})))}controlKey(e){const t=this.kb.querySelector(".key-CTRL");this.controlled=e,e?t.classList.add("active"):t.classList.remove("active")}commandKey(e){const t=this.kb.querySelector(".key-OPEN_APPLE");t&&(this.commanded=e,e?(this.io.buttonDown(0),t.classList.add("active")):(this.io.buttonUp(0),t.classList.remove("active")))}optionKey(e){const t=this.kb.querySelector(".key-CLOSED_APPLE");t&&(this.optioned=e,e?(this.io.buttonDown(1),t.classList.add("active")):(this.io.buttonUp(1),t.classList.remove("active")))}capslockKey(e){const t=this.kb.querySelector(".key-LOCK");0==arguments.length?this.capslockKeyUsed?this.capslocked=!this.capslocked:this.capslockKeyUsed=!0:void 0===e?(this.capslocked=!this.capslocked,this.capslockKeyUsed=!1):this.capslocked=e,this.capslocked?t.classList.add("active"):t.classList.remove("active")}reset(e){e.preventDefault(),e.stopPropagation(),this.cpu.reset()}create(e){let t,s,i,r,a,o,n;this.kb=document.querySelector(e);const h=e=>{const t=document.createElement("span");return t.innerHTML=e,e.length>1&&"&"!=e.substr(0,1)&&t.classList.add("small"),t};for(s=0;s<5;s++)for(i=document.createElement("div"),i.classList.add("row"),i.classList.add("row"+s),this.kb.append(i),t=0;t<this.keys[0][s].length;t++){const e=this.keys[0][s][t],d=this.keys[1][s][t];a=document.createElement("div"),o=h(e),n=h(d),r=document.createElement("div"),r.classList.add("key"),r.classList.add("key-"+e.replace(/[&#;]/g,"")),e.length>1&&("LOCK"==e?r.classList.add("v-center2"):r.classList.add("v-center")),e!=d&&(r.classList.add("key-"+d.replace(/[&;]/g,"")),a.append(n),a.append(document.createElement("br"))),"LOCK"==e&&r.classList.add("active"),a.append(o),r.append(a),r.dataset.key1=e,r.dataset.key2=d;const c=this.genMouseDown(r,e,d),l=this.genMouseUp(r);void 0===window.ontouchstart?(r.addEventListener("mousedown",c),r.addEventListener("mouseup",l),r.addEventListener("mouseleave",l)):(r.addEventListener("touchstart",c),r.addEventListener("touchend",l),r.addEventListener("touchleave",l)),i.append(r)}}genMouseDown(e,t,s){return i=>{i.preventDefault(),e.classList.add("pressed");let r=this.shifted?s:t;switch(r){case"BELL":r="G";break;case"RETURN":r="\r";break;case"TAB":r="\t";break;case"DELETE":r="";break;case"&larr;":r="\b";break;case"&rarr;":r="";break;case"&darr;":r="\n";break;case"&uarr;":r="\v";break;case"&nbsp;":r=" ";break;case"ESC":r=""}if(r.length>1)switch(r){case"SHIFT":this.shiftKey(!this.shifted);break;case"CTRL":this.controlKey(!this.controlled);break;case"CAPS":case"LOCK":this.capslockKey(void 0);break;case"POW":case"POWER":window.confirm("Power Cycle?")&&window.location.reload();break;case"RESET":this.cpu.reset();break;case"OPEN_APPLE":this.commandKey(!this.commanded);break;case"CLOSED_APPLE":this.optionKey(!this.optioned)}else this.controlled&&r>="@"&&r<="_"?this.io.keyDown(r.charCodeAt(0)-64):this.e&&!this.shifted&&!this.capslocked&&r>="A"&&r<="Z"?this.io.keyDown(r.charCodeAt(0)+32):this.io.keyDown(r.charCodeAt(0))}}dialogOpen(){return!!document.querySelector(".modal.is-open")}genMouseUp(e){return()=>e.classList.remove("pressed")}}const V=["wav","aiff","aif","mp3","m4a"];class J{constructor(e){this.io=e}doLoadLocalTape(e,t){const s=this.io.getKHz();let i;if(!AudioContext)return window.alert("Not supported by your browser"),void(t&&t());i=new AudioContext;const r=new FileReader;r.onload=e=>{const r=e.target.result;i.decodeAudioData(r).then((e=>{const i=[],r=e.getChannelData(0);let a,o,n=r[0],h=n>0,d=0;v("Sample Count: "+r.length),v("Sample rate: "+e.sampleRate);for(let t=1;t<r.length;t++)if(n=r[t],(n>.1||n<-.1)&&(a=n>0,a!=h)){o=t-d,o>2e6&&(o=2e6);let r=o/e.sampleRate*1e3;r>=.55&&r<.75?r=.65:r>=.175&&r<.225?r=.2:r>=.225&&r<.275?r=.25:r>=.45&&r<.55&&(r=.5),i.push([r*s,a]),h=a,d=t}this.io.setTape(i),t&&t()}),(function(e){window.alert(e.message)}))},r.readAsArrayBuffer(e)}}const Q={128:"END",129:"FOR",130:"NEXT",131:"DATA",132:"INPUT",133:"DEL",134:"DIM",135:"READ",136:"GR",137:"TEXT",138:"PR#",139:"IN#",140:"CALL",141:"PLOT",142:"HLIN",143:"VLIN",144:"HGR2",145:"HGR",146:"HCOLOR=",147:"HPLOT",148:"DRAW",149:"XDRAW",150:"HTAB",151:"HOME",152:"ROT=",153:"SCALE=",154:"SHLOAD",155:"TRACE",156:"NOTRACE",157:"NORMAL",158:"INVERSE",159:"FLASH",160:"COLOR=",161:"POP=",162:"VTAB",163:"HIMEM:",164:"LOMEM:",165:"ONERR",166:"RESUME",167:"RECALL",168:"STORE",169:"SPEED=",170:"LET",171:"GOTO",172:"RUN",173:"IF",174:"RESTORE",175:"&",176:"GOSUB",177:"RETURN",178:"REM",179:"STOP",180:"ON",181:"WAIT",182:"LOAD",183:"SAVE",184:"DEF",185:"POKE",186:"PRINT",187:"CONT",188:"LIST",189:"CLEAR",190:"GET",191:"NEW",192:"TAB(",193:"TO",194:"FN",195:"SPC(",196:"THEN",197:"AT",198:"NOT",199:"STEP",200:"+",201:"-",202:"*",203:"/",204:"^",205:"AND",206:"OR",207:">",208:"=",209:"<",210:"SGN",211:"INT",212:"ABS",213:"USR",214:"FRE",215:"SCRN(",216:"PDL",217:"POS",218:"SQR",219:"RND",220:"LOG",221:"EXP",222:"COS",223:"SIN",224:"TAN",225:"ATN",226:"PEEK",227:"LEN",228:"STR$",229:"VAL",230:"ASC",231:"CHR$",232:"LEFT$",233:"RIGHT$",234:"MID$"};class ${constructor(e){this.mem=e}readByte(e){const t=e>>8,s=255&e;return this.mem.read(t,s)}readWord(e){const t=this.readByte(e);return this.readByte(e+1)<<8|t}toString(){let e="";const t=this.readWord(103),s=this.readWord(175);let i=t;do{let r="";const a=this.readWord(i);i+=2;const o=this.readWord(i);i+=2,r+=o,r+=" ";let n=0;do{if(i<t||i>s)return e;n=this.readByte(i++),n>=128?(r+=" ",r+=Q[n],r+=" "):r+="                                 !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~ "[n]}while(n);r+="\n",e+=r,i=a}while(i&&i>=t&&i<s);return e}}const ee={END:128,FOR:129,NEXT:130,DATA:131,INPUT:132,DEL:133,DIM:134,READ:135,GR:136,TEXT:137,"PR#":138,"IN#":139,CALL:140,PLOT:141,HLIN:142,VLIN:143,HGR2:144,HGR:145,"HCOLOR=":146,HPLOT:147,DRAW:148,XDRAW:149,HTAB:150,HOME:151,"ROT=":152,"SCALE=":153,SHLOAD:154,TRACE:155,NOTRACE:156,NORMAL:157,INVERSE:158,FLASH:159,"COLOR=":160,"POP=":161,VTAB:162,"HIMEM:":163,"LOMEM:":164,ONERR:165,RESUME:166,RECALL:167,STORE:168,"SPEED=":169,LET:170,GOTO:171,RUN:172,IF:173,RESTORE:174,"&":175,GOSUB:176,RETURN:177,REM:178,STOP:179,ON:180,WAIT:181,LOAD:182,SAVE:183,DEF:184,POKE:185,PRINT:186,CONT:187,LIST:188,CLEAR:189,GET:190,NEW:191,"TAB(":192,TO:193,FN:194,"SPC(":195,THEN:196,AT:197,NOT:198,STEP:199,"+":200,"-":201,"*":202,"/":203,"^":204,AND:205,OR:206,">":207,"=":208,"<":209,SGN:210,INT:211,ABS:212,USR:213,FRE:214,"SCRN(":215,PDL:216,POS:217,SQR:218,RND:219,LOG:220,EXP:221,COS:222,SIN:223,TAN:224,ATN:225,PEEK:226,LEN:227,STR$:228,VAL:229,ASC:230,CHR$:231,LEFT$:232,RIGHT$:233,MID$:234},te=2049;class se{constructor(e){this.mem=e}writeByte(e,t){const s=e>>8,i=255&e;return this.mem.write(s,i,t)}writeWord(e,t){const s=255&t,i=t>>8;this.writeByte(e,s),this.writeByte(e+1,i)}compile(e){const t={};function s(e,s){if(!e)return[];let i=0;const r=[0,0,0,0];let a,o=0,n="";for(;e.length&&(a=e.charAt(o),/\d/.test(a));)n+=a,o++;for(;o<e.length;)switch(a=e.charAt(o).toUpperCase(),i){case 0:if(" "!==a)if('"'===a)r.push(a.charCodeAt(0)),i=1,o++;else{let t="",s=-1;for(const i in ee){if(i.charAt(0)==a){s=o+1;let a=1;for(;a<i.length;){if(" "!==e.charAt(s)){if(e.charAt(s).toUpperCase()!==i.charAt(a))break;a++}s++}if(a===i.length){if("AT"===i){const i=e.charAt(s+1).toUpperCase();"N"===i&&(t="ATN",s++),"O"===i&&(r.push(i.charCodeAt(0)),t="TO",s++)}t=i}}if(t)break}t?(r.push(ee[t]),o=s,"REM"===t&&(i=2)):(r.push(a.charCodeAt(0)),o++)}else o++;break;case 2:r.push(a.charCodeAt(0)),o++;break;case 1:r.push(a.charCodeAt(0)),'"'==a&&(i=0),o++}if(!n.length)throw new Error("Missing line number");{const e=parseInt(n,10);if(e<0||e>65535)throw new Error("Line number out of range");if(t[n])throw new Error("Duplicate line number");t[n]=r,r.push(0);const i=s+r.length;r[0]=255&i,r[1]=i>>8,r[2]=255&e,r[3]=e>>8}return r}let i=[];const r=e.split(/[\r\n]+/g);for(;r.length;){const e=s(r.shift(),te+i.length);i=i.concat(e)}i.push(0,0);for(let e=0;e<i.length;e++)this.writeByte(te+e,i[e]);this.writeWord(105,te+i.length),this.writeWord(107,te+i.length),this.writeWord(109,te+i.length)}}const ie="mono_screen",re="show_scanlines";class ae{constructor(e){this.vm=e,this.enterFullScreen=e=>{const t=document.getElementById("screen");if(e.shiftKey)document.body.classList.toggle("full-page");else if(document.webkitCancelFullScreen)if(document.webkitIsFullScreen)document.webkitCancelFullScreen();else{const e=Element.ALLOW_KEYBOARD_INPUT;e?t.webkitRequestFullScreen(e):t.webkitRequestFullScreen()}else document.mozCancelFullScreen&&(document.mozIsFullScreen?document.mozCancelFullScreen():t.mozRequestFullScreen())}}getOptions(){return[{name:"Screen",options:[{name:ie,label:"Mono Screen",type:_,defaultVal:!1},{name:re,label:"Show Scanlines",type:_,defaultVal:!1},{name:"gl_canvas",label:"GL Renderer *",type:_,defaultVal:!0}]}]}setOption(e,t){switch(e){case ie:this.vm.mono(t);break;case re:this.vm.scanlines(t)}}}const oe="disable_mouse";class ne{constructor(e){this.io=e,this.disableMouseJoystick=!1,this.flipX=!1,this.flipY=!1,this.swapXY=!1,this.gamepad=!1,this.mousemove=e=>{if(this.gamepad||this.disableMouseJoystick)return;const t=document.querySelector("#screen"),s=t.getBoundingClientRect();let i=(e.pageX-s.left)/t.clientWidth,r=(e.pageY-s.top)/t.clientHeight;const a=i;this.swapXY&&(i=r,r=a),this.io.paddle(0,this.flipX?1-i:i),this.io.paddle(1,this.flipY?1-r:r)},document.addEventListener("mousemove",this.mousemove),document.querySelectorAll("canvas").forEach((t=>{t.addEventListener("mousedown",(t=>{this.gamepad||e.buttonDown(1==t.which?0:1),t.preventDefault()})),t.addEventListener("mouseup",(t=>{this.gamepad||e.buttonUp(1==t.which?0:1)})),t.addEventListener("contextmenu",(e=>{e.preventDefault()}))})),window.addEventListener("gamepadconnected",(e=>{this.gamepad=!!e.gamepad}))}getOptions(){return[{name:"Joystick",options:[{name:oe,label:"Disable Mouse Joystick",type:_,defaultVal:!1},{name:"flip_x",label:"Flip X-Axis",type:_,defaultVal:!1},{name:"flip_y",label:"Flip Y-Axis",type:_,defaultVal:!1},{name:"swap_x_y",label:"Swap Axis",type:_,defaultVal:!1}]}]}setOption(e,t){switch(e){case oe:this.io.paddle(0,.5),this.io.paddle(1,.5)}}}const he="accelerator_toggle";class de{constructor(e,t){this.io=e,this.e=t}getOptions(){return[{name:"Type",options:this.e?[{name:"computer_type2e",label:" *",type:w,defaultVal:"apple2enh",values:[{value:"apple2enh",name:"Enhanced Apple //e"},{value:"apple2e",name:"Apple //e"},{value:"apple2rm",name:"Enhanced Apple //e (Reactive Micro)"},{value:"apple2ex",name:"Apple //e Extended Debugging"}]}]:[{name:"computer_type2",label:" *",type:w,defaultVal:"apple2plus",values:[{value:"apple2plus",name:"Apple ][+"},{value:"apple2",name:"Autostart Apple ]["},{value:"apple213",name:"13 Sector Apple ]["},{value:"original",name:"Apple ]["},{value:"apple2j",name:"Apple ][j+"},{value:"apple2lc",name:"Apple ][+ (lowercase font)"},{value:"apple2pig",name:"Apple ][+ (pig font)"}]}]},{name:"CPU",options:[{name:he,label:"Accelerated",type:_,defaultVal:!1}]}]}setOption(e,t){switch(e){case he:{const e=t?4092:1023;this.io.updateKHz(e)}}}}let ce=!1,le=Date.now(),me=0,ue=0,pe=0,ge=document.location.hash;const fe=new class{constructor(){this.prefs=new s,this.options={},this.handlers={},this.sections=[]}addOptions(e){const t=e.getOptions();for(const s of t){const{options:t}=s;for(const s of t){const{name:t}=s;this.handlers[t]=e,this.options[t]=s;const i=this.getOption(t);null!=i&&e.setOption(t,i)}this.sections.push(s)}}getOption(e){const t=this.options[e];if(t){const{name:e,defaultVal:s,type:i}=t,r=String(s),a=this.prefs.readPref(e,r);switch(i){case _:return"true"===a;default:return a}}}setOption(e,t){if(e in this.options){const s=this.handlers[e],i=this.options[e];switch(this.prefs.writePref(e,String(t)),i.type){case _:s.setOption(e,Boolean(t));break;default:s.setOption(e,String(t))}}}openModal(){const e=document.querySelector("#options-modal-content");if(e){e.innerHTML="";for(const t of this.sections){const{name:s,options:i}=t,r=document.createElement("h3");r.textContent=s,e.appendChild(r);const a=document.createElement("ul");for(const e of i){const{name:t,label:s,defaultVal:i,type:r}=e,o=e=>{if(e.target){const s=e.target;switch(r){case _:this.setOption(t,s.checked);break;default:this.setOption(t,s.value)}}},n=document.createElement("li");let h;switch(r){case _:{const e=document.createElement("input"),s="true"===this.prefs.readPref(t,String(i));e.setAttribute("type","checkbox"),e.checked=s,h=e}break;case w:{const s=e,r=document.createElement("select"),a=this.prefs.readPref(t,String(i));for(const e of s.values){const t=document.createElement("option");t.value=e.value,t.textContent=e.name,t.selected=e.value===a,r.appendChild(t)}h=r}break;default:{const e=document.createElement("input"),s=this.prefs.readPref(t,String(i));e.value=s,h=e}}h.id=t,h.addEventListener("change",o),n.appendChild(h);const d=document.createElement("label");d.textContent=s,d.setAttribute("for",t),n.appendChild(d),a.appendChild(n)}e.appendChild(a)}const t=document.createElement("i");t.textContent="* Reload page to take effect",e.append(t)}else console.error("Cannot find target div#options-modal-content");p.show("options-modal")}},Ae=/#([0-9a-f]{2})([0-9a-f]{4})$/i,be=["bin"],_e=[...N,...V,...be],we={"Local Saves":[]},ye={},Se=[],Re=[];let Ee,ve,Te,Pe,Ce,ke,Oe,Me,Ie,Fe,De,Le,Be,xe,Ne,Ue,ze=1;const Xe=new class{driveLight(e,t){document.querySelector("#disk"+e).style.backgroundImage=t?"url(css/red-on-16.png)":"url(css/red-off-16.png)"}dirty(e,t){}label(e,t,s){const i=document.querySelector("#disk-label"+e);return t&&(i.innerText=t+(s?` - ${s}`:"")),i.innerText}};function He(){v(new $(ve).toString())}function Ge(e){new se(ve).compile(e),He()}function We(e,t){const s=parseInt(e,10);ze=s,t.metaKey&&M(I,s)?p.show("http-modal"):(Re[s]&&(document.querySelector("#category_select").value=Re[s],lt()),p.show("load-modal"))}function Ze(e,t){const s=parseInt(e,10),i=ke.getBinary(s),r=document.querySelector("#local_save_link");if(!i)return void alert("No data from drive "+s);const a=new Blob([i],{type:"application/octet-stream"});r.href=window.URL.createObjectURL(a),r.download=Xe.label(s)+".dsk",t.metaKey?function(e){const t=window.open("","_blank");t.document.title=Xe.label(e),t.document.write("<pre>"),t.document.write(ke.getJSON(e,!0)),t.document.write("</pre>"),t.document.close()}(s):(document.querySelector("#save_name").value=Xe.label(s),p.show("save-modal"))}function Ye(e){document.querySelector("#alert-modal .message").innerText=e,p.show("alert-modal")}function Ke(e,t){t.preventDefault(),t.dataTransfer.dropEffect="copy"}function qe(e,t){const s=t.dataTransfer;if(s.items)for(let e=0;e<s.items.length;e++)s.items.remove(e);else s.clearData()}function je(e,t){t.preventDefault(),t.stopPropagation(),e<1&&(e=ke.getMetadata(1)?ke.getMetadata(2)?1:2:1);const s=t.dataTransfer;if(1==s.files.length){const i=t.shiftKey;st(e,s.files[0],{runOnLoad:i})}else if(2==s.files.length)st(1,s.files[0]),st(2,s.files[1]);else for(let t=0;t<s.items.length;t++)"text/uri-list"===s.items[t].type&&s.items[t].getAsString((function(t){const s=St().split("|");s[e-1]=t,document.location.hash=s.join("|")}))}function Ve(){document.querySelector("#loading-modal .meter").style.display="none",p.show("loading-modal")}function Je(){p.close("loading-modal"),ce||Ue.then((()=>{Ee.run()})).catch(console.error)}function Qe(e,t){Ve(),fetch(t).then((function(e){if(e.ok)return e.json();throw new Error("Error loading: "+e.statusText)})).then((function(t){"binary"===t.type?function(e){const t=Math.min(e.length,65536-e.start);for(let s=0;s<t;s++){const t=e.start+s;ve.write(t,e.data[s])}ve.reset(),ve.setPC(e.start)}(t):M(N,t.type)&&function(e,t){let s=t.name;const i=t.category;t.disk&&(s+=" - "+t.disk),Re[e]=i,Se[e]=s,ke.setDisk(e,t),W(t.gamepad)}(e,t),W(t.gamepad),Je()})).catch((function(e){Je(),Ye(e.message)}))}function $e(e){p.close("load-modal");const t=document.querySelector("#disk_select").value;let s;t&&t.length&&(s="string"==typeof t?t:t[0]);const i=document.querySelector("#local_file").files;if(i&&1==i.length){const t=e.shiftKey;st(ze,i[0],{runOnLoad:t})}else if(s){let e;if(p.close("load-modal"),"local:"==s.substr(0,6))e=s.substr(6),"__manage"==e?p.show("manage-modal"):function(e,t){const s=JSON.parse(window.localStorage.diskIndex||"{}");s[t]&&(ke.setJSON(e,s[t]),Xe.label(e,t),Xe.dirty(e,!1))}(ze,e);else{const t=/json\/disks\/(.*).json$/.exec(s);e=t?t[1]:s;const i=St().split("|");i[ze-1]=e,document.location.hash=i.join("|")}}}function et(){const e=document.querySelector("#save_name").value;!function(e,t){const s=JSON.parse(window.localStorage.diskIndex||"{}"),i=ke.getJSON(e);s[t]=i,window.localStorage.diskIndex=JSON.stringify(s),Xe.label(e,t),Xe.dirty(e,!1),pt()}(ze,e),p.close("save-modal"),window.setTimeout((()=>Ye("Saved")),0)}function tt(e){window.confirm("Delete "+e+"?")&&function(e){const t=JSON.parse(window.localStorage.diskIndex||"{}");t[e]&&(delete t[e],Ye("Deleted")),window.localStorage.diskIndex=JSON.stringify(t),pt()}(e)}function st(e,t,s={}){const i=t.name.split("."),r=i[i.length-1].toLowerCase(),a=t.name.match(Ae);let o,n;if(a&&3===a.length&&([,o,n]=a),M(N,r))!function(e,t){Ve();const s=new FileReader;s.onload=function(){const s=this.result,i=t.name.split("."),r=i.pop().toLowerCase(),a=i.join("."),o=St().split("|");o[e-1]="",document.location.hash=o.join("|"),M(N,r)&&(s.byteLength>=819200?M(x,r)&&Oe.setBinary(e,a,r,s)?W():Ye(`Unable to load ${a}`):M(B,r)&&ke.setBinary(e,a,r,s)?W():Ye(`Unable to load ${a}`)),Je()},s.readAsArrayBuffer(t)}(e,t);else if(M(V,r))Ce.doLoadLocalTape(t);else if(be.includes(r)||"06"===o||s.address){const e=void 0!==n?parseInt(n,16):void 0;it(t,Object.assign({address:e},s))}else{const e=document.querySelector("#local_file_address"),i=null==e?void 0:e.value;if(i){const e=parseInt(i,16);if(isNaN(e))return void Ye("Invalid address: "+i);it(t,Object.assign({address:e},s))}else Ye("Unknown file type: "+r)}}function it(e,t){Ve();const s=new FileReader;s.onload=function(){const e=this.result;let{address:s}=t;s=null!=s?s:8192;const i=new Uint8Array(e);for(let t=0;t<e.byteLength;t++)ve.write(s>>8,255&s,i[t]),s++;t.runOnLoad&&(ve.reset(),ve.setPC(s)),Je()},s.readAsArrayBuffer(e)}function rt(e,t){t||p.close("http-modal"),Ve();const s=document.querySelector("#http_url");(t=t||s.value)&&fetch(t).then((function(e){if(e.ok){const t=e.body.getReader();let s=0;const i=[],r=parseInt(e.headers.get("content-length"),10);return t.read().then((function e(a){if(a.done){const e=new Uint8Array(s);let t=0;for(let s=0;s<i.length;s++)e.set(i[s],t),t+=i[s].length;return Promise.resolve(e.buffer)}return s+=a.value.length,r&&function(e,t){if(t){const s=document.querySelector("#loading-modal .meter"),i=document.querySelector("#loading-modal .progress");s.style.display="block",i.style.width=e/t*s.clientWidth+"px"}}(s,r),i.push(a.value),t.read().then(e)}))}throw new Error("Error loading: "+e.statusText)})).then((function(s){const i=t.split("/").pop().split("."),r=i.pop().toLowerCase(),a=decodeURIComponent(i.join("."));if(!M(N,r))throw new Error(`Extension ${r} not recognized.`);s.byteLength>=819200?M(x,r)&&Oe.setBinary(e,a,r,s)&&W():M(B,r)&&ke.setBinary(e,a,r,s)&&W(),Je()})).catch((function(e){Je(),Ye(e.message)}))}let at=0;function ot(){const e=Date.now(),t=e-le,s=ve.getCycles();let i,r,a;const o=document.querySelector("#khz");switch(at){case 0:i=s-me,a=Math.trunc(i/t),o.innerText=a+" kHz";break;case 1:i=Te.renderedFrames-pe,r=Math.trunc(i/(t/1e3)),o.innerText=r+" rps";break;default:i=Te.frames-ue,r=Math.trunc(i/(t/1e3)),o.innerText=r+" fps"}le=e,me=s,pe=Te.renderedFrames,ue=Te.frames}function nt(){at=++at%3}function ht(){const e=!Ie.isEnabled();fe.setOption(C,e),dt(e)}function dt(e){const t=document.querySelector("#toggle-sound i");e?(t.classList.remove("fa-volume-off"),t.classList.add("fa-volume-up")):(t.classList.remove("fa-volume-up"),t.classList.add("fa-volume-off"))}function ct(){Ee.reset()}function lt(){const e=document.querySelector("#disk_select"),t=document.querySelector("#category_select");e.innerHTML="";const s=we[t.value];if(s)for(let t=0;t<s.length;t++){const i=s[t];let r=i.name;i.disk&&(r+=" - "+i.disk);const a=document.createElement("option");a.value=i.filename,a.innerText=r,e.append(a),Se[ze]===r&&(a.selected=!0)}}function mt(){document.querySelector("#local_file").value=""}function ut(e){$e(e)}function pt(){const e=JSON.parse(window.localStorage.diskIndex||"{}"),t=Object.keys(e),s=we["Local Saves"]=[],i=document.querySelector("#manage-modal-content");i.innerHTML="",t.forEach((function(e){s.push({category:"Local Saves",name:e,filename:"local:"+e}),i.innerHTML='<span class="local_save">'+e+' <a href="#" onclick="Apple2.doDelete(\''+e+"')\">Delete</a><br /></span>"})),s.push({category:"Local Saves",name:"Manage Saves...",filename:"local:__manage"})}void 0!==window.localStorage&&document.querySelectorAll(".disksave").forEach((function(e){e.style.display="inline-block"}));const gt=document.querySelector("#category_select");function ft(e){const t=e.split("|");for(let e=0;e<Math.min(2,t.length);e++){const s=e+1;if(!M(I,s))break;const i=t[e];if(i.indexOf("://")>0){const e=i.split(".");"json"==e[e.length-1].toLowerCase()?Qe(s,i):rt(s,i)}else i&&Qe(s,"json/disks/"+i+".json")}}function At(){if(document.location.hash!=ge){ge=document.location.hash;const e=St();e&&ft(e)}}function bt(){const e=document.querySelector("#pause-run i");ce?(Ue.then((()=>{Ee.run()})).catch(console.error),e.classList.remove("fa-play"),e.classList.add("fa-pause")):(Ee.stop(),e.classList.remove("fa-pause"),e.classList.add("fa-play")),ce=!ce}function _t(){fe.openModal()}function wt(){const e=Me.getRawOutput(),t=document.querySelector("#raw_printer_output"),s=new Blob([e],{type:"application/octet-stream"});t.href=window.URL.createObjectURL(s),t.download="raw_printer_output.bin",p.show("printer-modal")}function yt(){Me.clear()}function St(){const e=new RegExp("#(.*)"),t=decodeURIComponent(window.location.hash),s=e.exec(t);return s?s[1]:""}function Rt(e,t,s,i,r){window.addEventListener("load",(()=>{!function(e,t,s,i,r){var a;Ee=e,ve=Ee.getCPU(),xe=Ee.getIO(),Te=e.getStats(),Pe=e.getVideoModes(),Ce=new J(xe),ke=t,Oe=s,Me=i,Ne=r,Le=new de(xe,r),fe.addOptions(Le),De=new ne(xe),fe.addOptions(De),Fe=new ae(Pe),fe.addOptions(Fe),Ie=new O(xe),fe.addOptions(Ie),dt(Ie.isEnabled()),Ue=Promise.all([Ie.ready,e.ready]),p.init(),Be=new j(ve,xe,r),Be.create("#keyboard"),Be.setFunction("F1",(()=>ve.reset())),Be.setFunction("F2",Fe.enterFullScreen),Be.setFunction("F3",(()=>xe.keyDown(27))),Be.setFunction("F6",(()=>{var e;window.localStorage.state=(e=Ee.getState(),JSON.stringify(e,((e,t)=>t instanceof Uint8Array?b+f(t):t)))})),Be.setFunction("F9",(()=>{var e;window.localStorage.state&&Ee.setState((e=window.localStorage.state,JSON.parse(e,((e,t)=>"string"==typeof t&&t.startsWith(b)?A(t.slice(b.length)):t))))})),function(){let e,t="";for(let s=0;s<window.disk_index.length;s++){const i=window.disk_index[s],r=i.category,a=i.name,o=i.disk;i.e&&!Ne||(r!=t&&(e=document.createElement("option"),e.value=r,e.innerText=r,gt.append(e),we[r]=[],t=r),we[r].push(i),o&&(ye[a]||(ye[a]=[]),ye[a].push(i)))}e=document.createElement("option"),e.innerText="Local Saves",gt.append(e),pt()}(),window.addEventListener("paste",(e=>{const t=(e.clipboardData||window.clipboardData).getData("text");xe.setKeyBuffer(t),e.preventDefault()})),window.addEventListener("copy",(e=>{e.clipboardData.setData("text/plain",Pe.getText()),e.preventDefault()})),navigator.standalone&&document.body.classList.add("standalone"),ve.reset(),setInterval(ot,1e3),W();const o=new URLSearchParams(window.location.search).get("disk")||St();o?(Ee.stop(),ft(o)):Ue.then((()=>{Ee.run()})).catch(console.error),null===(a=document.querySelector("#local_file"))||void 0===a||a.addEventListener("change",(e=>{const t=e.target,s=document.querySelector("#local_file_address_input"),i=t.value.split("."),r=i[i.length-1];_e.includes(r)?s.style.display="none":s.style.display="inline-block"}))}(e,t,s,i,r)}))}class Et{constructor(e){this._lineBuffer="",this._rawLen=0,this._raw=new Uint8Array(1024),this.paper=document.querySelector(e),this.newLine()}newLine(){this._line=document.createElement("div"),this._line.classList.add("line"),this._line.innerText=this._lineBuffer,this.paper.append(this._line),this._lineBuffer=""}putChar(e){const t=127&e,s=e>=32,i=String.fromCharCode(t);if("\r"===i?this.newLine():"\n"===i||("\t"===i?this._lineBuffer+="        ":4===t?this._lineBuffer=this._lineBuffer.slice(0,-1):s&&(this._lineBuffer+=i)),this._line.innerText=this._lineBuffer,this._raw[this._rawLen]=e,this._rawLen++,this._rawLen>this._raw.length){const e=new Uint8Array(2*this._raw.length);e.set(this._raw),this._raw=e}}clear(){this._lineBuffer="",this.paper.innerHTML="",this.newLine(),this._raw=new Uint8Array(1024),this._rawLen=0}hasPrintout(){return this.paper.innerText.length>0}getRawOutput(){return this._raw.slice(0,this._rawLen)}}const vt=[0,7,14,6,13,5,12,4,11,3,10,2,9,1,8,15],Tt=[0,13,11,9,7,5,3,1,14,12,10,8,6,4,2,15],Pt=[0,8,1,9,2,10,3,11,4,12,5,13,6,14,7,15],Ct=[0,2,4,6,8,10,12,14,1,3,5,7,9,11,13,15],kt=[0,10,7,4,1,11,8,5,2,12,9,6,3],Ot=[171,173,174,175,181,182,183,186,187,189,190,191,214,215,218,219,221,222,223,234,235,237,238,239,245,246,247,250,251,253,254,255],Mt=[150,151,154,155,157,158,159,166,167,171,172,173,174,175,178,179,180,181,182,183,185,186,187,188,189,190,191,203,205,206,207,211,214,215,217,218,219,220,221,222,223,229,230,231,233,234,235,236,237,238,239,242,243,244,245,246,247,249,250,251,252,253,254,255],It=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,3,0,4,5,6,0,0,0,0,0,0,7,8,0,0,0,9,10,11,12,13,0,0,14,15,16,17,18,19,0,20,21,22,23,24,25,26,0,0,0,0,0,0,0,0,0,0,0,27,0,28,29,30,0,0,0,31,0,0,32,33,0,34,35,36,37,38,39,40,0,0,0,0,0,41,42,43,0,44,45,46,47,48,49,50,0,0,51,52,53,54,55,56,0,57,58,59,60,61,62,63];function Ft(e){let t=170&e,s=85&e;return t>>=1,t|=170,s|=170,[t,s]}function Dt(e,t){return(e<<1|1)&t}function Lt(e,t,s,i){let r,a=[];r=0===s?128:0===t?40:38;for(let e=0;e<r;e++)a.push(255);const o=e^t^s;a=a.concat([213,170,150]),a=a.concat(Ft(e)),a=a.concat(Ft(t)),a=a.concat(Ft(s)),a=a.concat(Ft(o)),a=a.concat([222,170,235]);for(let e=0;e<5;e++)a.push(255);a=a.concat([213,170,173]);const n=[];for(let e=0;e<342;e++)n[e]=0;let h=85;for(let e=257;e>=0;e--){let t=i[e%256],s=n[0+h];s=s<<1|1&t,t>>=1,s=s<<1|1&t,t>>=1,n[86+e]=t,n[0+h]=s,--h<0&&(h=85)}let d=0;for(let e=0;e<342;e++){const t=n[e];a.push(Mt[d^t]),d=t}return a.push(Mt[d]),a=a.concat([222,170,235]),a.push(255),a}function Bt(e,t,s,i){let r,a=[];r=0===s?128:0===t?40:38;for(let e=0;e<r;e++)a.push(255);const o=e^t^s;a=a.concat([213,170,181]),a=a.concat(Ft(e)),a=a.concat(Ft(t)),a=a.concat(Ft(s)),a=a.concat(Ft(o)),a=a.concat([222,170,235]);for(let e=0;e<5;e++)a.push(255);a=a.concat([213,170,173]);const n=[];let h=0;for(let e=50;e>=0;e--){const t=i[h]>>3,s=7&i[h];h++;const r=i[h]>>3,a=7&i[h];h++;const o=i[h]>>3,d=7&i[h];h++;const c=i[h]>>3,l=7&i[h];h++;const m=i[h]>>3,u=7&i[h];h++,n[e+0]=t,n[e+51]=r,n[e+102]=o,n[e+153]=c,n[e+204]=m,n[e+256]=s<<2|(4&l)>>1|(4&u)>>2,n[e+307]=a<<2|2&l|(2&u)>>1,n[e+358]=d<<2|(1&l)<<1|1&u}n[255]=i[h]>>3,n[409]=7&i[h];let d=0;for(let e=409;e>=256;e--){const t=n[e];a.push(Ot[d^t]),d=t}for(let e=0;e<256;e++){const t=n[e];a.push(Ot[d^t]),d=t}return a.push(Ot[d]),a=a.concat([222,170,235]),a.push(255),a}function xt(e,t,s){const i="po"==e.format?Ct[s]:Tt[s];let r,a=0,o=0,n=0;const h=e.tracks[t];function d(){const e=h[o++];return o>=h.length&&(o=0,n++),e}function c(e){o+=e,o>=h.length&&(o%=h.length,n++)}let l,m=0,u=0,p=0;const g=new Uint8Array(256);for(;n<4;)switch(a){case 0:r=d(),a=213===r?1:0;break;case 1:r=d(),a=170===r?2:0;break;case 2:r=d(),a=150===r?3:173===r?4:0;break;case 3:p=Dt(d(),d()),m=Dt(d(),d()),u=Dt(d(),d()),l=Dt(d(),d()),l!=(p^m^u)&&v("Invalid header checksum:",T(p),T(m),T(u),T(l)),c(3),a=0;break;case 4:if(u===i&&m===t){const e=[];let t=0;for(let s=85;s>=0;s--)r=It[d()-128]^t,e[s]=r,t=r;for(let e=0;e<256;e++)r=It[d()-128]^t,g[e]=r,t=r;l=It[d()-128]^t,l&&v("Invalid data checksum:",T(p),T(m),T(u),T(l));for(let t=0,s=85;t<256;t++)g[t]<<=1,0!=(1&e[s])&&(g[t]|=1),e[s]>>=1,g[t]<<=1,0!=(1&e[s])&&(g[t]|=1),e[s]>>=1,--s<0&&(s=85);return g}c(345),a=0}return new Uint8Array}function Nt(e,t){let s=0,i=!0;for(;t<e.length&&(e[t]?(s=s<<1|1,i=!1):i||(s<<=1),!(128&s));)t+=1;return{nibble:s,offset:t}}function Ut(e){const{data:t,name:s,side:i,rawData:r,volume:a,readOnly:o}=e,n={format:"dsk",encoding:F,name:s,side:i,volume:a,readOnly:o,tracks:[]};for(let e=0;e<35;e++){let s=[];for(let i=0;i<16;i++){const o=vt[i];let n;if(r){const t=256*(16*e+o);n=new Uint8Array(r.slice(t,t+256))}else{if(!t)throw new Error("Requires data or rawData");n=new Uint8Array(t[e][o])}s=s.concat(Lt(a,e,i,n))}n.tracks[e]=E(s)}return n}function zt(e){const{data:t,name:s,side:i,rawData:r,volume:a,readOnly:o}=e,n={format:"nib",encoding:F,name:s,side:i,volume:a||254,readOnly:o||!1,tracks:[]};for(let e=0;e<35;e++){let s;if(r){const t=6656*e;s=new Uint8Array(r.slice(t,t+6656))}else{if(!t)throw new Error("Requires data or rawData");s=t[e][0]}n.tracks[e]=s}return n}function Xt(e){const{data:t,name:s,side:i,rawData:r,volume:a,readOnly:o}=e,n={format:"nib",encoding:F,name:s,side:i,volume:a||254,tracks:[],readOnly:o||!1};for(let e=0;e<35;e++){let s=[];for(let i=0;i<16;i++){const o=Pt[i];let n;if(r){const t=256*(16*e+o);n=new Uint8Array(r.slice(t,t+256))}else{if(!t)throw new Error("Requires data or rawData");n=t[e][o]}s=s.concat(Lt(a,e,i,n))}n.tracks[e]=E(s)}return n}function Ht(e){const t=new DataView(e),s=P(t.getInt32(0,!0));if("2IMG"!==s)throw new Error("Unrecognized 2mg signature: "+s);const i=P(t.getInt32(4,!0)),r=t.getInt32(12,!0),a=t.getInt32(28,!0),o=t.getInt32(24,!0),n=t.getInt32(10,!0),h=0!=(2147483648&n);let d=254;return 256&n&&(d=255&n),v("created by",i),{bytes:a,creator:i,format:r,offset:o,readOnly:h,volume:d}}function Gt(e,t,s){return String.fromCharCode.apply(null,new Uint8Array(e.buffer.slice(e.byteOffset+t,e.byteOffset+s)))}class Wt{constructor(e){this.sides=0,this.bootSector=0,this.bitTiming=0,this.compatibleHardware=0,this.requiredRAM=0,this.largestTrack=0,this.version=e.getUint8(0),this.diskType=e.getUint8(1),this.writeProtected=e.getUint8(2),this.synchronized=e.getUint8(3),this.cleaned=e.getUint8(4),this.creator=Gt(e,5,37),this.version>1&&(this.sides=e.getUint8(37),this.bootSector=e.getUint8(38),this.bitTiming=e.getUint8(39),this.compatibleHardware=e.getUint16(40,!0),this.requiredRAM=e.getUint16(42,!0),this.largestTrack=e.getUint16(44,!0))}}class Zt{constructor(e){this.trackMap=[];for(let t=0;t<160;t++)this.trackMap.push(e.getUint8(t))}}class Yt{}class Kt extends Yt{constructor(e){super(),this.rawTracks=[],this.tracks=[];for(let t=0,s=0;s<e.byteLength;s+=6656,t++){let i=[];const r=[],a=e.buffer.slice(e.byteOffset+s,e.byteOffset+s+6656),o=new Uint8Array(a),n=new DataView(a).getUint16(6648,!0);for(let e=0;e<n;e++){const t=e>>3,s=7-(7&e);r[e]=o[t]>>s&1?1:0}i=[];let h=0;for(;h<r.length;){const e=Nt(r,h);if(!e.nibble)break;i.push(e.nibble),h=e.offset+1}this.tracks[t]=new Uint8Array(i),this.rawTracks[t]=new Uint8Array(r)}}}class qt extends Yt{constructor(e){let t;for(super(),this.trks=[],t=0;t<160;t++){const s=e.getUint16(8*t,!0),i=e.getUint16(8*t+2,!0),r=e.getUint32(8*t+4,!0);if(0===r)break;this.trks.push({startBlock:s,blockCount:i,bitCount:r})}this.tracks=[],this.rawTracks=[];const s=e.buffer;for(t=0;t<this.trks.length;t++){const e=this.trks[t];let i=[];const r=[],a=512*e.startBlock,o=a+512*e.blockCount,n=s.slice(a,o),h=new Uint8Array(n);for(let t=0;t<e.bitCount;t++){const e=t>>3,s=7-(7&t);r[t]=h[e]>>s&1?1:0}i=[];let d=0;for(;d<r.length;){const e=Nt(r,d);if(!e.nibble)break;i.push(e.nibble),d=e.offset+1}this.tracks[t]=new Uint8Array(i),this.rawTracks[t]=new Uint8Array(r)}}}class jt{constructor(e){const t=Gt(e,0,e.byteLength).split("\n");this.values=t.reduce((function(e,t){const s=t.split("\t");return e[s[0]]=s[1],e}),{})}}function Vt(e,t){let s=null;switch(e){case"2mg":s=function(e){let t,{rawData:s}=e;if(!s)throw new Error("Requires rawData");const{bytes:i,format:r,offset:a,readOnly:o,volume:n}=Ht(s);switch(s=s.slice(a,a+i),e=Object.assign(Object.assign({},e),{rawData:s,readOnly:o,volume:n}),r){case 1:t=Xt(e);break;case 2:t=zt(e);break;case 0:default:t=Ut(e)}return t}(t);break;case"d13":s=function(e){const{data:t,name:s,side:i,rawData:r,volume:a,readOnly:o}=e,n={format:"d13",encoding:F,name:s,side:i,volume:a,readOnly:o,tracks:[]};if(!t&&!r)throw new Error("data or rawData required");for(let e=0;e<35;e++){let s=[];for(let i=0;i<13;i++){const o=kt[i];let n;if(r){const t=256*(13*e+o);n=new Uint8Array(r.slice(t,t+256))}else{if(!t)throw new Error("Requires data or rawData");n=t[e][o]}s=s.concat(Bt(a,e,o,n))}n.tracks.push(new Uint8Array(s))}return n}(t);break;case"do":case"dsk":s=Ut(t);break;case"nib":s=zt(t);break;case"po":s=Xt(t);break;case"woz":s=function(e){const{rawData:t}=e;if(!t)throw new Error("Requires rawData");const s=new DataView(t,0);let i,r=0;const a={};function o(){if(r>=s.byteLength)return null;const e=s.getUint32(r,!0),t=s.getUint32(r+4,!0),i=new DataView(s.buffer,r+8,t);return r+=t+8,{type:e,size:t,data:i}}if(function(){switch(s.getUint32(0,!0)){case 828002135:i=1;break;case 844779351:i=2;break;default:return!1}return 168626943===s.getUint32(4,!0)}()){r=12;let e=o();for(;e;){switch(e.type){case 1330007625:a.info=new Wt(e.data);break;case 1346456916:a.tmap=new Zt(e.data);break;case 1397445204:a.trks=1===i?new Kt(e.data):new qt(e.data);break;case 1096041805:a.meta=new jt(e.data);break;case 1414091351:break;default:v("Unsupported chunk",T(e.type,8))}e=o()}}else v("Invalid woz header");v(a);const{meta:n,tmap:h,trks:d}=a;return{encoding:D,trackMap:(null==h?void 0:h.trackMap)||[],tracks:(null==d?void 0:d.tracks)||[],rawTracks:(null==d?void 0:d.rawTracks)||[],readOnly:!0,name:(null==n?void 0:n.values.title)||e.name,side:(null==n?void 0:n.values.side_name)||(null==n?void 0:n.values.side)}}(t)}return s}const Jt=new Uint8Array([162,32,160,0,162,3,134,60,138,10,36,60,240,16,5,60,73,255,41,126,176,8,74,208,251,152,157,86,3,200,232,16,229,32,88,255,186,189,0,1,10,10,10,10,133,43,170,189,142,192,189,140,192,189,138,192,189,137,192,160,80,189,128,192,152,41,3,10,5,43,170,189,129,192,169,86,32,168,252,136,16,235,133,38,133,61,133,65,169,8,133,39,24,8,189,140,192,16,251,73,213,208,247,189,140,192,16,251,201,170,208,243,234,189,140,192,16,251,201,150,240,9,40,144,223,73,173,240,37,208,217,160,3,133,64,189,140,192,16,251,42,133,60,189,140,192,16,251,37,60,136,208,236,40,197,61,208,190,165,64,197,65,208,184,176,183,160,86,132,60,188,140,192,16,251,89,214,2,164,60,136,153,0,3,208,238,132,60,188,140,192,16,251,89,214,2,164,60,145,38,200,208,239,188,140,192,16,251,89,214,2,208,135,160,0,162,86,202,48,251,177,38,94,0,3,42,94,0,3,42,145,38,200,208,238,230,39,230,61,165,61,205,0,8,166,43,144,219,76,1,8,0,0,0,0,0]),Qt=new Uint8Array([162,32,160,0,169,3,133,60,24,136,152,36,60,240,245,38,60,144,248,192,213,240,237,202,138,153,0,8,208,230,32,88,255,186,189,0,1,72,10,10,10,10,133,43,170,169,208,72,189,142,192,189,140,192,189,138,192,189,137,192,160,80,189,128,192,152,41,3,10,5,43,170,189,129,192,169,86,32,168,252,136,16,235,169,3,133,39,169,0,133,38,133,61,24,8,189,140,192,16,251,73,213,208,247,189,140,192,16,251,201,170,208,243,234,189,140,192,16,251,201,181,240,9,40,144,223,73,173,240,31,208,217,160,3,132,42,189,140,192,16,251,42,133,60,189,140,192,16,251,37,60,136,208,238,40,197,61,208,190,176,189,160,154,132,60,188,140,192,16,251,89,0,8,164,60,136,153,0,8,208,238,132,60,188,140,192,16,251,89,0,8,164,60,145,38,200,208,239,188,140,192,16,251,89,0,8,208,141,96,168,162,0,185,0,8,74,62,204,3,74,62,153,3,133,60,177,38,10,10,10,5,60,145,38,200,232,224,51,208,228,198,42,208,222,204,0,3,208,3,76,1,3,76,45,255,255]),$t=[216,24,24,8,10,10,10,10,24,24,24,24,24,24,24,24,216,45,40,40,10,10,10,10,40,40,40,40,40,40,40,40,216,56,56,56,10,10,10,10,57,57,57,57,59,59,59,59,216,72,216,72,10,10,10,10,72,72,72,72,72,72,72,72,216,88,216,88,10,10,10,10,88,88,88,88,88,88,88,88,216,104,216,104,10,10,10,10,104,104,104,104,104,104,104,104,216,120,216,120,10,10,10,10,120,120,120,120,120,120,120,120,216,136,216,136,10,10,10,10,8,8,136,136,8,8,136,136,216,152,216,152,10,10,10,10,152,152,152,152,152,152,152,152,216,9,216,168,10,10,10,10,168,168,168,168,168,168,168,168,205,189,216,184,10,10,10,10,185,185,185,185,187,187,187,187,217,57,216,200,10,10,10,10,200,200,200,200,200,200,200,200,217,217,216,160,10,10,10,10,216,216,216,216,216,216,216,216,29,13,232,232,10,10,10,10,232,232,232,232,232,232,232,232,253,253,248,248,10,10,10,10,248,248,248,248,248,248,248,248,221,77,224,224,10,10,10,10,136,136,8,8,136,136,8,8],es=[24,24,24,24,10,10,10,10,24,24,24,24,24,24,24,24,45,45,56,56,10,10,10,10,40,40,40,40,40,40,40,40,216,56,8,40,10,10,10,10,57,57,57,57,59,59,59,59,216,72,72,72,10,10,10,10,72,72,72,72,72,72,72,72,216,88,216,88,10,10,10,10,88,88,88,88,88,88,88,88,216,104,216,104,10,10,10,10,104,104,104,104,104,104,104,104,216,120,216,120,10,10,10,10,120,120,120,120,120,120,120,120,216,136,216,136,10,10,10,10,8,8,136,136,8,8,136,136,216,152,216,152,10,10,10,10,152,152,152,152,152,152,152,152,216,41,216,168,10,10,10,10,168,168,168,168,168,168,168,168,205,189,216,184,10,10,10,10,185,185,185,185,187,187,187,187,217,89,216,200,10,10,10,10,200,200,200,200,200,200,200,200,217,217,216,160,10,10,10,10,216,216,216,216,216,216,216,216,216,8,232,232,10,10,10,10,232,232,232,232,232,232,232,232,253,253,248,248,10,10,10,10,248,248,248,248,248,248,248,248,221,77,224,224,10,10,10,10,136,136,8,8,136,136,8,8],ts=[[0,1,2,-1],[-1,0,1,2],[-2,-1,0,1],[1,-2,-1,0]];function ss(e){return e.encoding===F}function is(e){return e.encoding===D}function rs(e){let t;if(e.encoding===F){t={format:e.format,encoding:F,volume:e.volume,name:e.name,side:e.side,tracks:[],track:e.track,head:e.head,phase:e.phase,readOnly:e.readOnly,dirty:e.dirty};for(let s=0;s<e.tracks.length;s++)t.tracks.push(new Uint8Array(e.tracks[s]))}else{t={format:e.format,encoding:D,volume:e.volume,name:e.name,side:e.side,track:e.track,head:e.head,phase:e.phase,readOnly:e.readOnly,dirty:e.dirty,trackMap:[...e.trackMap],rawTracks:[]};for(let s=0;s<e.rawTracks.length;s++)t.rawTracks.push(new Uint8Array(e.rawTracks[s]))}return t}class as{constructor(e,t,s=16){this.io=e,this.callbacks=t,this.sectors=s,this.drives=[{format:"dsk",encoding:F,volume:254,name:"Disk 1",tracks:[],track:0,head:0,phase:0,readOnly:!1,dirty:!1},{format:"dsk",encoding:F,volume:254,name:"Disk 2",tracks:[],track:0,head:0,phase:0,readOnly:!1,dirty:!1}],this.skip=0,this.bus=0,this.latch=0,this.offTimeout=null,this.q6=0,this.q7=!1,this.writeMode=!1,this.on=!1,this.drive=1,this.cur=this.drives[this.drive-1],this.nibbleCount=0,this.q=[!1,!1,!1,!1],this.clock=0,this.lastCycles=0,this.state=0,this.zeros=0,this.debug("Disk ]["),this.lastCycles=this.io.cycles(),this.bootstrapRom=16==this.sectors?Jt:Qt,this.sequencerRom=16==this.sectors?es:$t,this.initWorker()}debug(...e){}moveHead(){const e=this.io.cycles();let t=2*(e-this.lastCycles);if(this.lastCycles=e,!is(this.cur))return;const s=this.cur.rawTracks[this.cur.trackMap[this.cur.track]]||[0];for(;t-- >0;){let e=0;4==this.clock&&(e=s[this.cur.head],e?this.zeros=0:++this.zeros>2&&(e=Math.random()>=.5?1:0));let t=0;t|=e?0:1,t|=128&this.latch?2:0,t|=this.q6?4:0,t|=this.q7?8:0,t|=this.state<<4;const i=this.sequencerRom[t];switch(this.on&&this.q7&&v("clock:",this.clock,"command:",T(i),"q6:",this.q6),15&i){case 0:this.latch=0;break;case 8:break;case 9:this.latch=this.latch<<1&255;break;case 10:this.latch>>=1,this.cur.readOnly&&(this.latch|=128);break;case 11:this.latch=this.bus,v("Loading",T(this.latch),"from bus");break;case 13:this.latch=255&(this.latch<<1|1)}this.state=i>>4&15,4==this.clock&&this.on&&(this.q7&&(s[this.cur.head]=8&this.state?1:0,v("Wrote",8&this.state?1:0)),++this.cur.head>=s.length&&(this.cur.head=0)),++this.clock>7&&(this.clock=0)}}readWriteNext(){if(ss(this.cur)){if(this.on&&(this.skip||this.writeMode)){const e=this.cur.tracks[this.cur.track>>2];e&&e.length&&(this.cur.head>=e.length&&(this.cur.head=0),this.writeMode?this.cur.readOnly||(e[this.cur.head]=this.bus,this.cur.dirty||this.updateDirty(this.drive,!0)):this.latch=e[this.cur.head],++this.cur.head)}else this.latch=0;this.skip=++this.skip%2}}setPhase(e,t){this.debug("phase "+e+(t?" on":" off")),t&&(this.cur.track+=2*ts[this.cur.phase][e],this.cur.phase=e);const s=ss(this.cur)?4*this.cur.tracks.length-1:this.cur.trackMap.length-1;this.cur.track>s&&(this.cur.track=s),this.cur.track<0&&(this.cur.track=0),this.q[e]=t}access(e,t){let s=0;const i=void 0===t;switch(143&e){case 128:this.setPhase(0,!1);break;case 129:this.setPhase(0,!0);break;case 130:this.setPhase(1,!1);break;case 131:this.setPhase(1,!0);break;case 132:this.setPhase(2,!1);break;case 133:this.setPhase(2,!0);break;case 134:this.setPhase(3,!1);break;case 135:this.setPhase(3,!0);break;case 136:this.offTimeout||this.on&&(this.offTimeout=window.setTimeout((()=>{this.debug("Drive Off"),this.on=!1,this.callbacks.driveLight(this.drive,!1),this.debug("nibbles read",this.nibbleCount)}),1e3));break;case 137:this.offTimeout&&(window.clearTimeout(this.offTimeout),this.offTimeout=null),this.on||(this.debug("Drive On"),this.nibbleCount=0,this.on=!0,this.lastCycles=this.io.cycles(),this.callbacks.driveLight(this.drive,!0));break;case 138:this.debug("Disk 1"),this.drive=1,this.cur=this.drives[this.drive-1],this.on&&(this.callbacks.driveLight(2,!1),this.callbacks.driveLight(1,!0));break;case 139:this.debug("Disk 2"),this.drive=2,this.cur=this.drives[this.drive-1],this.on&&(this.callbacks.driveLight(1,!1),this.callbacks.driveLight(2,!0));break;case 140:this.q6=0,this.writeMode&&this.debug("clearing _q6/SHIFT"),ss(this.cur)&&this.readWriteNext();break;case 141:this.q6=1,this.writeMode&&this.debug("setting _q6/LOAD"),ss(this.cur)&&i&&!this.writeMode&&(this.cur.readOnly?(this.latch=255,this.debug("Setting readOnly")):(this.latch=this.latch>>1,this.debug("Clearing readOnly")));break;case 142:this.debug("Read Mode"),this.q7=!1,this.writeMode=!1;break;case 143:this.debug("Write Mode"),this.q7=!1,this.writeMode=!0}return this.moveHead(),i?0==(1&e)?(s=this.latch,128&s&&this.nibbleCount++):s=0:this.bus=t,s}updateDirty(e,t){this.drives[e-1].dirty=t,this.callbacks.dirty&&this.callbacks.dirty(e,t)}ioSwitch(e,t){return this.access(e,t)}read(e,t){return this.bootstrapRom[t]}write(){}reset(){this.on&&(this.callbacks.driveLight(this.drive,!1),this.writeMode=!1,this.on=!1,this.drive=1,this.cur=this.drives[this.drive-1]);for(let e=0;e<4;e++)this.q[e]=!1}tick(){this.moveHead()}getState(){const e={drives:[],skip:this.skip,latch:this.latch,writeMode:this.writeMode,on:this.on,drive:this.drive};return this.drives.forEach((function(t,s){e.drives[s]=function(e){const t={format:e.format,encoding:e.encoding,volume:e.volume,name:e.name,side:e.side,tracks:[],track:e.track,head:e.head,phase:e.phase,readOnly:e.readOnly,dirty:e.dirty,trackMap:[],rawTracks:[]};if(ss(e))for(let s=0;s<e.tracks.length;s++)t.tracks.push(new Uint8Array(e.tracks[s]));if(is(e)){t.trackMap=[...e.trackMap];for(let s=0;s<e.rawTracks.length;s++)t.rawTracks.push(new Uint8Array(e.rawTracks[s]))}return t}(t)})),e}setState(e){this.skip=e.skip,this.latch=e.latch,this.writeMode=e.writeMode,this.on=e.on,this.drive=e.drive;for(const t of I){const s=t-1;this.drives[s]=rs(e.drives[s]);const{name:i,side:r,dirty:a}=e.drives[s];this.callbacks.label(t,i,r),this.callbacks.driveLight(t,this.on),this.callbacks.dirty(t,a)}this.cur=this.drives[this.drive-1]}getMetadata(e){const t=this.drives[e-1];return{format:t.format,volume:t.volume,track:t.track,head:t.head,phase:t.phase,readOnly:t.readOnly,dirty:t.dirty}}rwts(e,t,s){const i=this.drives[e-1];if(!ss(i))throw new Error("Can't read WOZ disks");return xt(i,t,s)}setDisk(e,t){if(this.worker){const s={type:"PROCESS_JSON_DISK",payload:{drive:e,jsonDisk:t}};return this.worker.postMessage(s),!0}{const s=function(e){const t=e.type,s=e.readOnly,i=e.name,r=e.disk;if(M(B,t)){let a;if("base64"==e.encoding){a=[];for(let t=0;t<e.data.length;t++)if(a[t]=[],"nib"===e.type)a[t][0]=A(e.data[t]);else for(let s=0;s<e.data[t].length;s++)a[t][s]=A(e.data[t][s])}else a=e.data;return Vt(t,{volume:e.volume||254,readOnly:s,name:i,side:r,data:a})}return null}(t);if(s){const t=this.drives[e-1];return Object.assign(t,s),this.updateDirty(e,!1),this.callbacks.label(e,s.name,s.side),!0}}return!1}getJSON(e,t=!1){const s=this.drives[e-1];if(!ss(s))throw new Error("Can't save WOZ disks to JSON");return function(e,t){const s=[];let i="dsk";for(let t=0;t<e.tracks.length;t++)if(s[t]=[],"nib"===e.format)i="nib",s[t]=f(e.tracks[t]);else for(let i=0;i<16;i++)s[t][i]=f(xt(e,t,i));return JSON.stringify({type:i,encoding:"base64",volume:e.volume,data:s,readOnly:e.readOnly},void 0,t?"    ":void 0)}(s,t)}setJSON(e,t){if(this.worker){const s={type:"PROCESS_JSON",payload:{drive:e,json:t}};this.worker.postMessage(s)}else{const s=this.drives[e-1];Object.assign(s,function(e){const t=[],s=JSON.parse(e),i=s.volume,r=s.readOnly;for(let e=0;e<s.data.length;e++){let r=[];for(let t=0;t<s.data[e].length;t++){const a="po"==s.type?Pt[t]:vt[t],o=A(s.data[e][a]);r=r.concat(Lt(i,e,t,o))}t[e]=E(r)}return{volume:i,format:s.type,encoding:F,name:s.name,tracks:t,readOnly:r}}(t))}return!0}setBinary(e,t,s,i){const r={name:t,rawData:i,readOnly:!1,volume:254};if(this.worker){const t={type:"PROCESS_BINARY",payload:{drive:e,fmt:s,options:r}};return this.worker.postMessage(t),!0}{const t=Vt(s,r);if(t){const s=this.drives[e-1],{name:i,side:r}=s;return Object.assign(s,t),this.updateDirty(e,!0),this.callbacks.label(e,i,r),!0}}return!1}initWorker(){this.worker=new Worker("dist/format_worker.bundle.js"),this.worker.addEventListener("message",(e=>{const{data:t}=e;switch(t.type){case"DISK_PROCESSED":{const{drive:e,disk:s}=t.payload;if(s){const t=this.drives[e-1];Object.assign(t,s);const{name:i,side:r}=t;this.updateDirty(e,!0),this.callbacks.label(e,i,r)}}}}))}getBinary(e){const t=this.drives[e-1];if(!ss(t))return null;const s=16*t.tracks.length*256,i=new Uint8Array(s);let r=0;for(let e=0;e<t.tracks.length;e++)if("nib"===t.format)i.set(t.tracks[e],r),r+=t.tracks[e].length;else for(let s=0;s<16;s++){const a=xt(t,e,s);i.set(a,r),r+=a.length}return i}getBase64(e){const t=this.drives[e-1];if(!ss(t))return null;const s=[];for(let e=0;e<t.tracks.length;e++)if("nib"===t.format)s[e]=f(t.tracks[e]);else{const i=[];for(let s=0;s<16;s++)i[s]=f(xt(t,e,s));s[e]=i}return s}}const os=new Uint8Array([24,176,56,72,138,72,152,72,8,120,32,88,255,186,104,104,104,104,168,202,154,104,40,170,144,56,189,184,5,16,25,152,41,127,73,48,201,10,144,59,201,120,176,41,73,61,240,33,152,41,159,157,56,6,144,126,189,184,6,48,20,165,36,221,56,7,176,13,201,17,176,9,9,240,61,56,7,101,36,133,36,74,56,176,109,24,106,61,184,6,144,2,73,129,157,184,6,208,83,160,10,125,56,5,136,208,250,157,184,4,157,56,5,56,176,67,197,36,144,58,104,168,104,170,104,76,240,253,144,254,176,254,153,128,192,144,55,73,7,168,73,10,10,208,6,184,133,36,157,56,7,189,184,6,74,112,2,176,35,10,10,169,39,176,207,189,56,7,253,184,4,201,248,144,3,105,39,172,169,0,133,36,24,126,184,5,104,168,104,170,104,96,144,39,176,0,16,17,169,137,157,56,6,157,184,6,169,40,157,184,4,169,2,133,54,152,93,56,6,10,240,144,94,184,5,152,72,138,10,10,10,10,168,189,56,7,197,36,104,176,5,72,41,128,9,32,44,88,255,240,3,254,56,7,112,132]);class ns{constructor(e){this.cbs=e,v("Parallel card")}access(e,t){switch(143&e){case 128:this.cbs.putChar&&t&&this.cbs.putChar(t);break;default:v("Parallel card unknown softswitch",e)}return 0}ioSwitch(e,t){return this.access(e,t)}read(e,t){return os[t]}write(){}getState(){return{}}setState(e){}}const hs=new Uint8Array([67,79,80,89,82,73,71,72,84,32,40,67,41,32,49,57,56,54,45,56,57,32,65,80,80,76,73,69,68,32,69,78,71,73,78,69,69,82,73,78,71,0,66,79,66,32,83,65,78,68,69,82,45,67,69,68,69,82,76,79,70,0,77,73,67,72,65,69,76,32,87,73,76,75,83,0,83,84,69,86,69,78,32,77,65,76,69,67,72,69,75,0,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,201,32,201,0,201,3,201,0,176,49,32,22,193,76,155,193,32,22,193,76,159,193,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,193,174,255,207,14,159,192,162,152,140,248,7,142,120,7,76,223,201,169,193,197,57,8,32,22,193,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,193,76,186,250,185,56,4,201,1,208,42,32,123,193,24,144,36,32,154,202,32,235,202,160,193,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,16,76,1,8,96,160,3,208,2,160,5,162,3,185,213,193,149,66,136,202,16,247,8,120,142,159,192,162,152,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,159,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,193,76,0,200,32,40,193,76,232,203,201,16,240,4,170,160,15,96,104,104,32,40,193,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,194,76,155,194,32,22,194,76,159,194,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,194,174,255,207,14,175,192,162,168,140,248,7,142,120,7,76,223,201,169,194,197,57,8,32,22,194,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,194,76,186,250,185,56,4,201,1,208,42,32,123,194,24,144,36,32,154,202,32,235,202,160,194,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,32,76,1,8,96,160,3,208,2,160,5,162,3,185,213,194,149,66,136,202,16,247,8,120,142,175,192,162,168,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,175,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,194,76,0,200,32,40,194,76,232,203,201,32,240,4,170,160,15,96,104,104,32,40,194,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,195,76,155,195,32,22,195,76,159,195,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,195,174,255,207,14,191,192,162,184,140,248,7,142,120,7,76,223,201,169,195,197,57,8,32,22,195,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,195,76,186,250,185,56,4,201,1,208,42,32,123,195,24,144,36,32,154,202,32,235,202,160,195,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,48,76,1,8,96,160,3,208,2,160,5,162,3,185,213,195,149,66,136,202,16,247,8,120,142,191,192,162,184,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,191,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,195,76,0,200,32,40,195,76,232,203,201,48,240,4,170,160,15,96,104,104,32,40,195,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,196,76,155,196,32,22,196,76,159,196,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,196,174,255,207,14,207,192,162,200,140,248,7,142,120,7,76,223,201,169,196,197,57,8,32,22,196,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,196,76,186,250,185,56,4,201,1,208,42,32,123,196,24,144,36,32,154,202,32,235,202,160,196,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,64,76,1,8,96,160,3,208,2,160,5,162,3,185,213,196,149,66,136,202,16,247,8,120,142,207,192,162,200,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,207,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,196,76,0,200,32,40,196,76,232,203,201,64,240,4,170,160,15,96,104,104,32,40,196,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,197,76,155,197,32,22,197,76,159,197,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,197,174,255,207,14,223,192,162,216,140,248,7,142,120,7,76,223,201,169,197,197,57,8,32,22,197,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,197,76,186,250,185,56,4,201,1,208,42,32,123,197,24,144,36,32,154,202,32,235,202,160,197,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,80,76,1,8,96,160,3,208,2,160,5,162,3,185,213,197,149,66,136,202,16,247,8,120,142,223,192,162,216,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,223,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,197,76,0,200,32,40,197,76,232,203,201,80,240,4,170,160,15,96,104,104,32,40,197,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,198,76,155,198,32,22,198,76,159,198,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,198,174,255,207,14,239,192,162,232,140,248,7,142,120,7,76,223,201,169,198,197,57,8,32,22,198,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,198,76,186,250,185,56,4,201,1,208,42,32,123,198,24,144,36,32,154,202,32,235,202,160,198,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,96,76,1,8,96,160,3,208,2,160,5,162,3,185,213,198,149,66,136,202,16,247,8,120,142,239,192,162,232,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,239,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,198,76,0,200,32,40,198,76,232,203,201,96,240,4,170,160,15,96,104,104,32,40,198,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,199,76,155,199,32,22,199,76,159,199,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,199,174,255,207,14,255,192,162,248,140,248,7,142,120,7,76,223,201,169,199,197,57,8,32,22,199,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,199,76,186,250,185,56,4,201,1,208,42,32,123,199,24,144,36,32,154,202,32,235,202,160,199,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,112,76,1,8,96,160,3,208,2,160,5,162,3,185,213,199,149,66,136,202,16,247,8,120,142,255,192,162,248,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,255,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,199,76,0,200,32,40,199,76,232,203,201,112,240,4,170,160,15,96,104,104,32,40,199,76,111,204,174,1,0,0,79,219,32,153,205,162,9,181,66,72,202,16,250,186,189,12,1,133,70,189,11,1,133,69,160,3,177,69,153,65,0,254,11,1,208,3,254,12,1,136,208,240,140,248,4,140,120,5,140,248,5,170,201,10,176,40,189,135,200,209,67,208,36,160,8,177,67,153,67,0,136,208,248,74,208,17,174,120,7,164,66,169,200,72,185,125,200,72,70,68,165,71,96,169,17,44,169,1,44,169,4,141,248,4,162,0,104,149,66,232,224,10,144,248,172,248,5,174,120,5,173,248,4,208,1,24,96,202,163,181,144,156,144,147,147,152,150,3,3,3,1,3,1,1,1,4,4,76,102,200,76,94,200,176,44,176,24,144,247,240,242,169,33,76,99,200,144,238,32,12,201,176,29,173,19,192,6,75,10,102,75,76,35,201,144,220,32,12,201,176,11,173,20,192,6,75,10,102,75,76,130,201,76,125,201,176,19,208,208,160,8,140,120,5,136,145,69,208,251,169,1,145,69,76,102,200,240,7,160,25,201,3,208,183,44,160,4,140,120,5,136,185,198,201,192,2,208,14,174,248,7,189,184,5,74,145,69,136,189,56,6,106,145,69,136,16,230,76,102,200,10,133,74,165,72,42,176,14,133,75,165,73,201,1,176,6,133,71,169,2,133,72,96,32,100,201,176,85,44,20,192,8,10,144,3,141,5,192,165,72,141,248,5,240,14,189,251,191,145,69,200,208,248,230,70,198,72,208,242,165,71,240,13,141,120,5,189,251,191,145,69,200,196,71,208,246,141,4,192,40,16,3,141,5,192,76,102,200,165,73,157,248,191,165,74,157,249,191,165,75,41,127,157,250,191,32,157,202,160,0,165,75,96,169,45,76,99,200,32,100,201,176,246,44,19,192,8,141,2,192,10,144,3,141,3,192,165,72,141,248,5,240,14,177,69,157,251,191,200,208,248,230,70,198,72,208,242,165,71,141,120,5,240,10,177,69,157,251,191,200,196,71,208,246,141,2,192,40,16,3,141,3,192,76,102,200,248,0,0,0,7,82,65,77,67,65,82,68,32,32,32,32,32,32,32,32,32,0,0,0,0,172,248,7,32,142,202,189,251,191,201,174,208,69,93,251,191,201,90,208,62,189,251,191,153,56,4,73,90,221,251,191,208,49,189,251,191,153,184,3,185,56,4,157,248,191,189,251,191,153,184,4,189,251,191,153,56,5,189,251,191,153,184,5,189,251,191,153,56,6,189,251,191,153,184,6,189,251,191,153,56,7,96,185,184,6,89,56,7,201,90,240,56,32,142,202,169,4,157,249,191,189,251,191,93,251,191,93,251,191,93,251,191,162,76,201,3,240,12,162,0,201,6,240,6,162,51,201,190,208,9,138,153,184,6,73,90,153,56,7,32,0,203,172,248,7,153,184,3,185,184,3,10,153,184,5,169,0,153,56,6,153,56,5,153,184,4,169,1,153,56,4,96,174,120,7,169,0,157,248,191,157,249,191,157,250,191,96,32,142,202,172,248,7,185,184,3,201,9,189,250,191,176,2,41,15,72,208,30,185,56,4,201,8,208,23,189,249,191,201,2,176,16,9,254,157,249,191,185,184,3,233,0,42,157,250,191,104,96,189,249,191,217,56,6,104,72,249,184,5,176,241,189,249,191,121,56,5,157,249,191,104,121,184,4,157,250,191,96,160,0,189,251,191,153,0,8,200,208,247,189,251,191,153,0,9,200,208,247,96,32,139,202,168,221,250,191,208,2,160,2,25,149,203,133,63,133,62,157,250,191,189,251,191,222,248,191,72,165,63,157,251,191,222,248,191,57,149,203,240,20,165,63,56,249,152,203,76,14,203,24,165,63,121,152,203,133,63,157,250,191,189,251,191,197,63,208,63,73,255,222,248,191,157,251,191,222,248,191,221,251,191,208,47,222,248,191,165,63,57,149,203,217,149,203,208,209,165,62,157,250,191,104,157,251,191,222,248,191,24,165,62,121,152,203,133,62,57,149,203,208,231,165,63,136,16,140,74,105,2,96,222,248,191,56,165,63,240,214,249,152,203,133,63,76,97,203,234,234,12,48,192,4,16,64,162,4,160,0,169,0,72,56,165,62,253,222,203,72,165,63,253,227,203,144,10,133,63,104,133,62,104,105,0,208,231,104,104,208,8,136,16,5,138,240,2,169,16,200,73,176,32,237,253,202,16,208,169,203,76,237,253,8,8,32,56,80,104,128,152,176,200,4,40,144,160,64,0,0,1,15,156,164,66,200,240,107,32,153,205,160,43,176,24,160,40,165,67,48,18,164,66,240,17,136,240,30,136,240,57,136,240,20,160,1,44,160,39,152,56,96,172,248,7,32,228,207,172,120,4,174,248,4,169,0,24,96,32,88,204,176,230,160,0,189,251,191,145,68,200,208,248,230,69,189,251,191,145,68,200,208,248,198,69,152,24,96,32,88,204,176,200,160,0,177,68,157,251,191,200,208,248,230,69,177,68,157,251,191,200,208,248,240,224,169,0,157,248,191,165,70,10,157,249,191,165,71,42,176,6,157,250,191,32,157,202,96,32,86,205,160,16,176,106,32,251,204,160,2,177,72,133,62,73,1,240,5,144,88,32,22,205,160,14,169,254,145,72,160,4,132,63,177,72,221,53,205,176,68,74,102,63,74,102,63,74,102,63,224,1,240,3,74,102,63,72,200,177,72,221,55,205,176,43,5,63,72,32,139,202,104,157,249,191,104,157,250,191,32,157,202,176,24,160,8,177,72,133,62,200,177,72,133,63,160,12,177,72,168,240,29,136,240,18,136,240,5,56,160,128,208,19,177,62,157,251,191,200,208,248,240,8,189,251,191,145,62,200,208,248,24,152,160,13,145,72,96,172,248,7,162,3,185,56,6,221,49,205,185,184,5,253,45,205,176,4,202,16,239,96,138,74,170,96,24,172,248,7,185,56,5,125,59,205,153,56,5,185,184,4,125,57,205,153,184,4,96,2,4,6,12,48,96,64,128,35,50,16,32,2,6,48,64,172,248,7,32,228,207,201,16,176,5,173,120,4,240,9,185,56,7,73,90,217,184,6,56,96,32,61,205,144,60,208,6,201,51,208,54,24,96,169,51,153,184,6,32,251,204,48,42,144,34,185,56,5,72,185,184,4,72,142,248,4,32,22,205,188,226,207,32,251,205,174,248,4,172,248,7,104,153,184,4,104,153,56,5,188,226,207,76,193,205,56,96,32,61,205,144,18,208,18,201,205,208,2,24,96,32,236,205,208,5,217,184,6,240,244,56,96,32,236,205,208,249,153,184,6,160,0,10,208,2,160,135,32,251,205,32,142,202,172,248,7,185,56,4,201,1,240,17,24,105,4,157,248,191,185,184,6,157,251,191,73,90,157,251,191,185,184,6,73,90,153,56,7,24,96,173,0,191,240,2,201,76,96,174,120,7,32,103,206,200,185,48,207,208,244,96,41,15,157,251,191,169,0,157,251,191,96,152,72,173,248,4,201,1,173,120,4,233,0,74,74,74,74,168,169,255,133,62,169,3,74,102,62,136,16,250,157,251,191,165,62,157,251,191,104,168,96,32,83,206,169,1,72,32,6,206,169,17,157,251,191,104,72,157,251,191,32,83,206,104,24,105,1,201,31,144,231,96,169,0,44,169,255,157,251,191,221,248,191,208,248,106,144,3,157,251,191,96,201,64,176,35,201,48,176,62,201,32,176,142,201,16,176,149,201,4,240,74,176,8,201,2,144,88,240,208,176,209,201,6,144,73,240,169,76,244,206,72,41,63,240,24,104,72,41,192,10,240,8,169,255,176,4,200,185,48,207,157,251,191,104,56,233,1,208,227,104,96,41,15,72,169,255,157,251,191,157,251,191,32,6,206,157,251,191,104,56,233,1,208,235,96,173,248,4,157,251,191,173,120,4,157,251,191,96,173,248,7,73,240,208,245,169,0,157,248,191,200,185,48,207,157,249,191,200,185,48,207,157,250,191,152,72,32,157,202,104,168,96,152,72,172,120,4,240,13,234,152,72,160,32,32,39,207,104,168,136,208,244,173,248,4,72,74,74,74,240,4,168,32,39,207,104,41,7,168,169,0,56,106,136,16,251,10,157,251,191,104,168,96,169,255,157,251,191,136,208,250,96,1,0,0,2,2,1,2,0,2,2,32,35,68,244,82,65,77,5,153,67,195,39,13,32,38,4,2,2,34,36,2,2,35,37,2,2,36,32,2,2,7,2,2,1,12,0,16,0,1,0,0,2,1,4,0,68,2,15,32,147,1,16,1,71,51,17,15,4,0,0,254,160,65,122,136,72,17,1,0,0,35,16,0,1,136,63,132,63,50,2,6,0,1,0,0,2,1,4,0,68,2,15,32,147,1,32,2,71,51,17,31,4,0,0,254,160,65,122,136,72,17,1,0,0,50,32,0,1,132,200,248,132,3,6,0,1,0,0,2,2,1,2,0,2,2,130,65,6,131,68,4,82,65,77,5,131,4,2,2,2,2,2,2,2,2,2,2,2,2,0,68,174,244,8,82,2,2,0,48,92,185,184,5,74,141,120,4,185,56,6,106,141,248,4,96,255,255,255,255,255,255,255,255,255,255,255,255,255,67,79,80,89,82,73,71,72,84,32,40,67,41,32,49,57,56,54,45,56,57,32,65,80,80,76,73,69,68,32,69,78,71,73,78,69,69,82,73,78,71,0,66,79,66,32,83,65,78,68,69,82,45,67,69,68,69,82,76,79,70,0,77,73,67,72,65,69,76,32,87,73,76,75,83,0,83,84,69,86,69,78,32,77,65,76,69,67,72,69,75,0,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,201,32,201,0,201,3,201,0,176,49,32,22,193,76,155,193,32,22,193,76,159,193,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,193,174,255,207,14,159,192,162,152,140,248,7,142,120,7,76,223,201,169,193,197,57,8,32,22,193,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,193,76,186,250,185,56,4,201,1,208,42,32,123,193,24,144,36,32,154,202,32,235,202,160,193,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,16,76,1,8,96,160,3,208,2,160,5,162,3,185,213,193,149,66,136,202,16,247,8,120,142,159,192,162,152,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,159,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,193,76,0,200,32,40,193,76,232,203,201,16,240,4,170,160,15,96,104,104,32,40,193,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,194,76,155,194,32,22,194,76,159,194,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,194,174,255,207,14,175,192,162,168,140,248,7,142,120,7,76,223,201,169,194,197,57,8,32,22,194,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,194,76,186,250,185,56,4,201,1,208,42,32,123,194,24,144,36,32,154,202,32,235,202,160,194,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,32,76,1,8,96,160,3,208,2,160,5,162,3,185,213,194,149,66,136,202,16,247,8,120,142,175,192,162,168,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,175,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,194,76,0,200,32,40,194,76,232,203,201,32,240,4,170,160,15,96,104,104,32,40,194,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,195,76,155,195,32,22,195,76,159,195,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,195,174,255,207,14,191,192,162,184,140,248,7,142,120,7,76,223,201,169,195,197,57,8,32,22,195,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,195,76,186,250,185,56,4,201,1,208,42,32,123,195,24,144,36,32,154,202,32,235,202,160,195,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,48,76,1,8,96,160,3,208,2,160,5,162,3,185,213,195,149,66,136,202,16,247,8,120,142,191,192,162,184,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,191,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,195,76,0,200,32,40,195,76,232,203,201,48,240,4,170,160,15,96,104,104,32,40,195,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,196,76,155,196,32,22,196,76,159,196,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,196,174,255,207,14,207,192,162,200,140,248,7,142,120,7,76,223,201,169,196,197,57,8,32,22,196,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,196,76,186,250,185,56,4,201,1,208,42,32,123,196,24,144,36,32,154,202,32,235,202,160,196,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,64,76,1,8,96,160,3,208,2,160,5,162,3,185,213,196,149,66,136,202,16,247,8,120,142,207,192,162,200,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,207,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,196,76,0,200,32,40,196,76,232,203,201,64,240,4,170,160,15,96,104,104,32,40,196,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,197,76,155,197,32,22,197,76,159,197,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,197,174,255,207,14,223,192,162,216,140,248,7,142,120,7,76,223,201,169,197,197,57,8,32,22,197,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,197,76,186,250,185,56,4,201,1,208,42,32,123,197,24,144,36,32,154,202,32,235,202,160,197,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,80,76,1,8,96,160,3,208,2,160,5,162,3,185,213,197,149,66,136,202,16,247,8,120,142,223,192,162,216,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,223,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,197,76,0,200,32,40,197,76,232,203,201,80,240,4,170,160,15,96,104,104,32,40,197,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,198,76,155,198,32,22,198,76,159,198,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,198,174,255,207,14,239,192,162,232,140,248,7,142,120,7,76,223,201,169,198,197,57,8,32,22,198,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,198,76,186,250,185,56,4,201,1,208,42,32,123,198,24,144,36,32,154,202,32,235,202,160,198,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,96,76,1,8,96,160,3,208,2,160,5,162,3,185,213,198,149,66,136,202,16,247,8,120,142,239,192,162,232,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,239,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,198,76,0,200,32,40,198,76,232,203,201,96,240,4,170,160,15,96,104,104,32,40,198,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,199,76,155,199,32,22,199,76,159,199,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,199,174,255,207,14,255,192,162,248,140,248,7,142,120,7,76,223,201,169,199,197,57,8,32,22,199,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,199,76,186,250,185,56,4,201,1,208,42,32,123,199,24,144,36,32,154,202,32,235,202,160,199,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,112,76,1,8,96,160,3,208,2,160,5,162,3,185,213,199,149,66,136,202,16,247,8,120,142,255,192,162,248,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,255,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,199,76,0,200,32,40,199,76,232,203,201,112,240,4,170,160,15,96,104,104,32,40,199,76,111,204,174,1,0,0,79,219,142,43,13,32,88,252,160,0,32,125,12,32,0,203,141,42,13,160,0,140,47,13,10,144,2,136,152,132,62,133,63,32,155,203,160,33,32,125,12,32,139,202,157,251,191,169,4,157,249,191,169,255,157,251,191,172,248,7,153,184,6,169,0,133,36,160,39,32,125,12,173,47,13,32,218,253,160,44,32,125,12,165,36,24,101,40,141,229,10,169,0,101,41,141,230,10,160,8,136,136,140,41,13,32,228,10,32,232,10,176,17,172,41,13,208,238,238,47,13,173,0,192,16,193,141,16,192,96,152,72,160,53,32,125,12,169,8,56,237,41,13,74,168,9,176,32,237,253,192,3,176,2,104,96,160,66,32,125,12,174,120,7,189,248,191,222,248,191,41,127,208,13,189,249,191,222,249,191,41,127,208,3,222,250,191,189,250,191,172,42,13,192,9,176,2,41,15,32,218,253,189,249,191,32,218,253,189,248,191,32,218,253,169,173,32,237,253,104,93,251,191,32,218,253,32,142,253,96,238,0,4,96,185,245,10,72,185,244,10,72,174,43,13,96,227,11,128,11,29,11,251,10,160,0,152,32,10,13,93,250,191,41,15,208,19,152,221,249,191,208,13,221,248,191,208,8,32,228,10,200,208,228,24,96,56,96,169,0,160,240,32,10,13,173,40,13,32,107,11,141,40,13,173,39,13,32,107,11,141,39,13,32,19,13,238,40,13,208,12,238,39,13,208,7,238,38,13,208,2,24,96,32,228,10,189,251,191,189,250,191,77,38,13,208,16,189,249,191,205,39,13,208,8,189,248,191,205,40,13,240,188,56,96,201,16,144,6,201,112,176,3,169,112,96,201,144,144,251,201,240,176,247,169,240,96,173,42,13,240,14,169,0,141,48,13,32,150,11,32,150,11,32,150,11,24,96,32,142,202,168,152,157,251,191,32,190,11,208,247,32,228,10,152,32,10,13,152,221,251,191,208,10,32,190,11,208,245,56,110,48,13,96,104,104,56,96,44,48,13,16,24,238,38,13,254,250,191,173,38,13,74,205,42,13,144,9,160,0,96,238,39,13,254,249,191,238,40,13,200,96,0,85,170,255,173,42,13,240,19,160,3,185,224,11,141,44,13,32,254,11,32,46,12,176,4,136,16,239,24,96,32,109,12,32,10,12,206,45,13,208,248,96,152,72,173,44,13,160,0,140,46,13,157,251,191,157,251,191,157,251,191,157,251,191,200,208,241,32,228,10,238,46,13,208,233,104,168,96,32,109,12,32,60,12,176,5,206,45,13,208,246,96,152,72,173,44,13,160,0,140,46,13,221,251,191,208,30,221,251,191,208,25,221,251,191,208,20,221,251,191,208,15,200,208,233,32,228,10,238,46,13,208,225,104,168,24,96,168,104,56,96,173,42,13,74,141,45,13,76,142,202,8,32,237,253,40,36,24,32,143,12,189,161,12,208,241,32,143,12,189,176,12,208,233,96,185,192,12,176,7,74,74,74,74,170,56,96,200,41,15,170,24,96,0,141,210,193,205,174,212,201,211,160,199,207,204,196,197,206,0,194,195,198,200,208,217,218,205,209,213,214,177,180,186,48,96,108,126,217,239,167,254,226,127,169,35,64,67,3,107,41,110,134,144,192,213,14,17,78,75,32,121,135,8,224,249,1,144,32,118,232,17,1,6,56,128,249,1,153,153,110,134,127,169,85,80,25,17,3,50,217,4,55,192,178,229,151,208,249,1,153,147,221,46,136,15,144,25,141,40,13,141,39,13,140,38,13,173,40,13,157,248,191,173,39,13,157,249,191,173,38,13,157,250,191,96,32,139,202,189,251,191,201,174,208,17,93,251,191,201,90,208,10,189,251,191,93,251,191,201,90,240,80,172,248,7,185,184,6,89,56,7,201,90,208,23,32,88,252,160,136,32,142,12,169,191,32,237,253,32,151,14,201,217,240,3,76,6,14,32,139,202,160,170,32,251,205,32,139,202,169,4,157,248,191,172,248,7,185,184,3,72,157,251,191,169,10,157,248,191,104,10,56,233,1,157,251,191,169,252,157,251,191,32,142,202,32,235,202,173,2,8,141,1,9,32,88,252,78,0,9,169,0,133,36,133,37,160,0,32,142,12,173,248,7,73,112,32,237,253,32,142,253,32,142,253,160,0,32,3,12,200,192,9,144,248,160,20,32,142,12,160,89,44,0,9,16,2,160,39,32,142,12,32,66,252,32,151,14,201,177,144,20,201,186,176,16,233,176,32,129,12,141,1,9,44,0,9,48,177,76,246,13,141,2,9,160,6,44,0,9,16,2,160,253,200,200,200,185,247,10,240,14,205,2,9,208,243,185,249,10,72,185,248,10,72,96,32,226,251,76,125,10,206,80,11,195,244,11,211,112,11,141,21,11,136,56,11,139,56,11,138,72,11,149,72,11,155,42,11,210,35,11,0,44,0,9,48,3,76,246,13,32,232,13,76,122,10,56,110,0,9,76,125,10,44,0,9,16,3,76,0,10,32,215,13,76,54,14,173,1,9,56,233,24,201,224,176,3,141,1,9,76,125,10,173,1,9,24,105,24,144,238,160,118,32,142,12,162,16,32,79,14,176,17,162,0,172,1,9,189,8,9,153,8,8,200,232,224,16,144,244,76,125,10,32,67,14,240,116,152,24,105,24,168,192,224,176,107,32,70,14,240,102,160,127,32,142,12,162,6,32,79,14,32,161,14,14,4,9,46,5,9,14,4,9,46,5,9,24,172,1,9,185,3,8,121,27,8,141,6,9,185,2,8,121,26,8,141,7,9,56,173,6,9,237,4,9,72,173,7,9,237,5,9,144,35,153,26,8,104,153,27,8,24,173,4,9,153,3,8,121,1,8,153,25,8,173,5,9,153,2,8,121,0,8,153,24,8,76,125,10,104,160,213,44,160,201,32,142,12,32,12,253,76,125,10,32,67,14,208,6,174,1,9,254,5,8,76,125,10,152,72,32,129,12,72,162,255,205,1,9,208,2,162,63,134,50,32,121,12,152,24,105,177,32,237,253,32,121,12,104,72,168,162,16,185,8,8,208,2,169,160,32,237,253,200,202,208,242,32,121,12,104,72,168,185,2,8,133,63,185,3,8,133,62,32,155,203,169,255,133,50,32,121,12,104,168,185,5,8,73,90,217,4,8,240,2,169,1,160,4,217,111,12,240,3,136,208,248,185,116,12,168,32,142,12,104,168,96,76,0,51,205,223,233,245,228,239,169,160,32,237,253,76,237,253,141,2,9,10,109,2,9,10,10,10,105,8,96,24,32,172,12,189,190,12,208,9,32,172,12,189,205,12,208,1,96,8,48,3,32,121,12,32,237,253,40,208,227,185,221,12,176,7,74,74,74,74,170,56,96,200,41,15,170,24,96,0,141,1,199,204,201,212,195,200,160,210,197,193,211,207,206,0,198,208,213,196,205,173,177,185,189,194,209,215,218,217,26,192,96,44,118,234,144,60,166,86,94,253,34,41,157,78,105,10,144,25,16,77,185,202,174,13,217,234,144,128,112,153,110,157,180,183,97,16,25,240,175,192,107,151,140,243,178,41,171,96,165,253,108,68,151,140,243,189,29,10,213,14,185,120,207,59,34,155,215,10,2,234,59,105,120,207,59,209,112,167,75,202,144,60,166,86,94,240,25,171,96,160,190,230,150,139,144,60,166,86,94,242,154,10,171,126,240,37,48,74,177,189,112,160,192,69,96,25,17,251,13,159,192,107,144,169,1,17,251,13,157,80,235,144,169,1,16,220,175,95,48,121,95,214,196,69,243,144,60,166,86,94,253,144,91,214,174,15,209,104,185,5,90,183,110,160,240,121,62,156,139,192,80,25,17,124,255,230,144,190,230,150,140,105,3,202,101,101,239,16,190,230,144,42,224,105,212,230,144,169,1,17,124,255,230,151,140,243,185,213,14,176,25,17,213,14,185,110,233,76,163,176,25,116,188,169,16,25,5,237,153,145,1,3,174,5,237,16,25,112,48,112,105,145,1,3,205,124,65,1,173,1,9,141,2,8,73,90,141,3,8,32,232,13,76,223,201,32,139,202,168,185,0,8,157,251,191,200,208,247,96,32,215,13,32,67,14,208,11,185,2,8,25,3,8,240,3,32,39,14,160,174,32,142,12,162,1,32,79,14,176,33,173,8,9,201,177,144,242,201,184,176,238,105,16,168,169,0,240,8,174,120,7,172,248,7,169,123,132,1,133,0,108,0,0,162,2,169,0,157,0,8,202,16,250,108,252,255,172,1,9,185,4,8,89,5,8,201,90,96,142,3,9,169,160,157,8,9,202,16,250,232,32,151,14,201,136,240,34,201,141,240,28,201,155,240,25,201,160,176,6,32,226,251,76,91,14,236,3,9,176,245,157,8,9,32,237,253,232,208,217,24,96,138,240,212,202,198,36,169,160,157,8,9,32,237,253,198,36,76,91,14,32,12,253,201,224,144,2,41,223,96,169,0,168,170,141,4,9,142,5,9,169,10,141,2,9,162,0,185,8,9,73,176,201,10,144,1,96,109,4,9,72,138,109,5,9,170,104,206,2,9,208,241,200,208,215,255,255,255,255,255,255,255,255,255,255,255,255]);class ds{constructor(e){this.firmware=0,this.ramlo=0,this.rammid=0,this.ramhi=0,this.loc=0,v("RAMFactor card"),this.mem=S(e);for(let t=0;t<e;t++)this.mem[t]=0}sethi(e){this.ramhi=255&e}setmid(e){0!=(128&this.rammid)&&0==(128&e)&&this.sethi(this.ramhi+1),this.rammid=255&e}setlo(e){0!=(128&this.ramlo)&&0==(128&e)&&this.setmid(this.rammid+1),this.ramlo=255&e}access(e,t){let s=0;switch(143&e){case 128:case 132:void 0!==t?this.setlo(t):s=this.ramlo;break;case 129:case 133:void 0!==t?this.setmid(t):s=this.rammid;break;case 130:case 134:void 0!==t?this.sethi(t):(s=this.ramhi,s|=240);break;case 131:case 135:void 0!==t?this.mem[this.loc%this.mem.length]=t:s=this.mem[this.loc%this.mem.length],this.setlo(this.ramlo+1);break;case 143:void 0!==t?this.firmware=1&t:s=this.firmware}return this.loc=this.ramhi<<16|this.rammid<<8|this.ramlo,s}ioSwitch(e,t){return this.access(e,t)}read(e,t){return hs[this.firmware<<12|e-192<<8|t]}write(){}reset(){this.firmware=0}getState(){return{loc:this.loc,firmware:this.firmware,mem:new Uint8Array(this.mem)}}setState(e){this.loc=e.loc,this.firmware=e.firmware,this.mem=new Uint8Array(e.mem),this.ramhi=this.loc>>16&255,this.rammid=this.loc>>8&255,this.ramlo=255&this.loc}}const cs=new Uint8Array([162,32,162,0,162,3,162,0,32,88,255,186,189,0,1,141,248,7,10,10,10,10,168,185,128,192,74,176,17,165,0,208,10,165,1,205,248,7,208,3,76,186,250,76,0,224,162,1,134,66,202,134,70,134,71,134,68,162,8,134,69,173,248,7,72,72,169,71,72,184,80,11,104,10,10,10,10,170,76,1,8,0,0,96,0,0,96,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,215,83]),ls={accumulator:1,implied:1,immediate:2,absolute:3,zeroPage:2,relative:2,absoluteX:3,absoluteY:3,zeroPageX:2,zeroPageY:2,absoluteIndirect:3,zeroPageXIndirect:2,zeroPageIndirectY:2,zeroPageIndirect:2,absoluteXIndirect:3,zeroPage_relative:3},ms=128,us=64,ps=16,gs={read:function(){return 0},write:function(){}};class fs{constructor(e={}){this.pc=0,this.sr=32,this.ar=0,this.xr=0,this.yr=0,this.sp=255,this.addr=0,this.memPages=new Array(256),this.resetHandlers=[],this.cycles=0,this.sync=!1,this.implied=()=>{this.readByte(this.pc)},this.readImmediate=()=>this.readBytePC(),this.readAbsolute=()=>this.readByte(this.readWordPC()),this.readZeroPage=()=>this.readByte(this.readBytePC()),this.readAbsoluteX=()=>{const e=this.readWordPC(),t=this.addr,s=e+this.xr&65535;return this.workCycleIndexedRead(t,e,s),this.readByte(s)},this.readAbsoluteY=()=>{const e=this.readWordPC(),t=this.addr,s=e+this.yr&65535;return this.workCycleIndexedRead(t,e,s),this.readByte(s)},this.readZeroPageX=()=>{const e=this.readBytePC();return this.readByte(e),this.readByte(e+this.xr&255)},this.readZeroPageY=()=>{const e=this.readBytePC();return this.readByte(e),this.readByte(e+this.yr&255)},this.readZeroPageXIndirect=()=>{const e=this.readBytePC();this.readByte(e);const t=this.readZPWord(e+this.xr&255);return this.readByte(t)},this.readZeroPageIndirectY=()=>{const e=this.readBytePC(),t=this.addr,s=this.readZPWord(e),i=s+this.yr&65535;return this.workCycleIndexedRead(t,s,i),this.readByte(i)},this.readZeroPageIndirect=()=>this.readByte(this.readZPWord(this.readBytePC())),this.writeAbsolute=e=>{this.writeByte(this.readWordPC(),e)},this.writeZeroPage=e=>{this.writeByte(this.readBytePC(),e)},this.writeAbsoluteX=e=>{const t=this.readWordPC(),s=this.addr,i=t+this.xr&65535;this.workCycleIndexedWrite(s,t,i),this.writeByte(i,e)},this.writeAbsoluteY=e=>{const t=this.readWordPC(),s=this.addr,i=t+this.yr&65535;this.workCycleIndexedWrite(s,t,i),this.writeByte(i,e)},this.writeZeroPageX=e=>{const t=this.readBytePC();this.readByte(t),this.writeByte(t+this.xr&255,e)},this.writeZeroPageY=e=>{const t=this.readBytePC();this.readByte(t),this.writeByte(t+this.yr&255,e)},this.writeZeroPageXIndirect=e=>{const t=this.readBytePC();this.readByte(t);const s=this.readZPWord(t+this.xr&255);this.writeByte(s,e)},this.writeZeroPageIndirectY=e=>{const t=this.readBytePC(),s=this.addr,i=this.readZPWord(t),r=i+this.yr&65535;this.workCycleIndexedWrite(s,i,r),this.writeByte(r,e)},this.writeZeroPageIndirect=e=>{this.writeByte(this.readZPWord(this.readBytePC()),e)},this.readAddrZeroPage=()=>this.readBytePC(),this.readAddrZeroPageX=()=>{const e=this.readBytePC();return this.readByte(e),e+this.xr&255},this.readAddrAbsolute=()=>this.readWordPC(),this.readAddrAbsoluteIndirectBug=()=>{const e=this.readWordPC(),t=65280&e,s=255&e,i=this.readByte(e);return this.readByte(t|s+1&255)<<8|i},this.readAddrAbsoluteIndirect=()=>{const e=this.readWord(this.readWordPC());return this.readByte(this.addr),e},this.readAddrAbsoluteX=e=>{let t=this.readWordPC();const s=65280&t;if(t=t+this.xr&65535,this.is65C02)((null==e?void 0:e.inc)||s!==(65280&t))&&this.readByte(this.addr);else{const e=255&t;this.readByte(s|e)}return t},this.readAddrAbsoluteXIndirect=()=>{const e=this.readBytePC(),t=this.addr,s=(this.readBytePC()<<8|e)+this.xr&65535;return this.readByte(t),this.readWord(s)},this.readNop=()=>{this.readWordPC(),this.readByte(this.addr)},this.brk=e=>{e(),this.pushWord(this.pc),this.pushByte(this.sr|ps),this.is65C02&&this.setFlag(8,!1),this.setFlag(4,!0),this.pc=this.readWord(65534)},this.lda=e=>{this.ar=this.testNZ(e())},this.ldx=e=>{this.xr=this.testNZ(e())},this.ldy=e=>{this.yr=this.testNZ(e())},this.sta=e=>{e(this.ar)},this.stx=e=>{e(this.xr)},this.sty=e=>{e(this.yr)},this.stz=e=>{e(0)},this.adc=e=>{this.ar=this.add(this.ar,e(),!1)},this.sbc=e=>{this.ar=this.add(this.ar,255^e(),!0)},this.incA=()=>{this.readByte(this.pc),this.ar=this.increment(this.ar)},this.inc=e=>{const t=e({inc:!0}),s=this.readByte(t);this.workCycle(t,s);const i=this.increment(s);this.writeByte(t,i)},this.inx=()=>{this.readByte(this.pc),this.xr=this.increment(this.xr)},this.iny=()=>{this.readByte(this.pc),this.yr=this.increment(this.yr)},this.decA=()=>{this.readByte(this.pc),this.ar=this.decrement(this.ar)},this.dec=e=>{const t=e({inc:!0}),s=this.readByte(t);this.workCycle(t,s);const i=this.decrement(s);this.writeByte(t,i)},this.dex=()=>{this.readByte(this.pc),this.xr=this.decrement(this.xr)},this.dey=()=>{this.readByte(this.pc),this.yr=this.decrement(this.yr)},this.shiftLeft=e=>(this.setFlag(1,!!(128&e)),this.testNZ(e<<1&255)),this.aslA=()=>{this.readByte(this.pc),this.ar=this.shiftLeft(this.ar)},this.asl=e=>{const t=e(),s=this.readByte(t);this.workCycle(t,s);const i=this.shiftLeft(s);this.writeByte(t,i)},this.shiftRight=e=>(this.setFlag(1,!!(1&e)),this.testNZ(e>>1)),this.lsrA=()=>{this.readByte(this.pc),this.ar=this.shiftRight(this.ar)},this.lsr=e=>{const t=e(),s=this.readByte(t);this.workCycle(t,s);const i=this.shiftRight(s);this.writeByte(t,i)},this.rotateLeft=e=>{const t=1&this.sr;return this.setFlag(1,!!(128&e)),this.testNZ(255&(e<<1|(t?1:0)))},this.rolA=()=>{this.readByte(this.pc),this.ar=this.rotateLeft(this.ar)},this.rol=e=>{const t=e(),s=this.readByte(t);this.workCycle(t,s);const i=this.rotateLeft(s);this.writeByte(t,i)},this.rorA=()=>{this.readByte(this.pc),this.ar=this.rotateRight(this.ar)},this.ror=e=>{const t=e(),s=this.readByte(t);this.workCycle(t,s);const i=this.rotateRight(s);this.writeByte(t,i)},this.and=e=>{this.ar=this.testNZ(this.ar&e())},this.ora=e=>{this.ar=this.testNZ(this.ar|e())},this.eor=e=>{this.ar=this.testNZ(this.ar^e())},this.rmb=e=>{const t=1<<e^255,s=this.readBytePC();let i=this.readByte(s);this.readByte(s),i&=t,this.writeByte(s,i)},this.smb=e=>{const t=1<<e,s=this.readBytePC();let i=this.readByte(s);this.readByte(s),i|=t,this.writeByte(s,i)},this.trb=e=>{const t=e(),s=this.readByte(t);this.testZ(s&this.ar),this.readByte(t),this.writeByte(t,s&~this.ar)},this.tsb=e=>{const t=e(),s=this.readByte(t);this.testZ(s&this.ar),this.readByte(t),this.writeByte(t,s|this.ar)},this.bit=e=>{const t=e();this.setFlag(2,0==(t&this.ar)),this.setFlag(ms,!!(128&t)),this.setFlag(us,!!(64&t))},this.bitI=e=>{const t=e();this.setFlag(2,0==(t&this.ar))},this.cmp=e=>{this.compare(this.ar,e())},this.cpx=e=>{this.compare(this.xr,e())},this.cpy=e=>{this.compare(this.yr,e())},this.brs=e=>{const t=this.readBytePC();if(0!=(e&this.sr)){this.readByte(this.pc);const e=65280&this.pc;this.pc+=t>127?t-256:t,this.pc&=65535;const s=65280&this.pc,i=255&this.pc;s!==e&&this.readByte(e|i)}},this.brc=e=>{const t=this.readBytePC();if(0==(e&this.sr)){this.readByte(this.pc);const e=65280&this.pc;this.pc+=t>127?t-256:t,this.pc&=65535;const s=65280&this.pc,i=255&this.pc;s!==e&&this.readByte(e|i)}},this.bbr=e=>{const t=this.readBytePC(),s=this.readByte(t);this.writeByte(t,s);const i=this.readBytePC(),r=65280&this.pc;let a=this.pc+(i>127?i-256:i);a&=65535;const o=255&a;this.readByte(r|o),0==(1<<e&s)&&(this.pc=a)},this.bbs=e=>{const t=this.readBytePC(),s=this.readByte(t);this.writeByte(t,s);const i=this.readBytePC(),r=65280&this.pc;let a=this.pc+(i>127?i-256:i);a&=65535;const o=255&a;this.readByte(r|o),0!=(1<<e&s)&&(this.pc=a)},this.tax=()=>{this.readByte(this.pc),this.testNZ(this.xr=this.ar)},this.txa=()=>{this.readByte(this.pc),this.testNZ(this.ar=this.xr)},this.tay=()=>{this.readByte(this.pc),this.testNZ(this.yr=this.ar)},this.tya=()=>{this.readByte(this.pc),this.testNZ(this.ar=this.yr)},this.tsx=()=>{this.readByte(this.pc),this.testNZ(this.xr=this.sp)},this.txs=()=>{this.readByte(this.pc),this.sp=this.xr},this.pha=()=>{this.readByte(this.pc),this.pushByte(this.ar)},this.pla=()=>{this.readByte(this.pc),this.readByte(256|this.sp),this.testNZ(this.ar=this.pullByte())},this.phx=()=>{this.readByte(this.pc),this.pushByte(this.xr)},this.plx=()=>{this.readByte(this.pc),this.readByte(256|this.sp),this.testNZ(this.xr=this.pullByte())},this.phy=()=>{this.readByte(this.pc),this.pushByte(this.yr)},this.ply=()=>{this.readByte(this.pc),this.readByte(256|this.sp),this.testNZ(this.yr=this.pullByte())},this.php=()=>{this.readByte(this.pc),this.pushByte(this.sr|ps)},this.plp=()=>{this.readByte(this.pc),this.readByte(256|this.sp),this.sr=-17&this.pullByte()|32},this.jmp=e=>{this.pc=e()},this.jsr=()=>{const e=this.readBytePC();this.readByte(256|this.sp),this.pushWord(this.pc);const t=this.readBytePC();this.pc=65535&(t<<8|e)},this.rts=()=>{this.readByte(this.pc),this.readByte(256|this.sp);const e=this.pullWordRaw();this.readByte(e),this.pc=e+1&65535},this.rti=()=>{this.readByte(this.pc),this.readByte(256|this.sp),this.sr=-17&this.pullByte()|32,this.pc=this.pullWordRaw()},this.set=e=>{this.readByte(this.pc),this.sr|=e},this.clr=e=>{this.readByte(this.pc),this.sr&=~e},this.nop=e=>{e()},this.OPS_6502={169:{name:"LDA",op:this.lda,modeFn:this.readImmediate,mode:"immediate"},165:{name:"LDA",op:this.lda,modeFn:this.readZeroPage,mode:"zeroPage"},181:{name:"LDA",op:this.lda,modeFn:this.readZeroPageX,mode:"zeroPageX"},173:{name:"LDA",op:this.lda,modeFn:this.readAbsolute,mode:"absolute"},189:{name:"LDA",op:this.lda,modeFn:this.readAbsoluteX,mode:"absoluteX"},185:{name:"LDA",op:this.lda,modeFn:this.readAbsoluteY,mode:"absoluteY"},161:{name:"LDA",op:this.lda,modeFn:this.readZeroPageXIndirect,mode:"zeroPageXIndirect"},177:{name:"LDA",op:this.lda,modeFn:this.readZeroPageIndirectY,mode:"zeroPageIndirectY"},162:{name:"LDX",op:this.ldx,modeFn:this.readImmediate,mode:"immediate"},166:{name:"LDX",op:this.ldx,modeFn:this.readZeroPage,mode:"zeroPage"},182:{name:"LDX",op:this.ldx,modeFn:this.readZeroPageY,mode:"zeroPageY"},174:{name:"LDX",op:this.ldx,modeFn:this.readAbsolute,mode:"absolute"},190:{name:"LDX",op:this.ldx,modeFn:this.readAbsoluteY,mode:"absoluteY"},160:{name:"LDY",op:this.ldy,modeFn:this.readImmediate,mode:"immediate"},164:{name:"LDY",op:this.ldy,modeFn:this.readZeroPage,mode:"zeroPage"},180:{name:"LDY",op:this.ldy,modeFn:this.readZeroPageX,mode:"zeroPageX"},172:{name:"LDY",op:this.ldy,modeFn:this.readAbsolute,mode:"absolute"},188:{name:"LDY",op:this.ldy,modeFn:this.readAbsoluteX,mode:"absoluteX"},133:{name:"STA",op:this.sta,modeFn:this.writeZeroPage,mode:"zeroPage"},149:{name:"STA",op:this.sta,modeFn:this.writeZeroPageX,mode:"zeroPageX"},141:{name:"STA",op:this.sta,modeFn:this.writeAbsolute,mode:"absolute"},157:{name:"STA",op:this.sta,modeFn:this.writeAbsoluteX,mode:"absoluteX"},153:{name:"STA",op:this.sta,modeFn:this.writeAbsoluteY,mode:"absoluteY"},129:{name:"STA",op:this.sta,modeFn:this.writeZeroPageXIndirect,mode:"zeroPageXIndirect"},145:{name:"STA",op:this.sta,modeFn:this.writeZeroPageIndirectY,mode:"zeroPageIndirectY"},134:{name:"STX",op:this.stx,modeFn:this.writeZeroPage,mode:"zeroPage"},150:{name:"STX",op:this.stx,modeFn:this.writeZeroPageY,mode:"zeroPageY"},142:{name:"STX",op:this.stx,modeFn:this.writeAbsolute,mode:"absolute"},132:{name:"STY",op:this.sty,modeFn:this.writeZeroPage,mode:"zeroPage"},148:{name:"STY",op:this.sty,modeFn:this.writeZeroPageX,mode:"zeroPageX"},140:{name:"STY",op:this.sty,modeFn:this.writeAbsolute,mode:"absolute"},105:{name:"ADC",op:this.adc,modeFn:this.readImmediate,mode:"immediate"},101:{name:"ADC",op:this.adc,modeFn:this.readZeroPage,mode:"zeroPage"},117:{name:"ADC",op:this.adc,modeFn:this.readZeroPageX,mode:"zeroPageX"},109:{name:"ADC",op:this.adc,modeFn:this.readAbsolute,mode:"absolute"},125:{name:"ADC",op:this.adc,modeFn:this.readAbsoluteX,mode:"absoluteX"},121:{name:"ADC",op:this.adc,modeFn:this.readAbsoluteY,mode:"absoluteY"},97:{name:"ADC",op:this.adc,modeFn:this.readZeroPageXIndirect,mode:"zeroPageXIndirect"},113:{name:"ADC",op:this.adc,modeFn:this.readZeroPageIndirectY,mode:"zeroPageIndirectY"},233:{name:"SBC",op:this.sbc,modeFn:this.readImmediate,mode:"immediate"},229:{name:"SBC",op:this.sbc,modeFn:this.readZeroPage,mode:"zeroPage"},245:{name:"SBC",op:this.sbc,modeFn:this.readZeroPageX,mode:"zeroPageX"},237:{name:"SBC",op:this.sbc,modeFn:this.readAbsolute,mode:"absolute"},253:{name:"SBC",op:this.sbc,modeFn:this.readAbsoluteX,mode:"absoluteX"},249:{name:"SBC",op:this.sbc,modeFn:this.readAbsoluteY,mode:"absoluteY"},225:{name:"SBC",op:this.sbc,modeFn:this.readZeroPageXIndirect,mode:"zeroPageXIndirect"},241:{name:"SBC",op:this.sbc,modeFn:this.readZeroPageIndirectY,mode:"zeroPageIndirectY"},230:{name:"INC",op:this.inc,modeFn:this.readAddrZeroPage,mode:"zeroPage"},246:{name:"INC",op:this.inc,modeFn:this.readAddrZeroPageX,mode:"zeroPageX"},238:{name:"INC",op:this.inc,modeFn:this.readAddrAbsolute,mode:"absolute"},254:{name:"INC",op:this.inc,modeFn:this.readAddrAbsoluteX,mode:"absoluteX"},232:{name:"INX",op:this.inx,modeFn:this.implied,mode:"implied"},200:{name:"INY",op:this.iny,modeFn:this.implied,mode:"implied"},198:{name:"DEC",op:this.dec,modeFn:this.readAddrZeroPage,mode:"zeroPage"},214:{name:"DEC",op:this.dec,modeFn:this.readAddrZeroPageX,mode:"zeroPageX"},206:{name:"DEC",op:this.dec,modeFn:this.readAddrAbsolute,mode:"absolute"},222:{name:"DEC",op:this.dec,modeFn:this.readAddrAbsoluteX,mode:"absoluteX"},202:{name:"DEX",op:this.dex,modeFn:this.implied,mode:"implied"},136:{name:"DEY",op:this.dey,modeFn:this.implied,mode:"implied"},10:{name:"ASL",op:this.aslA,modeFn:this.implied,mode:"accumulator"},6:{name:"ASL",op:this.asl,modeFn:this.readAddrZeroPage,mode:"zeroPage"},22:{name:"ASL",op:this.asl,modeFn:this.readAddrZeroPageX,mode:"zeroPageX"},14:{name:"ASL",op:this.asl,modeFn:this.readAddrAbsolute,mode:"absolute"},30:{name:"ASL",op:this.asl,modeFn:this.readAddrAbsoluteX,mode:"absoluteX"},74:{name:"LSR",op:this.lsrA,modeFn:this.implied,mode:"accumulator"},70:{name:"LSR",op:this.lsr,modeFn:this.readAddrZeroPage,mode:"zeroPage"},86:{name:"LSR",op:this.lsr,modeFn:this.readAddrZeroPageX,mode:"zeroPageX"},78:{name:"LSR",op:this.lsr,modeFn:this.readAddrAbsolute,mode:"absolute"},94:{name:"LSR",op:this.lsr,modeFn:this.readAddrAbsoluteX,mode:"absoluteX"},42:{name:"ROL",op:this.rolA,modeFn:this.implied,mode:"accumulator"},38:{name:"ROL",op:this.rol,modeFn:this.readAddrZeroPage,mode:"zeroPage"},54:{name:"ROL",op:this.rol,modeFn:this.readAddrZeroPageX,mode:"zeroPageX"},46:{name:"ROL",op:this.rol,modeFn:this.readAddrAbsolute,mode:"absolute"},62:{name:"ROL",op:this.rol,modeFn:this.readAddrAbsoluteX,mode:"absoluteX"},106:{name:"ROR",op:this.rorA,modeFn:this.implied,mode:"accumulator"},102:{name:"ROR",op:this.ror,modeFn:this.readAddrZeroPage,mode:"zeroPage"},118:{name:"ROR",op:this.ror,modeFn:this.readAddrZeroPageX,mode:"zeroPageX"},110:{name:"ROR",op:this.ror,modeFn:this.readAddrAbsolute,mode:"absolute"},126:{name:"ROR",op:this.ror,modeFn:this.readAddrAbsoluteX,mode:"absoluteX"},41:{name:"AND",op:this.and,modeFn:this.readImmediate,mode:"immediate"},37:{name:"AND",op:this.and,modeFn:this.readZeroPage,mode:"zeroPage"},53:{name:"AND",op:this.and,modeFn:this.readZeroPageX,mode:"zeroPageX"},45:{name:"AND",op:this.and,modeFn:this.readAbsolute,mode:"absolute"},61:{name:"AND",op:this.and,modeFn:this.readAbsoluteX,mode:"absoluteX"},57:{name:"AND",op:this.and,modeFn:this.readAbsoluteY,mode:"absoluteY"},33:{name:"AND",op:this.and,modeFn:this.readZeroPageXIndirect,mode:"zeroPageXIndirect"},49:{name:"AND",op:this.and,modeFn:this.readZeroPageIndirectY,mode:"zeroPageIndirectY"},9:{name:"ORA",op:this.ora,modeFn:this.readImmediate,mode:"immediate"},5:{name:"ORA",op:this.ora,modeFn:this.readZeroPage,mode:"zeroPage"},21:{name:"ORA",op:this.ora,modeFn:this.readZeroPageX,mode:"zeroPageX"},13:{name:"ORA",op:this.ora,modeFn:this.readAbsolute,mode:"absolute"},29:{name:"ORA",op:this.ora,modeFn:this.readAbsoluteX,mode:"absoluteX"},25:{name:"ORA",op:this.ora,modeFn:this.readAbsoluteY,mode:"absoluteY"},1:{name:"ORA",op:this.ora,modeFn:this.readZeroPageXIndirect,mode:"zeroPageXIndirect"},17:{name:"ORA",op:this.ora,modeFn:this.readZeroPageIndirectY,mode:"zeroPageIndirectY"},73:{name:"EOR",op:this.eor,modeFn:this.readImmediate,mode:"immediate"},69:{name:"EOR",op:this.eor,modeFn:this.readZeroPage,mode:"zeroPage"},85:{name:"EOR",op:this.eor,modeFn:this.readZeroPageX,mode:"zeroPageX"},77:{name:"EOR",op:this.eor,modeFn:this.readAbsolute,mode:"absolute"},93:{name:"EOR",op:this.eor,modeFn:this.readAbsoluteX,mode:"absoluteX"},89:{name:"EOR",op:this.eor,modeFn:this.readAbsoluteY,mode:"absoluteY"},65:{name:"EOR",op:this.eor,modeFn:this.readZeroPageXIndirect,mode:"zeroPageXIndirect"},81:{name:"EOR",op:this.eor,modeFn:this.readZeroPageIndirectY,mode:"zeroPageIndirectY"},201:{name:"CMP",op:this.cmp,modeFn:this.readImmediate,mode:"immediate"},197:{name:"CMP",op:this.cmp,modeFn:this.readZeroPage,mode:"zeroPage"},213:{name:"CMP",op:this.cmp,modeFn:this.readZeroPageX,mode:"zeroPageX"},205:{name:"CMP",op:this.cmp,modeFn:this.readAbsolute,mode:"absolute"},221:{name:"CMP",op:this.cmp,modeFn:this.readAbsoluteX,mode:"absoluteX"},217:{name:"CMP",op:this.cmp,modeFn:this.readAbsoluteY,mode:"absoluteY"},193:{name:"CMP",op:this.cmp,modeFn:this.readZeroPageXIndirect,mode:"zeroPageXIndirect"},209:{name:"CMP",op:this.cmp,modeFn:this.readZeroPageIndirectY,mode:"zeroPageIndirectY"},224:{name:"CPX",op:this.cpx,modeFn:this.readImmediate,mode:"immediate"},228:{name:"CPX",op:this.cpx,modeFn:this.readZeroPage,mode:"zeroPage"},236:{name:"CPX",op:this.cpx,modeFn:this.readAbsolute,mode:"absolute"},192:{name:"CPY",op:this.cpy,modeFn:this.readImmediate,mode:"immediate"},196:{name:"CPY",op:this.cpy,modeFn:this.readZeroPage,mode:"zeroPage"},204:{name:"CPY",op:this.cpy,modeFn:this.readAbsolute,mode:"absolute"},36:{name:"BIT",op:this.bit,modeFn:this.readZeroPage,mode:"zeroPage"},44:{name:"BIT",op:this.bit,modeFn:this.readAbsolute,mode:"absolute"},144:{name:"BCC",op:this.brc,modeFn:1,mode:"relative"},176:{name:"BCS",op:this.brs,modeFn:1,mode:"relative"},240:{name:"BEQ",op:this.brs,modeFn:2,mode:"relative"},48:{name:"BMI",op:this.brs,modeFn:ms,mode:"relative"},208:{name:"BNE",op:this.brc,modeFn:2,mode:"relative"},16:{name:"BPL",op:this.brc,modeFn:ms,mode:"relative"},80:{name:"BVC",op:this.brc,modeFn:us,mode:"relative"},112:{name:"BVS",op:this.brs,modeFn:us,mode:"relative"},170:{name:"TAX",op:this.tax,modeFn:this.implied,mode:"implied"},138:{name:"TXA",op:this.txa,modeFn:this.implied,mode:"implied"},168:{name:"TAY",op:this.tay,modeFn:this.implied,mode:"implied"},152:{name:"TYA",op:this.tya,modeFn:this.implied,mode:"implied"},186:{name:"TSX",op:this.tsx,modeFn:this.implied,mode:"implied"},154:{name:"TXS",op:this.txs,modeFn:this.implied,mode:"implied"},72:{name:"PHA",op:this.pha,modeFn:this.implied,mode:"implied"},104:{name:"PLA",op:this.pla,modeFn:this.implied,mode:"implied"},8:{name:"PHP",op:this.php,modeFn:this.implied,mode:"implied"},40:{name:"PLP",op:this.plp,modeFn:this.implied,mode:"implied"},76:{name:"JMP",op:this.jmp,modeFn:this.readAddrAbsolute,mode:"absolute"},108:{name:"JMP",op:this.jmp,modeFn:this.readAddrAbsoluteIndirectBug,mode:"absoluteIndirect"},32:{name:"JSR",op:this.jsr,modeFn:this.readAddrAbsolute,mode:"absolute"},96:{name:"RTS",op:this.rts,modeFn:this.implied,mode:"implied"},64:{name:"RTI",op:this.rti,modeFn:this.implied,mode:"implied"},56:{name:"SEC",op:this.set,modeFn:1,mode:"implied"},248:{name:"SED",op:this.set,modeFn:8,mode:"implied"},120:{name:"SEI",op:this.set,modeFn:4,mode:"implied"},24:{name:"CLC",op:this.clr,modeFn:1,mode:"implied"},216:{name:"CLD",op:this.clr,modeFn:8,mode:"implied"},88:{name:"CLI",op:this.clr,modeFn:4,mode:"implied"},184:{name:"CLV",op:this.clr,modeFn:us,mode:"implied"},234:{name:"NOP",op:this.nop,modeFn:this.implied,mode:"implied"},0:{name:"BRK",op:this.brk,modeFn:this.readImmediate,mode:"immediate"}},this.OPS_65C02={26:{name:"INC",op:this.incA,modeFn:this.implied,mode:"accumulator"},58:{name:"DEC",op:this.decA,modeFn:this.implied,mode:"accumulator"},18:{name:"ORA",op:this.ora,modeFn:this.readZeroPageIndirect,mode:"zeroPageIndirect"},50:{name:"AND",op:this.and,modeFn:this.readZeroPageIndirect,mode:"zeroPageIndirect"},82:{name:"EOR",op:this.eor,modeFn:this.readZeroPageIndirect,mode:"zeroPageIndirect"},114:{name:"ADC",op:this.adc,modeFn:this.readZeroPageIndirect,mode:"zeroPageIndirect"},146:{name:"STA",op:this.sta,modeFn:this.writeZeroPageIndirect,mode:"zeroPageIndirect"},178:{name:"LDA",op:this.lda,modeFn:this.readZeroPageIndirect,mode:"zeroPageIndirect"},210:{name:"CMP",op:this.cmp,modeFn:this.readZeroPageIndirect,mode:"zeroPageIndirect"},242:{name:"SBC",op:this.sbc,modeFn:this.readZeroPageIndirect,mode:"zeroPageIndirect"},52:{name:"BIT",op:this.bit,modeFn:this.readZeroPageX,mode:"zeroPageX"},60:{name:"BIT",op:this.bit,modeFn:this.readAbsoluteX,mode:"absoluteX"},137:{name:"BIT",op:this.bitI,modeFn:this.readImmediate,mode:"immediate"},108:{name:"JMP",op:this.jmp,modeFn:this.readAddrAbsoluteIndirect,mode:"absoluteIndirect"},124:{name:"JMP",op:this.jmp,modeFn:this.readAddrAbsoluteXIndirect,mode:"absoluteXIndirect"},15:{name:"BBR0",op:this.bbr,modeFn:0,mode:"zeroPage_relative"},31:{name:"BBR1",op:this.bbr,modeFn:1,mode:"zeroPage_relative"},47:{name:"BBR2",op:this.bbr,modeFn:2,mode:"zeroPage_relative"},63:{name:"BBR3",op:this.bbr,modeFn:3,mode:"zeroPage_relative"},79:{name:"BBR4",op:this.bbr,modeFn:4,mode:"zeroPage_relative"},95:{name:"BBR5",op:this.bbr,modeFn:5,mode:"zeroPage_relative"},111:{name:"BBR6",op:this.bbr,modeFn:6,mode:"zeroPage_relative"},127:{name:"BBR7",op:this.bbr,modeFn:7,mode:"zeroPage_relative"},143:{name:"BBS0",op:this.bbs,modeFn:0,mode:"zeroPage_relative"},159:{name:"BBS1",op:this.bbs,modeFn:1,mode:"zeroPage_relative"},175:{name:"BBS2",op:this.bbs,modeFn:2,mode:"zeroPage_relative"},191:{name:"BBS3",op:this.bbs,modeFn:3,mode:"zeroPage_relative"},207:{name:"BBS4",op:this.bbs,modeFn:4,mode:"zeroPage_relative"},223:{name:"BBS5",op:this.bbs,modeFn:5,mode:"zeroPage_relative"},239:{name:"BBS6",op:this.bbs,modeFn:6,mode:"zeroPage_relative"},255:{name:"BBS7",op:this.bbs,modeFn:7,mode:"zeroPage_relative"},128:{name:"BRA",op:this.brc,modeFn:0,mode:"relative"},2:{name:"NOP",op:this.nop,modeFn:this.readImmediate,mode:"immediate"},34:{name:"NOP",op:this.nop,modeFn:this.readImmediate,mode:"immediate"},66:{name:"NOP",op:this.nop,modeFn:this.readImmediate,mode:"immediate"},68:{name:"NOP",op:this.nop,modeFn:this.readZeroPage,mode:"immediate"},84:{name:"NOP",op:this.nop,modeFn:this.readZeroPageX,mode:"immediate"},98:{name:"NOP",op:this.nop,modeFn:this.readImmediate,mode:"immediate"},130:{name:"NOP",op:this.nop,modeFn:this.readImmediate,mode:"immediate"},194:{name:"NOP",op:this.nop,modeFn:this.readImmediate,mode:"immediate"},212:{name:"NOP",op:this.nop,modeFn:this.readZeroPageX,mode:"immediate"},226:{name:"NOP",op:this.nop,modeFn:this.readImmediate,mode:"immediate"},244:{name:"NOP",op:this.nop,modeFn:this.readZeroPageX,mode:"immediate"},92:{name:"NOP",op:this.nop,modeFn:this.readNop,mode:"absolute"},220:{name:"NOP",op:this.nop,modeFn:this.readNop,mode:"absolute"},252:{name:"NOP",op:this.nop,modeFn:this.readNop,mode:"absolute"},218:{name:"PHX",op:this.phx,modeFn:this.implied,mode:"implied"},90:{name:"PHY",op:this.phy,modeFn:this.implied,mode:"implied"},250:{name:"PLX",op:this.plx,modeFn:this.implied,mode:"implied"},122:{name:"PLY",op:this.ply,modeFn:this.implied,mode:"implied"},7:{name:"RMB0",op:this.rmb,modeFn:0,mode:"zeroPage"},23:{name:"RMB1",op:this.rmb,modeFn:1,mode:"zeroPage"},39:{name:"RMB2",op:this.rmb,modeFn:2,mode:"zeroPage"},55:{name:"RMB3",op:this.rmb,modeFn:3,mode:"zeroPage"},71:{name:"RMB4",op:this.rmb,modeFn:4,mode:"zeroPage"},87:{name:"RMB5",op:this.rmb,modeFn:5,mode:"zeroPage"},103:{name:"RMB6",op:this.rmb,modeFn:6,mode:"zeroPage"},119:{name:"RMB7",op:this.rmb,modeFn:7,mode:"zeroPage"},135:{name:"SMB0",op:this.smb,modeFn:0,mode:"zeroPage"},151:{name:"SMB1",op:this.smb,modeFn:1,mode:"zeroPage"},167:{name:"SMB2",op:this.smb,modeFn:2,mode:"zeroPage"},183:{name:"SMB3",op:this.smb,modeFn:3,mode:"zeroPage"},199:{name:"SMB4",op:this.smb,modeFn:4,mode:"zeroPage"},215:{name:"SMB5",op:this.smb,modeFn:5,mode:"zeroPage"},231:{name:"SMB6",op:this.smb,modeFn:6,mode:"zeroPage"},247:{name:"SMB7",op:this.smb,modeFn:7,mode:"zeroPage"},100:{name:"STZ",op:this.stz,modeFn:this.writeZeroPage,mode:"zeroPage"},116:{name:"STZ",op:this.stz,modeFn:this.writeZeroPageX,mode:"zeroPageX"},156:{name:"STZ",op:this.stz,modeFn:this.writeAbsolute,mode:"absolute"},158:{name:"STZ",op:this.stz,modeFn:this.writeAbsoluteX,mode:"absoluteX"},20:{name:"TRB",op:this.trb,modeFn:this.readAddrZeroPage,mode:"zeroPage"},28:{name:"TRB",op:this.trb,modeFn:this.readAddrAbsolute,mode:"absolute"},4:{name:"TSB",op:this.tsb,modeFn:this.readAddrZeroPage,mode:"zeroPage"},12:{name:"TSB",op:this.tsb,modeFn:this.readAddrAbsolute,mode:"absolute"}},this.is65C02=!!e["65C02"],this.memPages.fill(gs),this.memPages.fill(gs);let t=Object.assign({},this.OPS_6502);this.is65C02&&(t=Object.assign(Object.assign({},t),this.OPS_65C02));const s=new Array(256);for(let e=0;e<256;e++)s[e]=t[e]||this.unknown(e);this.opary=s}setFlag(e,t){this.sr=t?this.sr|e:this.sr&~e}testNZ(e){return this.sr=0===e?2|this.sr:-3&this.sr,this.sr=128&e?this.sr|ms:-129&this.sr,e}testZ(e){return this.sr=0===e?2|this.sr:-3&this.sr,e}add(e,t,s){const i=e>>7,r=t>>7,a=1&this.sr;let o,n,h,d,c;const l=s=>{d=(255&s)>>7,n=s>>8,c=!(e+t+a&255),h=i^r^d^n};return o=(15&e)+(15&t)+a,0!=(8&this.sr)?(s?(o<16&&(o=o-6&15),o+=(240&e)+(240&t),l(o),o<256&&(o+=160)):(o>9&&(o=16+(o+6&15)),o+=(240&e)+(240&t),l(o),o>=160&&(o+=96)),(e=>{if(this.is65C02){const t=255&e;d=t>>7,c=!t,"immediate"===this.op.mode?this.readByte(s?184:127):this.readByte(this.addr)}s||(n=e>>8)})(o)):(o+=(240&e)+(240&t),l(o)),o&=255,this.setFlag(ms,!!d),this.setFlag(us,!!h),this.setFlag(2,!!c),this.setFlag(1,!!n),o}increment(e){return this.testNZ(e+1&255)}decrement(e){return this.testNZ(e+255&255)}readBytePC(){const e=this.readByte(this.pc);return this.pc=this.pc+1&65535,e}readByte(e){this.addr=e;const t=e>>8,s=255&e,i=this.memPages[t].read(t,s);return this.cycles++,i}writeByte(e,t){this.addr=e;const s=e>>8,i=255&e;this.memPages[s].write(s,i,t),this.cycles++}readWord(e){return this.readByte(e)|this.readByte(e+1)<<8}readWordPC(){return this.readBytePC()|this.readBytePC()<<8}readZPWord(e){const t=this.readByte(255&e);return this.readByte(e+1&255)<<8|t}pushByte(e){this.writeByte(256|this.sp,e),this.sp=this.sp+255&255}pushWord(e){this.pushByte(e>>8),this.pushByte(255&e)}pullByte(){return this.sp=this.sp+1&255,this.readByte(256|this.sp)}pullWordRaw(){const e=this.pullByte();return this.pullByte()<<8|e}workCycle(e,t){this.is65C02?this.readByte(e):this.writeByte(e,t)}workCycleIndexedWrite(e,t,s){const i=65280&t;if(this.is65C02)this.readByte(e);else{const e=255&s;this.readByte(i|e)}}workCycleIndexedRead(e,t,s){const i=65280&t;if((65280&s)!==i)if(this.is65C02)this.readByte(e);else{const e=255&s;this.readByte(i|e)}}rotateRight(e){const t=1&this.sr;return this.setFlag(1,!!(1&e)),this.testNZ(e>>1|(t?128:0))}compare(e,t){const s=e+(t^=255)+1;this.setFlag(1,s>255),this.testNZ(255&s)}unknown(e){let t;if(this.is65C02)t={name:"NOP",op:this.nop,modeFn:this.implied,mode:"implied"};else{const s=this;t={name:"???",op:function(t){v("Unknown OpCode: "+T(e)+" at "+T(s.pc-1,4))},modeFn:this.implied,mode:"implied"}}return t}step(e){this.sync=!0,this.op=this.opary[this.readBytePC()],this.sync=!1,this.op.op(this.op.modeFn),null==e||e(this)}stepN(e,t){for(let s=0;s<e;s++)if(this.sync=!0,this.op=this.opary[this.readBytePC()],this.sync=!1,this.op.op(this.op.modeFn),null==t?void 0:t(this))return}stepCycles(e){const t=this.cycles+e;for(;this.cycles<t;)this.sync=!0,this.op=this.opary[this.readBytePC()],this.sync=!1,this.op.op(this.op.modeFn)}stepCyclesDebug(e,t){const s=this.cycles+e;for(;this.cycles<s;)if(this.sync=!0,this.op=this.opary[this.readBytePC()],this.sync=!1,this.op.op(this.op.modeFn),null==t?void 0:t(this))return}addPageHandler(e){for(let t=e.start();t<=e.end();t++)this.memPages[t]=e;void 0!==e.reset&&this.resetHandlers.push(e)}reset(){this.sr=32,this.sp=255,this.ar=0,this.yr=0,this.xr=0,this.pc=this.readWord(65532);for(let e=0;e<this.resetHandlers.length;e++)this.resetHandlers[e].reset()}irq(){0==(4&this.sr)&&(this.pushWord(this.pc),this.pushByte(-17&this.sr),this.is65C02&&this.setFlag(8,!1),this.setFlag(4,!0),this.pc=this.readWord(65534))}nmi(){this.pushWord(this.pc),this.pushByte(-17&this.sr),this.is65C02&&this.setFlag(8,!1),this.setFlag(4,!0),this.pc=this.readWord(65530)}getPC(){return this.pc}setPC(e){this.pc=e}getDebugInfo(){const e=this.read(this.pc),t=this.opary[e],s=ls[t.mode],i=new Array(s);i[0]=e;for(let e=1;e<s;e++)i[e]=this.read(this.pc+e);return{pc:this.pc,ar:this.ar,xr:this.xr,yr:this.yr,sr:this.sr,sp:this.sp,cmd:i}}getSync(){return this.sync}getCycles(){return this.cycles}getOpInfo(e){return this.opary[e]}getState(){return{a:this.ar,x:this.xr,y:this.yr,s:this.sr,pc:this.pc,sp:this.sp,cycles:this.cycles}}setState(e){this.ar=e.a,this.xr=e.x,this.yr=e.y,this.sr=e.s,this.pc=e.pc,this.sp=e.sp,this.cycles=e.cycles}read(e,t){let s,i;return void 0!==t?(s=e,i=t):(s=e>>8,i=255&e),this.memPages[s].read(s,i)}write(e,t,s){let i,r,a;void 0!==s?(i=e,r=t,a=s):(i=e>>8,r=255&e,a=t),this.memPages[i].write(i,r,a)}}class As{constructor(e,t,s){this.cpu=e,void 0===s?(this.lo=255&t,this.hi=t>>8):(this.lo=t,this.hi=s)}loByte(){return this.lo}hiByte(){return this.hi}inc(e){return new As(this.cpu,(this.hi<<8|this.lo)+e&65535)}readByte(){return this.cpu.read(this.hi,this.lo)}readWord(){const e=this.readByte();return this.inc(1).readByte()<<8|e}readAddress(){const e=this.readByte(),t=this.inc(1).readByte();return new As(this.cpu,e,t)}writeByte(e){this.cpu.write(this.hi,this.lo,e)}writeWord(e){this.writeByte(255&e),this.inc(1).writeByte(e>>8)}writeAddress(e){this.writeByte(e.loByte()),this.inc(1).writeByte(e.hiByte())}toString(){return"$"+T(this.hi)+T(this.lo)}}class bs{constructor(e,t){if(this.cpu=e,this.disks=[],null==t?void 0:t.block){const e=new Uint8Array(cs);e[7]=60,this.rom=e,v("DumbPort card")}else v("SmartPort card"),this.rom=cs}debug(...e){}dumpBlock(e,t){let s,i,r="";for(let a=0;a<32;a++){for(r+=T(a<<4,4)+": ",i=0;i<16;i++)s=this.disks[e].blocks[t][16*a+i],8==i&&(r+=" "),r+=T(s)+" ";for(r+="        ",i=0;i<16;i++)s=127&this.disks[e].blocks[t][16*a+i],8==i&&(r+=" "),r+=s>=32&&s<127?String.fromCharCode(s):".";r+="\n"}return r}getDeviceInfo(e,t){if(this.disks[t]){const s=this.disks[t].blocks.length;e.x=255&s,e.y=s>>8,e.a=0,e.s&=-2}else e.a=40,e.s|=1}readBlock(e,t,s,i){var r;if(this.debug("read drive="+t),this.debug("read buffer="+i),this.debug("read block=$"+T(s)),!(null===(r=this.disks[t])||void 0===r?void 0:r.blocks.length))return v("Drive",t,"is empty"),e.a=47,void(e.s|=1);for(let e=0;e<512;e++)i.writeByte(this.disks[t].blocks[s][e]),i=i.inc(1);e.a=0,e.s&=-2}writeBlock(e,t,s,i){var r;if(this.debug("write drive="+t),this.debug("write buffer="+i),this.debug("write block=$"+T(s)),!(null===(r=this.disks[t])||void 0===r?void 0:r.blocks.length))return v("Drive",t,"is empty"),e.a=47,void(e.s|=1);if(this.disks[t].readOnly)return v("Drive",t,"is write protected"),e.a=43,void(e.s|=1);for(let e=0;e<512;e++)this.disks[t].blocks[s][e]=i.readByte(),i=i.inc(1);e.a=0,e.s&=1}formatDevice(e,t){var s;if(!(null===(s=this.disks[t])||void 0===s?void 0:s.blocks.length))return v("Drive",t,"is empty"),e.a=47,void(e.s|=1);if(this.disks[t].readOnly)return v("Drive",t,"is write protected"),e.a=43,void(e.s|=1);for(let e=0;e<this.disks[t].blocks.length;e++){this.disks[t].blocks[e]=new Uint8Array;for(let s=0;s<512;s++)this.disks[t].blocks[e][s]=0}e.a=0,e.s&=1}access(e,t){let s;const i=void 0===t;switch(143&e){case 128:if(i){s=0;for(let e=0;e<this.disks.length;e++)s<<=1,this.disks[e]&&(s|=1)}}return s}ioSwitch(e,t){return this.access(e,t)}read(e,t){const s=this.cpu.getState();let i,r,a,o;const n=this.rom[255],h=n+3;if(t===n&&this.cpu.getSync()){this.debug("block device entry"),i=this.cpu.read(0,66),r=this.cpu.read(0,67);const e=new As(this.cpu,68),t=new As(this.cpu,70),n=128&r?2:1,h=(112&r)>>4;switch(a=e.readAddress(),o=t.readWord(),this.debug("cmd="+i),this.debug("unit=$"+T(r)),this.debug("slot="+h+" drive="+n),this.debug("buffer="+a+" block=$"+T(o)),i){case 0:this.getDeviceInfo(s,n);break;case 1:this.readBlock(s,n,o,a);break;case 2:this.writeBlock(s,n,o,a);break;case 3:this.formatDevice(s,r)}}else if(t==h&&this.cpu.getSync()){this.debug("smartport entry");const e=new As(this.cpu,s.sp+1,1);let t;const n=e.readAddress();this.debug("return="+n);const h=n.inc(1);i=h.readByte();const d=h.inc(1).readAddress();this.debug("cmd="+i),this.debug("cmdListAddr="+d),e.writeAddress(n.inc(3));const c=d.readByte();let l;switch(r=d.inc(1).readByte(),a=d.inc(2).readAddress(),this.debug("parameterCount="+c),i){case 0:switch(l=d.inc(4).readByte(),this.debug("info unit="+r),this.debug("info buffer="+a),this.debug("info status="+l),r){case 0:switch(l){case 0:a.writeByte(2),a.inc(1).writeByte(64),a.inc(2).writeByte(0),a.inc(3).writeByte(0),a.inc(4).writeByte(0),a.inc(5).writeByte(0),a.inc(6).writeByte(0),a.inc(7).writeByte(0),s.x=8,s.y=0,s.a=0,s.s&=-2}break;default:switch(l){case 0:t=this.disks[r].blocks.length,a.writeByte(240),a.inc(1).writeByte(255&t),a.inc(2).writeByte((65280&t)>>8),a.inc(3).writeByte((16711680&t)>>16),s.x=4,s.y=0,s.a=0,s.s&=-2}}s.a=0,s.s&=-2;break;case 1:o=d.inc(4).readWord(),this.readBlock(s,r,o,a);break;case 2:o=d.inc(4).readWord(),this.writeBlock(s,r,o,a);break;case 3:this.formatDevice(s,r)}}return this.cpu.setState(s),this.rom[t]}write(){}getState(){return{disks:this.disks.map((e=>({blocks:e.blocks.map((e=>new Uint8Array(e))),encoding:L,readOnly:e.readOnly,name:e.name})))}}setState(e){this.disks=e.disks.map((e=>({blocks:e.blocks.map((e=>new Uint8Array(e))),encoding:L,readOnly:e.readOnly,name:e.name})))}setBinary(e,t,s,i){if("2mg"==s){const{bytes:e,offset:t}=Ht(i);i=i.slice(t,t+e)}const r={rawData:i,name:t,readOnly:!1,volume:254};return this.disks[e]=function(e){const{rawData:t,readOnly:s,name:i}=e;if(!t)throw new Error("Requires rawData");const r=[];let a=0;for(;a<t.byteLength;)r.push(new Uint8Array(t.slice(a,a+512))),a+=512;return{encoding:L,blocks:r,name:i,readOnly:s}}(r),!0}}const _s=new Uint8Array([8,120,40,44,88,255,112,5,56,176,1,24,184,8,120,72,138,72,152,72,173,255,207,32,26,200,104,104,186,141,248,7,10,10,10,10,141,120,7,104,104,104,168,104,154,9,4,72,40,152,172,120,7,174,248,7,41,127,72,80,14,184,165,54,208,4,228,55,240,10,169,8,133,56,56,144,22,76,80,201,169,11,133,54,169,94,157,184,4,169,10,157,56,4,169,0,157,56,5,104,201,37,240,92,201,38,240,88,201,60,240,84,201,62,240,80,201,35,240,76,201,94,240,90,201,33,240,74,201,42,240,82,162,32,201,44,240,82,162,40,201,46,240,76,162,48,201,47,240,70,174,248,7,72,189,184,4,201,33,240,65,201,94,240,14,104,41,31,10,56,233,1,157,56,4,169,94,208,35,104,56,233,65,48,32,201,22,16,28,170,189,141,203,76,4,203,157,56,5,76,47,201,169,32,32,183,202,169,8,32,183,202,169,33,157,184,4,76,47,201,138,32,183,202,208,247,104,201,13,240,19,201,32,240,68,41,15,32,207,202,240,2,169,10,157,56,7,24,144,53,32,207,202,125,56,7,72,169,9,157,56,6,32,207,202,72,222,56,6,208,247,169,10,157,56,6,104,32,207,202,222,56,6,208,247,169,16,32,183,202,208,178,186,104,104,152,72,104,104,169,141,72,154,174,248,7,172,120,7,189,184,3,221,56,7,208,12,29,56,7,240,7,201,64,208,3,153,128,192,104,168,104,170,104,40,96,104,169,24,32,183,202,169,8,32,183,202,169,9,157,56,6,32,207,202,201,10,48,2,169,0,72,222,56,6,208,241,32,207,202,201,13,48,2,169,0,72,189,56,5,240,4,201,35,208,94,160,0,104,201,10,48,4,200,56,233,10,72,152,162,0,32,166,202,104,32,166,202,172,248,7,185,56,5,208,42,169,175,32,168,202,104,160,4,104,32,166,202,104,32,166,202,136,240,7,169,59,32,168,202,208,238,169,160,141,5,2,185,243,203,240,25,32,168,202,200,208,245,169,0,72,160,5,32,175,202,104,32,166,202,104,32,166,202,136,208,242,76,154,202,104,170,104,10,10,168,138,10,10,72,174,248,7,189,56,5,162,160,201,60,176,2,162,162,138,162,0,32,168,202,185,163,203,200,32,168,202,201,160,208,245,104,168,185,191,203,200,32,168,202,201,160,208,245,104,32,164,202,104,32,166,202,32,179,202,160,3,104,32,164,202,208,3,32,166,202,104,32,166,202,136,240,9,169,186,32,168,202,104,76,41,202,172,248,7,185,56,5,201,37,240,4,201,62,208,80,160,65,173,12,2,201,160,208,2,169,48,10,10,10,10,141,32,2,173,13,2,41,15,13,32,2,201,18,48,2,160,80,201,0,208,4,169,18,208,9,201,19,48,22,248,56,233,18,216,162,12,72,32,255,202,41,15,32,164,202,104,41,15,32,166,202,162,20,32,179,202,152,32,168,202,169,77,32,168,202,138,168,169,141,32,168,202,76,36,201,240,13,9,48,9,128,157,0,2,232,96,169,172,208,245,169,160,208,241,153,128,192,9,4,153,128,192,32,199,202,73,4,153,128,192,32,202,202,72,72,104,104,96,72,169,4,157,184,6,169,0,157,184,5,185,128,192,10,126,184,5,104,72,41,1,153,128,192,9,2,153,128,192,73,2,153,128,192,104,106,72,222,184,6,208,224,104,189,184,5,24,106,106,106,106,96,72,174,248,7,189,56,4,157,184,6,32,80,203,104,72,32,76,203,104,72,73,248,32,76,203,162,160,32,105,203,162,160,32,105,203,160,24,32,96,203,174,248,7,222,184,6,208,218,104,160,188,202,208,253,136,208,250,76,47,201,72,144,5,32,80,203,240,3,32,89,203,104,10,208,241,96,162,80,32,105,203,160,40,208,7,162,24,32,105,203,160,68,162,19,202,208,253,136,208,248,96,172,120,7,169,32,153,128,192,234,234,234,73,32,153,128,192,234,234,234,73,32,153,128,192,234,234,234,73,32,153,128,192,202,208,224,96,100,228,36,164,20,148,84,212,116,244,52,180,4,132,68,196,44,60,92,76,28,12,83,85,78,32,77,79,78,32,84,85,69,32,87,69,68,32,84,72,85,32,70,82,73,32,83,65,84,32,69,82,82,32,74,65,78,32,70,69,66,32,77,65,82,32,65,80,82,32,77,65,89,32,74,85,78,32,74,85,76,32,65,85,71,32,83,69,80,32,79,67,84,32,78,79,86,32,68,69,67,32,174,176,176,176,0,174,176,176,176,0,160,160,193,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255]);class ws{constructor(){this.clock=!1,this.strobe=!1,this.shiftMode=!1,this.register=0,this.bits=[],this.command=0,v("Thunderclock")}debug(...e){}calcBits(){const e=e=>{for(let t=0;t<4;t++)this.bits.push(0!=(8&e)),e<<=1},t=t=>{e(Math.floor(t/10)),e(t%10)},s=new Date,i=s.getDate(),r=s.getDay(),a=s.getMonth()+1,o=s.getHours(),n=s.getMinutes(),h=s.getSeconds();this.bits=[],e(a),e(r),t(i),t(o),t(n),t(h)}shift(){this.shiftMode&&(this.bits.pop()?(this.debug("shifting 1"),this.register|=128):(this.debug("shifting 0"),this.register&=127))}access(e,t){switch(143&e){case 128:if(void 0!==t){const e=!!(4&t);if(e!==this.strobe&&(this.debug("strobe",this.strobe?"high":"low"),e))switch(this.command=24&t,this.command){case 24:this.debug("TIMED"),this.calcBits();break;case 8:this.debug("REGSHIFT"),this.shiftMode=!0,this.shift();break;case 0:this.debug("REGHOLD"),this.shiftMode=!1;break;default:this.debug("Unknown command",T(this.command))}const s=!!(2&t);s!==this.clock&&(this.clock=s,this.debug("clock",this.clock?"high":"low"),s&&this.shift())}}return this.register}read(e,t){let s;return s=e<200?_s[t]:_s[e-200<<8|t],s}write(){}ioSwitch(e,t){return this.access(e,t)}getState(){return{}}setState(){}}class ys{constructor(e,t){this.cpu=e,this.vm=t,this._slot=new Array(7).fill(null),this._auxRom=null,this._khz=1023,this._rate=44e3,this._sample_size=4096,this._buffer=[],this._key=0,this._keyDown=!1,this._button=[!1,!1,!1],this._paddle=[0,0,0,0],this._phase=-1,this._sample=[],this._sampleIdx=0,this._sampleTime=0,this._didAudio=!1,this._high=.5,this._low=-.5,this._trigger=0,this._annunciators=[!1,!1,!1,!1],this._tape=[],this._tapeOffset=0,this._tapeNext=0,this._tapeCurrent=!1,this.init()}init(){this._calcSampleRate()}_debug(...e){}_tick(){const e=this.cpu.getCycles(),t=this._didAudio?this._phase>0?this._high:this._low:0;for(;this._sampleTime<e;this._sampleTime+=this._cycles_per_sample)this._sample[this._sampleIdx++]=t,this._sampleIdx===this._sample_size&&(this._audioListener&&this._audioListener(this._sample),this._sample=new Array(this._sample_size),this._sampleIdx=0);this._didAudio=!1}_calcSampleRate(){this._cycles_per_sample=1e3*this._khz/this._rate}_updateKHz(e){this._khz=e,this._calcSampleRate()}_access(e,t){let s=0;const i=this.cpu.getCycles(),r=void 0===t,a=i-this._trigger;switch(e){case 80:this._debug("Graphics Mode"),this.vm.text(!1);break;case 81:this._debug("Text Mode"),this.vm.text(!0);break;case 82:this._debug("Mixed Mode off"),this.vm.mixed(!1);break;case 83:this._debug("Mixed Mode on"),this.vm.mixed(!0);break;case 86:this._debug("LoRes Mode"),this.vm.hires(!1);break;case 87:this._debug("HiRes Mode"),this.vm.hires(!0);break;case 84:this.vm.page(1);break;case 85:this.vm.page(2);break;case 89:this._debug("Annunciator 0 on"),this._annunciators[0]=!0;break;case 91:this._debug("Annunciator 1 on"),this._annunciators[1]=!0;break;case 93:this._debug("Annunciator 2 on"),this._annunciators[2]=!0;break;case 95:this._debug("Annunciator 3 on"),this._annunciators[3]=!0;break;case 88:this._debug("Annunciator 0 off"),this._annunciators[0]=!1;break;case 90:this._debug("Annunciator 1 off"),this._annunciators[1]=!1;break;case 92:this._debug("Annunciator 2 off"),this._annunciators[2]=!1;break;case 94:this._debug("Annunciator 3 off"),this._annunciators[3]=!1;break;case 97:s=this._button[0]?128:0;break;case 98:s=this._button[1]?128:0;break;case 99:s=this._button[2]?128:0;break;case 100:s=a<2756*this._paddle[0]?128:0;break;case 101:s=a<2756*this._paddle[1]?128:0;break;case 102:s=a<2756*this._paddle[2]?128:0;break;case 103:s=a<2756*this._paddle[3]?128:0;break;case 116:void 0!==t&&this._updateKHz(1&t?1023:4096);break;case 96:if(-1==this._tapeOffset&&(this._tapeOffset=0,this._tapeNext=i),this._tapeOffset<this._tape.length)for(this._tapeCurrent=this._tape[this._tapeOffset][1];i>=this._tapeNext;)this._tapeOffset%1e3==0&&v("Read "+this._tapeOffset/1e3),this._tapeCurrent=this._tape[this._tapeOffset][1],this._tapeNext+=this._tape[this._tapeOffset++][0];s=this._tapeCurrent?128:0;break;default:switch(240&e){case 0:s=this._key;break;case 16:if((16===e||r)&&(this._key&=127),this._buffer.length>0){let e=this._buffer.shift();"\n"==e&&(e="\r"),this._key=128|e.charCodeAt(0)}s=127&this._key,16===e&&(s|=this._keyDown?128:0);break;case 32:break;case 48:this._phase=-this._phase,this._didAudio=!0,this._tick();break;case 64:break;case 112:this._trigger=this.cpu.getCycles()}}return void 0!==t&&(s=void 0),s}start(){return 192}end(){return 207}ioSwitch(e,t){let s;if(e<128)s=this._access(e,t);else{const i=(112&e)>>4,r=this._slot[i];r&&r.ioSwitch&&(s=r.ioSwitch(e,t))}return s}reset(){var e;for(let t=0;t<8;t++){const s=this._slot[t];s&&(null===(e=s.reset)||void 0===e||e.call(s))}this.vm.reset()}blit(){var e;const t=this._slot[3];if(t)return null===(e=t.blit)||void 0===e?void 0:e.call(t)}read(e,t){let s,i,r=0;switch(e){case 192:r=this.ioSwitch(t,void 0)||0;break;case 193:case 194:case 195:case 196:case 197:case 198:case 199:s=15&e,i=this._slot[s],this._auxRom!=i&&(this._auxRom=i),r=i?i.read(e,t):y();break;default:this._auxRom&&(r=this._auxRom.read(e,t))}return r}write(e,t,s){let i,r;switch(e){case 192:this.ioSwitch(t,s);break;case 193:case 194:case 195:case 196:case 197:case 198:case 199:i=15&e,r=this._slot[i],this._auxRom!=r&&(this._auxRom=r),r&&r.write(e,t,s);break;default:this._auxRom&&this._auxRom.write(e,t,s)}}getState(){return{annunciators:this._annunciators,cards:this._slot.map((e=>e?e.getState():null))}}setState(e){this._annunciators=e.annunciators,e.cards.map(((e,t)=>{var s;return null===(s=this._slot[t])||void 0===s?void 0:s.setState(e)}))}setSlot(e,t){this._slot[e]=t}keyDown(e){this._keyDown=!0,this._key=128|e}keyUp(){this._keyDown=!1}buttonDown(e){this._button[e]=!0}buttonUp(e){this._button[e]=!1}paddle(e,t){this._paddle[e]=t}updateKHz(e){this._updateKHz(e)}getKHz(){return this._khz}setKeyBuffer(e){if(this._buffer=e.split(""),this._buffer.length>0){this._keyDown=!0;const e=this._buffer.shift();this._key=128|e.charCodeAt(0)}}setTape(e){v("Tape length: "+e.length),this._tape=e,this._tapeOffset=-1}sampleRate(e,t){this._rate=e,this._sample_size=t,this._sample=new Array(this._sample_size),this._sampleIdx=0,this._calcSampleRate()}tick(){var e,t;this._tick();for(let s=0;s<8;s++)null===(t=null===(e=this._slot[s])||void 0===e?void 0:e.tick)||void 0===t||t.call(e)}addSampleListener(e){this._audioListener=e}annunciator(e){return this._annunciators[e]}cycles(){return this.cpu.getCycles()}}const Ss=e=>[.75*e[0]&255,.75*e[1]&255,.75*e[2]&255],Rs=[255,106,60],Es=[20,245,60],vs=[20,207,253],Ts=[255,68,253],Ps=[255,255,255],Cs=[0,0,0],ks=[[0,0,0],[227,30,96],[96,78,189],[255,68,253],[0,163,96],[156,156,156],[20,207,253],[208,195,255],[96,114,3],[255,106,60],[156,156,156],[255,160,208],[20,245,60],[208,221,141],[114,255,208],[255,255,255]],Os=[0,2,4,6,8,5,12,14,1,3,10,7,9,11,13,15],Ms=[[0,0,0],[227,30,96],[96,78,189],[255,68,253],[0,163,96],[156,156,156],[20,207,253],[208,195,255],[96,114,3],[255,106,60],[156,156,156],[255,160,208],[20,245,60],[208,221,141],[114,255,208],[255,255,255]],Is={top:193,bottom:-1,left:561,right:-1};class Fs{constructor(e,t,s,i){this.vm=e,this.page=t,this.charset=s,this.e=i,this._buffer=[],this._refreshing=!1,this._blink=!1,this.highColorTextMode=!1,this.dirty=Object.assign({},Is),this.imageData=this.vm.context.createImageData(560,192),this.imageData.data.fill(255),this._buffer[0]=R(4),this._buffer[1]=R(4),this.vm.setLoresPage(t,this)}_drawPixel(e,t,s){const i=s[0],r=s[1],a=s[2];e[t+0]=e[t+4]=i,e[t+1]=e[t+5]=r,e[t+2]=e[t+6]=a}_drawHalfPixel(e,t,s){const i=s[0],r=s[1],a=s[2];e[t+0]=i,e[t+1]=r,e[t+2]=a}_checkInverse(e){let t=!1;return this.e?this.vm._80colMode||this.vm.altCharMode||(t=64==(192&e)&&this._blink):t=!(128&e||64&e&&this._blink),t}bank0(){return{start:()=>this._start(),end:()=>this._end(),read:(e,t)=>this._read(e,t,0),write:(e,t,s)=>this._write(e,t,s,0)}}bank1(){return{start:()=>this._start(),end:()=>this._end(),read:(e,t)=>this._read(e,t,1),write:(e,t,s)=>this._write(e,t,s,1)}}_start(){return 4*this.page}_end(){return 4*this.page+3}_read(e,t,s){const i=1023&(e<<8|t);return this._buffer[s][i]}_write(e,t,s,i){const r=1023&(e<<8|t);let a,o;if(this._buffer[i][r]==s&&!this._refreshing)return;this._buffer[i][r]=s;const n=r%128%40,h=t-n,d=24&h|(3&e)<<1|h>>7,c=this.imageData.data;if(d<24&&n<40){let e=d<<3;e<this.dirty.top&&(this.dirty.top=e),e+=8,e>this.dirty.bottom&&(this.dirty.bottom=e);let t=14*n;if(t<this.dirty.left&&(this.dirty.left=t),t+=14,t>this.dirty.right&&(this.dirty.right=t),this.vm.textMode||this.vm.hiresMode||this.vm.mixedMode&&d>19)if(this.vm._80colMode){const e=this._checkInverse(s);a=e?Cs:Ps,o=e?Ps:Cs,this.vm.altCharMode||(s=s>=64&&s<128?s-64:s);let t=4*(14*n+7*(i?0:1)+560*d*8);for(let e=0;e<8;e++){let i=this.charset[8*s+e];for(let e=0;e<7;e++){const e=1&i?o:a;this._drawHalfPixel(c,t,e),i>>=1,t+=4}t+=2212}}else{s=this._buffer[0][r];const e=this._checkInverse(s);a=e?Cs:Ps,o=e?Ps:Cs,this.vm.altCharMode||(s=s>=64&&s<128?s-64:s);let t=4*(14*n+560*d*8);if(this.highColorTextMode&&(a=ks[this._buffer[1][r]>>4],o=ks[15&this._buffer[1][r]]),this.e)for(let e=0;e<8;e++){let i=this.charset[8*s+e];for(let e=0;e<7;e++){const e=1&i?o:a;this._drawPixel(c,t,e),i>>=1,t+=8}t+=2184}else{const i=this.vm.mixedMode&&!this.vm.textMode&&!this.vm.monoMode;for(let r=0;r<8;r++){let h=!(1&n),d=this.charset[8*s+r]<<1;i&&e&&(d^=511);for(let e=0;e<7;e++){let e;i?(e=128&d?128!=(448&d)?Ps:h?Ts:Es:Cs,h=!h):e=128&d?a:o,this._drawPixel(c,t,e),d<<=1,t+=8}t+=2184}}}else if(this.vm._80colMode&&!this.vm.an3State){let e=4*(14*n+7*(i?0:1)+560*d*8);if(this.vm.monoMode)for(let t=0;t<8;t++){let i=t<4?15&s:s>>4;i|=i<<4,i|=i<<8,1&n&&(i>>=2);for(let t=0;t<7;t++){const t=1&i?Ps:Cs;this._drawHalfPixel(c,e,t),i>>=1,e+=4}e+=2212}else{1&i&&(s=(119&s)<<1|(136&s)>>3);for(let t=0;t<8;t++){const i=ks[t<4?15&s:s>>4];for(let t=0;t<7;t++)this._drawHalfPixel(c,e,i),e+=4;e+=2212}}}else if(0===i){let e=4*(14*n+560*d*8);if(this.vm.monoMode)for(let t=0;t<8;t++){let i=t<4?15&s:s>>4;i|=i<<4,i|=i<<8,1&n&&(i>>=2);for(let t=0;t<14;t++){const t=1&i?Ps:Cs;this._drawHalfPixel(c,e,t),i>>=1,e+=4}e+=2184}else for(let t=0;t<8;t++){const i=ks[t<4?15&s:s>>4];for(let t=0;t<7;t++)this._drawPixel(c,e,i),e+=8;e+=2184}}}}refresh(){this.highColorTextMode=!this.vm.an3State&&this.vm.textMode&&!this.vm._80colMode;let e=1024*this.page;this._refreshing=!0;for(let t=0;t<1024;t++,e++)this._write(e>>8,255&e,this._buffer[0][t],0),this.vm._80colMode&&this._write(e>>8,255&e,this._buffer[1][t],1);this._refreshing=!1}blink(){let e=1024*this.page;this._refreshing=!0,this._blink=!this._blink;for(let t=0;t<1024;t++,e++)64==(192&this._buffer[0][t])&&this._write(e>>8,255&e,this._buffer[0][t],0);this._refreshing=!1}start(){return setInterval((()=>this.blink()),267),this._start()}end(){return this._end()}read(e,t){return this._read(e,t,0)}write(e,t,s){return this._write(e,t,s,0)}getState(){return{buffer:[new Uint8Array(this._buffer[0]),new Uint8Array(this._buffer[1])]}}setState(e){this._buffer[0]=new Uint8Array(e.buffer[0]),this._buffer[1]=new Uint8Array(e.buffer[1]),this.refresh()}rowToBase(e){const t=e>>3&3;return(e>>1&3)<<8|(1&e)<<7|t<<5|t<<3}mapCharCode(e){return(e&=127)<32&&(e+=64),!this.e&&e>=96&&(e-=64),e}getText(){let e,t,s,i,r,a="";for(s=0;s<24;s++){if(r=this.rowToBase(s),e="",this.e&&this.vm._80colMode)for(i=0;i<80;i++)t=this.mapCharCode(this._buffer[1-i%2][r+Math.floor(i/2)]),e+=String.fromCharCode(t);else for(i=0;i<40;i++)t=this.mapCharCode(this._buffer[0][r+i]),e+=String.fromCharCode(t);e=e.trimRight(),a+=e+"\n"}return a}}class Ds{constructor(e,t){this.vm=e,this.page=t,this.dirty=Object.assign({},Is),this._buffer=[],this._refreshing=!1,this.colorDHRMode=!0,this.imageData=this.vm.context.createImageData(560,192),this.imageData.data.fill(255),this._buffer[0]=R(32),this._buffer[1]=R(32),this.vm.setHiresPage(t,this)}_drawPixel(e,t,s){const i=s[0],r=s[1],a=s[2];e[t+0]=e[t+4]=i,e[t+1]=e[t+5]=r,e[t+2]=e[t+6]=a}_drawHalfPixel(e,t,s){const i=s[0],r=s[1],a=s[2];e[t+0]=i,e[t+1]=r,e[t+2]=a}_draw3Pixel(e,t,s){const i=s[0],r=s[1],a=s[2];e[t+0]=e[t+4]=e[t+8]=i,e[t+1]=e[t+5]=e[t+9]=r,e[t+2]=e[t+6]=e[t+10]=a}_draw4Pixel(e,t,s){const i=s[0],r=s[1],a=s[2];e[t+0]=e[t+4]=e[t+8]=e[t+12]=i,e[t+1]=e[t+5]=e[t+9]=e[t+13]=r,e[t+2]=e[t+6]=e[t+10]=e[t+14]=a}bank0(){return{start:()=>this._start(),end:()=>this._end(),read:(e,t)=>this._read(e,t,0),write:(e,t,s)=>this._write(e,t,s,0)}}bank1(){return{start:()=>this._start(),end:()=>this._end(),read:(e,t)=>this._read(e,t,1),write:(e,t,s)=>this._write(e,t,s,1)}}_start(){return 32*this.page}_end(){return 32*this.page+31}_read(e,t,s){const i=8191&(e<<8|t);return this._buffer[s][i]}_write(e,t,s,i){const r=e<<8|t,a=8191&r;if(this._buffer[i][a]==s&&!this._refreshing)return;this._buffer[i][a]=s;const o=a%128%40,n=t-o,h=24&n|(3&e)<<1|n>>7,d=a>>10,c=this.imageData.data;let l,m;if(h<24&&o<40&&this.vm.hiresMode){let e=h<<4|d<<1;e<this.dirty.top&&(this.dirty.top=e),e+=1,e>this.dirty.bottom&&(this.dirty.bottom=e);let t,n,u,p,g,f,A,b,_=14*o-2;if(_<this.dirty.left&&(this.dirty.left=_),_+=18,_>this.dirty.right&&(this.dirty.right=_),m=h<<4|d<<1,this.oneSixtyMode&&!this.vm.monoMode){const e=15&s,t=s>>4;l=2*o+(1^i);const r=28*l+280*m*4;this._draw3Pixel(c,r,Ms[e]),this._draw4Pixel(c,r+12,Ms[t])}else if(this.vm.doubleHiresMode){s&=127;const e=o%2,h=o-e,d=a-e;t=this._buffer[0][d-1],n=this._buffer[1][d],u=this._buffer[0][d],p=this._buffer[1][d+1],g=this._buffer[0][d+1],f=this._buffer[1][d+2],A=[0,(15&n)>>0,(112&n)>>4|(1&u)<<3,(30&u)>>1,(96&u)>>5|(3&p)<<2,(60&p)>>2,(64&p)>>6|(7&g)<<1,(120&g)>>3,0],b=[0,128&n,128&n,128&u,128&p,128&p,128&g,128&g,0],o>0&&(A[0]=(120&t)>>3,b[0]=128&t),o<39&&(A[8]=15&f,b[8]=128&f),l=14*h;let _=4*l+280*m*4,w=null;(this.vm.monoMode||this.monoDHRMode)&&(w=Ps);for(let e=1;e<8;e++){const t=b[e],s=Ms[Os[A[e]]];let i=A[e-1]|A[e]<<4|A[e+1]<<8;for(let r=0;r<4;r++,_+=4)w?16&i?this._drawHalfPixel(c,_,w):this._drawHalfPixel(c,_,Cs):this.mixedDHRMode?t?this._drawHalfPixel(c,_,s):16&i?this._drawHalfPixel(c,_,Ps):this._drawHalfPixel(c,_,Cs):this.colorDHRMode?this._drawHalfPixel(c,_,s):A[e]==A[e-1]||A[e]==A[e+1]||28!=(28&i)&&112!=(112&i)&&56!=(56&i)?56&i||A[e]==A[e+1]||A[e]==A[e-1]?this._drawHalfPixel(c,_,s):40&i?this._drawHalfPixel(c,_,Ss(s)):this._drawHalfPixel(c,_,Cs):this._drawHalfPixel(c,_,Ps),i>>=1}if(!this._refreshing){this._refreshing=!0;const e=i?0:1;for(let t=r-1;t<=r+1;t++){const s=this._read(t>>8,255&t,e);this._write(t>>8,255&t,s,e)}this._refreshing=!1}}else{const e=128&(s=this._buffer[0][a]);s&=127,l=14*o-2,n=o>0?this._buffer[0][a-1]:0,p=o<39?this._buffer[0][a+1]:0;let t,i=32&n,r=64&n,h=1&(s|=(3&p)<<7),d=!(1&o);const u=e?Rs:Es,g=e?vs:Ts;let f=4*l+280*m*4;const A=this.vm.monoMode?Ps:null;for(let e=0;e<9;e++,f+=8)s>>=1,t=r?A||(this.highColorHGRMode?Ms[this._buffer[1][a]>>4]:i||h?Ps:d?u:g):A?Cs:this.highColorHGRMode?Ms[15&this._buffer[1][a]]:d&&h&&i?i?Ss(g):g:!d&&i&&h?h?Ss(u):u:Cs,l>-1&&l<560&&this._drawPixel(c,f,t),l+=2,i=r,r=h,h=1&s,d=!d}}}refresh(){this.highColorHGRMode=!this.vm.an3State&&this.vm.hiresMode&&!this.vm._80colMode,this.oneSixtyMode=1==this.vm.flag&&this.vm.doubleHiresMode,this.mixedDHRMode=2==this.vm.flag&&this.vm.doubleHiresMode,this.monoDHRMode=3==this.vm.flag&&this.vm.doubleHiresMode;let e=8192*this.page;this._refreshing=!0;for(let t=0;t<8192;t++,e++){const s=e>>8,i=255&e;this._write(s,i,this._buffer[0][t],0),this.vm._80colMode&&this._write(s,i,this._buffer[1][t],1)}this._refreshing=!1}start(){return this._start()}end(){return this._end()}read(e,t){return this._read(e,t,0)}write(e,t,s){return this._write(e,t,s,0)}getState(){return{buffer:[new Uint8Array(this._buffer[0]),new Uint8Array(this._buffer[1])]}}setState(e){this._buffer[0]=new Uint8Array(e.buffer[0]),this._buffer[1]=new Uint8Array(e.buffer[1]),this.refresh()}}class Ls{constructor(e,t){this.screen=e,this.e=t,this._grs=[],this._hgrs=[],this._refreshFlag=!0,this.ready=Promise.resolve(),this.flag=0,this.monoMode=!1,this._canvas=document.createElement("canvas");const s=this._canvas.getContext("2d"),i=this.screen.getContext("2d");if(!s||!i)throw new Error("No 2d context");this.context=s;const{width:r,height:a}={width:560,height:192};this._canvas.width=r,this._canvas.height=a,this._screenContext=i,this._screenContext.imageSmoothingEnabled=!1,this._left=(this.screen.width-560)/2,this._top=(this.screen.height-384)/2}_refresh(){this.doubleHiresMode=!this.an3State&&this.hiresMode&&this._80colMode,this._refreshFlag=!0}refresh(){this._refresh()}reset(){this.textMode=!0,this.mixedMode=!1,this.hiresMode=!0,this.pageMode=1,this._80colMode=!1,this.altCharMode=!1,this.flag=0,this.an3State=!0,this._refresh()}setLoresPage(e,t){this._grs[e-1]=t}setHiresPage(e,t){this._hgrs[e-1]=t}text(e){const t=this.textMode;this.textMode=e,e&&(this.flag=0),t!=e&&this._refresh()}_80col(e){if(!this.e)return;const t=this._80colMode;this._80colMode=e,t!=e&&this._refresh()}altChar(e){if(!this.e)return;const t=this.altCharMode;this.altCharMode=e,t!=e&&this._refresh()}hires(e){const t=this.hiresMode;this.hiresMode=e,e||(this.flag=0),t!=e&&this._refresh()}an3(e){if(!this.e)return;const t=this.an3State;this.an3State=e,e&&(this.flag=3&(this.flag<<1|(this._80colMode?0:1))),t!=e&&this._refresh()}doubleHires(e){this.an3(!e)}mixed(e){const t=this.mixedMode;this.mixedMode=e,t!=e&&this._refresh()}page(e){const t=this.pageMode;this.pageMode=e,t!=e&&this._refresh()}isText(){return this.textMode}isMixed(){return this.mixedMode}isPage2(){return 2==this.pageMode}isHires(){return this.hiresMode}isDoubleHires(){return this.doubleHiresMode}is80Col(){return this._80colMode}isAltChar(){return this.altCharMode}buildScreen(e,t){const{x:s,y:i}=(this._80colMode,{x:0,y:0});return t?(this.context.putImageData(e,s,i,0,0,560,160),this.context.putImageData(t,s,i,0,160,560,32)):this.context.putImageData(e,s,i),this._canvas}updateImage(e,t,s,i){let r=!1;if(-1!==t.bottom||i&&-1!==i.bottom){const t=this.buildScreen(e,s);this._screenContext.drawImage(t,0,0,560,192,this._left,this._top,560,384),r=!0}return r}blit(e){let t=!1;const s=this._hgrs[this.pageMode-1],i=this._grs[this.pageMode-1];return this._refreshFlag&&(s.refresh(),i.refresh(),this._refreshFlag=!1),t=e?this.updateImage(e,{top:0,left:0,right:560,bottom:192}):this.hiresMode&&!this.textMode?this.updateImage(s.imageData,s.dirty,this.mixedMode?i.imageData:null,this.mixedMode?i.dirty:null):this.updateImage(i.imageData,i.dirty),s.dirty=Object.assign({},Is),i.dirty=Object.assign({},Is),t}getState(){return{grs:[this._grs[0].getState(),this._grs[1].getState()],hgrs:[this._hgrs[0].getState(),this._hgrs[1].getState()],textMode:this.textMode,mixedMode:this.mixedMode,hiresMode:this.hiresMode,pageMode:this.pageMode,_80colMode:this._80colMode,altCharMode:this.altCharMode,an3State:this.an3State,flag:this.flag}}setState(e){this.textMode=e.textMode,this.mixedMode=e.mixedMode,this.hiresMode=e.hiresMode,this.pageMode=e.pageMode,this._80colMode=e._80colMode,this.altCharMode=e.altCharMode,this.an3State=e.an3State,this.flag=e.flag,this._grs[0].setState(e.grs[0]),this._grs[1].setState(e.grs[1]),this._hgrs[0].setState(e.hgrs[0]),this._hgrs[1].setState(e.hgrs[1]),this._refresh()}mono(e){e?this.screen.classList.add("mono"):this.screen.classList.remove("mono"),this.monoMode=e,this._refresh()}scanlines(e){const t=this.screen.parentElement;t&&(e?t.classList.add("scanlines"):t.classList.remove("scanlines"))}getText(){return this._grs[this.pageMode-1].getText()}}var Bs=r(911);const xs=[255,255,255],Ns=[0,0,0],Us={top:193,bottom:-1,left:561,right:-1};class zs{constructor(e,t,s,i){this.vm=e,this.page=t,this.charset=s,this.e=i,this._buffer=[],this._refreshing=!1,this._blink=!1,this.dirty=Object.assign({},Us),this.imageData=this.vm.context.createImageData(560,192),this.imageData.data.fill(255),this._buffer[0]=R(4),this._buffer[1]=R(4),this.vm.setLoresPage(t,this)}_drawPixel(e,t,s){const i=s[0],r=s[1],a=s[2];e[t+0]=e[t+4]=i,e[t+1]=e[t+5]=r,e[t+2]=e[t+6]=a}_drawHalfPixel(e,t,s){const i=s[0],r=s[1],a=s[2];e[t+0]=i,e[t+1]=r,e[t+2]=a}_checkInverse(e){let t=!1;return this.e?this.vm._80colMode||this.vm.altCharMode||(t=64==(192&e)&&this._blink):t=!(128&e||64&e&&this._blink),t}bank0(){return{start:()=>this._start(),end:()=>this._end(),read:(e,t)=>this._read(e,t,0),write:(e,t,s)=>this._write(e,t,s,0)}}bank1(){return{start:()=>this._start(),end:()=>this._end(),read:(e,t)=>this._read(e,t,1),write:(e,t,s)=>this._write(e,t,s,1)}}_start(){return 4*this.page}_end(){return 4*this.page+3}_read(e,t,s){const i=1023&(e<<8|t);return this._buffer[s][i]}_write(e,t,s,i){const r=1023&(e<<8|t);let a,o;if(this._buffer[i][r]==s&&!this._refreshing)return;this._buffer[i][r]=s;const n=r%128%40,h=t-n,d=24&h|(3&e)<<1|h>>7,c=this.imageData.data;if(d<24&&n<40){let e=d<<3;e<this.dirty.top&&(this.dirty.top=e),e+=8,e>this.dirty.bottom&&(this.dirty.bottom=e);let t=14*n;if(t<this.dirty.left&&(this.dirty.left=t),t+=14,t>this.dirty.right&&(this.dirty.right=t),this.vm.textMode||this.vm.hiresMode||this.vm.mixedMode&&d>19){if(this.vm._80colMode){const e=this._checkInverse(s);a=e?Ns:xs,o=e?xs:Ns,this.vm.altCharMode||(s=s>=64&&s<128?s-64:s);let t=4*(14*n+7*(i?0:1)+560*d*8);for(let e=0;e<8;e++){let i=this.charset[8*s+e];for(let e=0;e<7;e++){const e=1&i?o:a;this._drawHalfPixel(c,t,e),i>>=1,t+=4}t+=2212}}else if(0===i){s=this._buffer[0][r];const e=this._checkInverse(s);a=e?Ns:xs,o=e?xs:Ns,this.vm.altCharMode||(s=s>=64&&s<128?s-64:s);let t=4*(14*n+560*d*8);if(this.e)for(let e=0;e<8;e++){let i=this.charset[8*s+e];for(let e=0;e<7;e++){const e=1&i?o:a;this._drawPixel(c,t,e),i>>=1,t+=8}t+=2184}else for(let e=0;e<8;e++){let i=this.charset[8*s+e]<<1;for(let e=0;e<7;e++){const e=128&i?a:o;this._drawPixel(c,t,e),i<<=1,t+=8}t+=2184}}}else if(this.vm._80colMode&&!this.vm.an3State){let e=4*(14*n+7*(i?0:1)+560*d*8);for(let t=0;t<8;t++){let i=t<4?15&s:s>>4;i|=i<<4,i|=i<<8,1&n&&(i>>=2);for(let t=0;t<7;t++){const t=1&i?xs:Ns;this._drawHalfPixel(c,e,t),i>>=1,e+=4}e+=2212}}else if(0===i){let e=4*(14*n+560*d*8);for(let t=0;t<8;t++){let i=t<4?15&s:s>>4;i|=i<<4,i|=i<<8,1&n&&(i>>=2);for(let t=0;t<14;t++){const t=1&i?xs:Ns;this._drawHalfPixel(c,e,t),i>>=1,e+=4}e+=2184}}}}refresh(){let e=1024*this.page;this._refreshing=!0;for(let t=0;t<1024;t++,e++)this._write(e>>8,255&e,this._buffer[0][t],0),this.vm._80colMode&&this._write(e>>8,255&e,this._buffer[1][t],1);this._refreshing=!1}blink(){let e=1024*this.page;this._refreshing=!0,this._blink=!this._blink;for(let t=0;t<1024;t++,e++)64==(192&this._buffer[0][t])&&this._write(e>>8,255&e,this._buffer[0][t],0);this._refreshing=!1}start(){return setInterval((()=>this.blink()),267),this._start()}end(){return this._end()}read(e,t){return this._read(e,t,0)}write(e,t,s){return this._write(e,t,s,0)}getState(){return{buffer:[new Uint8Array(this._buffer[0]),new Uint8Array(this._buffer[1])]}}setState(e){this._buffer[0]=new Uint8Array(e.buffer[0]),this._buffer[1]=new Uint8Array(e.buffer[1]),this.refresh()}rowToBase(e){const t=e>>3&3;return(e>>1&3)<<8|(1&e)<<7|t<<5|t<<3}mapCharCode(e){return(e&=127)<32&&(e+=64),!this.e&&e>=96&&(e-=64),e}getText(){let e,t,s,i,r,a="";for(s=0;s<24;s++){if(r=this.rowToBase(s),e="",this.e&&this.vm._80colMode)for(i=0;i<80;i++)t=this.mapCharCode(this._buffer[1-i%2][r+Math.floor(i/2)]),e+=String.fromCharCode(t);else for(i=0;i<40;i++)t=this.mapCharCode(this._buffer[0][r+i]),e+=String.fromCharCode(t);e=e.trimRight(),a+=e+"\n"}return a}}class Xs{constructor(e,t){this.vm=e,this.page=t,this.dirty=Object.assign({},Us),this._buffer=[],this._refreshing=!1,this.imageData=this.vm.context.createImageData(560,192),this.imageData.data.fill(255),this._buffer[0]=R(32),this._buffer[1]=R(32),this.vm.setHiresPage(t,this)}_drawPixel(e,t,s){const i=s[0],r=s[1],a=s[2];e[t+0]=e[t+4]=i,e[t+1]=e[t+5]=r,e[t+2]=e[t+6]=a}_drawHalfPixel(e,t,s){const i=s[0],r=s[1],a=s[2];e[t+0]=i,e[t+1]=r,e[t+2]=a}bank0(){return{start:()=>this._start(),end:()=>this._end(),read:(e,t)=>this._read(e,t,0),write:(e,t,s)=>this._write(e,t,s,0)}}bank1(){return{start:()=>this._start(),end:()=>this._end(),read:(e,t)=>this._read(e,t,1),write:(e,t,s)=>this._write(e,t,s,1)}}_start(){return 32*this.page}_end(){return 32*this.page+31}_read(e,t,s){const i=8191&(e<<8|t);return this._buffer[s][i]}_write(e,t,s,i){const r=e<<8|t,a=8191&r;if(this._buffer[i][a]==s&&!this._refreshing)return;this._buffer[i][a]=s;const o=a%128%40,n=t-o,h=24&n|(3&e)<<1|n>>7,d=a>>10,c=this.imageData.data;if(h<24&&o<40&&this.vm.hiresMode){let e=h<<3|d;e<this.dirty.top&&(this.dirty.top=e),e+=1,e>this.dirty.bottom&&(this.dirty.bottom=e);let t=14*o-2;t<this.dirty.left&&(this.dirty.left=t),t+=14,t>this.dirty.right&&(this.dirty.right=t);const n=h<<3|d;if(this.vm.doubleHiresMode){let e=4*(14*o+(i?0:7))+280*n*4*2,t=s;for(let s=0;s<7;s++,e+=4)1&t?this._drawHalfPixel(c,e,xs):this._drawHalfPixel(c,e,Ns),t>>=1}else if(0===i){const e=128&s,t=39===o,h=e&&t;let d=14*o*4+560*n*4;e&&(64&(this._buffer[i][a-1]||0)?this._drawHalfPixel(c,d,xs):this._drawHalfPixel(c,d,Ns),d+=4);let l=s;for(let e=0;e<7;e++,d+=8){(h&&6==e?this._drawHalfPixel:this._drawPixel)(c,d,1&l?xs:Ns),l>>=1}if(!this._refreshing){this._refreshing=!0;const e=r+1;this._write(e>>8,255&e,this._buffer[0][8191&e],0),this._refreshing=!1}}}}refresh(){let e=8192*this.page;this._refreshing=!0;for(let t=0;t<8192;t++,e++){const s=e>>8,i=255&e;this._write(s,i,this._buffer[0][t],0),this.vm._80colMode&&this._write(s,i,this._buffer[1][t],1)}this._refreshing=!1}start(){return this._start()}end(){return this._end()}read(e,t){return this._read(e,t,0)}write(e,t,s){return this._write(e,t,s,0)}getState(){return{buffer:[new Uint8Array(this._buffer[0]),new Uint8Array(this._buffer[1])]}}setState(e){this._buffer[0]=new Uint8Array(e.buffer[0]),this._buffer[1]=new Uint8Array(e.buffer[1]),this.refresh()}}class Hs{constructor(e,t){this.screen=e,this.e=t,this._grs=[],this._hgrs=[],this._scanlines=!1,this._refreshFlag=!0,this.flag=0,this.monoMode=!1,this._canvas=document.createElement("canvas");const s=this._canvas.getContext("2d");if(!s)throw new Error("no 2d context");const{width:i,height:r}=Bs.screenEmu.C.NTSC_DETAILS.imageSize;this._canvas.width=i,this._canvas.height=r,this.context=s,this._sv=new Bs.screenEmu.ScreenView(this.screen),this.ready=this.init()}init(){return e=this,t=void 0,i=function*(){yield this._sv.initOpenGL(),this._displayConfig=this.defaultMonitor(),this._sv.displayConfiguration=this._displayConfig},new((s=void 0)||(s=Promise))((function(r,a){function o(e){try{h(i.next(e))}catch(e){a(e)}}function n(e){try{h(i.throw(e))}catch(e){a(e)}}function h(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,n)}h((i=i.apply(e,t||[])).next())}));var e,t,s,i}defaultMonitor(){const e=new Bs.screenEmu.DisplayConfiguration;return e.displayResolution=new Bs.screenEmu.Size(this.screen.width,this.screen.height),e.displayScanlineLevel=.5,e.videoWhiteOnly=!0,e.videoSaturation=.8,e.videoSize=new Bs.screenEmu.Size(1.25,1.15),e.videoCenter=new Bs.screenEmu.Point(.01,.02),e}monitorII(){const e=new Bs.screenEmu.DisplayConfiguration;return e.displayResolution=new Bs.screenEmu.Size(this.screen.width,this.screen.height),e.videoDecoder="CANVAS_MONOCHROME",e.videoBrightness=.15,e.videoContrast=.8,e.videoSaturation=1.45,e.videoHue=.27,e.videoCenter=new Bs.screenEmu.Point(.01,.02),e.videoSize=new Bs.screenEmu.Size(1.25,1.15),e.videoBandwidth=9e6,e.displayBarrel=.1,e.displayScanlineLevel=.5,e.displayCenterLighting=.5,e.displayLuminanceGain=1.5,e}_refresh(){this.doubleHiresMode=!this.an3State&&this.hiresMode&&this._80colMode,this._refreshFlag=!0,this._displayConfig&&(this._displayConfig.videoWhiteOnly=this.textMode||this.monoMode,this._displayConfig.displayScanlineLevel=this._scanlines?.5:0,this._sv.displayConfiguration=this._displayConfig)}refresh(){this._refresh()}reset(){this.textMode=!0,this.mixedMode=!1,this.hiresMode=!0,this.pageMode=1,this._80colMode=!1,this.altCharMode=!1,this.an3State=!0,this._refresh()}setLoresPage(e,t){this._grs[e-1]=t}setHiresPage(e,t){this._hgrs[e-1]=t}text(e){const t=this.textMode;this.textMode=e,t!=e&&this._refresh()}_80col(e){if(!this.e)return;const t=this._80colMode;this._80colMode=e,t!=e&&this._refresh()}altChar(e){if(!this.e)return;const t=this.altCharMode;this.altCharMode=e,t!=e&&this._refresh()}hires(e){const t=this.hiresMode;this.hiresMode=e,t!=e&&this._refresh()}an3(e){if(!this.e)return;const t=this.an3State;this.an3State=e,t!=e&&this._refresh()}doubleHires(e){this.an3(!e)}mixed(e){const t=this.mixedMode;this.mixedMode=e,t!=e&&this._refresh()}page(e){const t=this.pageMode;this.pageMode=e,t!=e&&this._refresh()}isText(){return this.textMode}isMixed(){return this.mixedMode}isPage2(){return 2==this.pageMode}isHires(){return this.hiresMode}isDoubleHires(){return this.doubleHiresMode}is80Col(){return this._80colMode}isAltChar(){return this.altCharMode}updateImage(e,t,s,i){let r=!1;if(-1!==t.bottom||i&&-1!==i.bottom){const t=this.buildScreen(e,s),i=new Bs.screenEmu.ImageInfo(t);this._sv.image=i,r=!0}return this._sv.vsync(),r}buildScreen(e,t){const s=Bs.screenEmu.C.NTSC_DETAILS,{width:i,height:r}=s.imageSize,{x:a,y:o}=this._80colMode?s.topLeft80Col:s.topLeft;return t?(this.context.putImageData(e,a,o,0,0,560,160),this.context.putImageData(t,a,o,0,160,560,32)):this.context.putImageData(e,a,o),this.context.getImageData(0,0,i,r)}blit(e){let t=!1;const s=this._hgrs[this.pageMode-1],i=this._grs[this.pageMode-1];return this._refreshFlag&&(s.refresh(),i.refresh(),this._refreshFlag=!1),t=e?this.updateImage(e,{top:0,left:0,right:560,bottom:192}):this.hiresMode&&!this.textMode?this.updateImage(s.imageData,s.dirty,this.mixedMode?i.imageData:null,this.mixedMode?i.dirty:null):this.updateImage(i.imageData,i.dirty),s.dirty=Object.assign({},Us),i.dirty=Object.assign({},Us),t}getState(){return{grs:[this._grs[0].getState(),this._grs[1].getState()],hgrs:[this._hgrs[0].getState(),this._hgrs[1].getState()],textMode:this.textMode,mixedMode:this.mixedMode,hiresMode:this.hiresMode,pageMode:this.pageMode,_80colMode:this._80colMode,altCharMode:this.altCharMode,an3State:this.an3State,flag:0}}setState(e){this.textMode=e.textMode,this.mixedMode=e.mixedMode,this.hiresMode=e.hiresMode,this.pageMode=e.pageMode,this._80colMode=e._80colMode,this.altCharMode=e.altCharMode,this.an3State=e.an3State,this._grs[0].setState(e.grs[0]),this._grs[1].setState(e.grs[1]),this._hgrs[0].setState(e.hgrs[0]),this._hgrs[1].setState(e.hgrs[1]),this._refresh()}mono(e){this.monoMode=e,this._displayConfig=e?this.monitorII():this.defaultMonitor(),this._refresh()}scanlines(e){this._scanlines=e,this._refresh()}getText(){return this._grs[this.pageMode-1].getText()}}class Gs{constructor(e,t){this.start_page=e,this.end_page=t,this.mem=R(t-e+1)}start(){return this.start_page}end(){return this.end_page}read(e,t){return this.mem[e-this.start_page<<8|t]}write(e,t,s){this.mem[e-this.start_page<<8|t]=s}getState(){return{mem:new Uint8Array(this.mem)}}setState(e){this.mem=new Uint8Array(e.mem)}}class Ws{constructor(e){this.mmu=e}read(e,t){return this.mmu._access(t)||0}write(e,t,s){this.mmu._access(t,s)}}class Zs{constructor(e,t){this.mmu=e,this.rom=t}_access(e,t){195==e&&(this.mmu._setIntc8rom(!0),this.mmu._updateBanks()),207==e&&255==t&&(this.mmu._setIntc8rom(!1),this.mmu._updateBanks())}read(e,t){return this._access(e,t),this.rom.read(e,t)}write(e,t,s){this._access(e,t)}}class Ys{constructor(e,t,s,i,r,a,o,n){this.cpu=e,this.vm=t,this.lores1=s,this.lores2=i,this.hires1=r,this.hires2=a,this.io=o,this.rom=n,this._readPages=new Array(256),this._writePages=new Array(256),this._pages=new Array(256),this._vbEnd=0,this.switches=new Ws(this),this.auxRom=new Zs(this,this.rom),this.mem00_01=[new Gs(0,1),new Gs(0,1)],this.mem02_03=[new Gs(2,3),new Gs(2,3)],this.mem04_07=[this.lores1.bank0(),this.lores1.bank1()],this.mem08_0B=[this.lores2.bank0(),this.lores2.bank1()],this.mem0C_1F=[new Gs(12,31),new Gs(12,31)],this.mem20_3F=[this.hires1.bank0(),this.hires1.bank1()],this.mem40_5F=[this.hires2.bank0(),this.hires2.bank1()],this.mem60_BF=[new Gs(96,191),new Gs(96,191)],this.memC0_C0=[this.switches],this.memC1_CF=[this.io,this.auxRom],this.memD0_DF=[this.rom,new Gs(208,223),new Gs(208,223),new Gs(208,223),new Gs(208,223)],this.memE0_FF=[this.rom,new Gs(224,255),new Gs(224,255)];for(let e=0;e<2;e++)this._pages[e]=this.mem00_01,this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0];for(let e=2;e<4;e++)this._pages[e]=this.mem02_03,this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0];for(let e=4;e<8;e++)this._pages[e]=this.mem04_07,this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0];for(let e=8;e<12;e++)this._pages[e]=this.mem08_0B,this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0];for(let e=12;e<32;e++)this._pages[e]=this.mem0C_1F,this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0];for(let e=32;e<64;e++)this._pages[e]=this.mem20_3F,this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0];for(let e=64;e<96;e++)this._pages[e]=this.mem40_5F,this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0];for(let e=96;e<192;e++)this._pages[e]=this.mem60_BF,this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0];{const e=192;this._pages[e]=this.memC0_C0,this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0]}for(let e=193;e<208;e++)this._pages[e]=this.memC1_CF,this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0];for(let e=208;e<224;e++)this._pages[e]=this.memD0_DF,this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0];for(let e=224;e<256;e++)this._pages[e]=this.memE0_FF,this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0]}_initSwitches(){this._bank1=!1,this._readbsr=!1,this._writebsr=!1,this._prewrite=!1,this._auxRamRead=!1,this._auxRamWrite=!1,this._altzp=!1,this._intcxrom=!1,this._slot3rom=!1,this._intc8rom=!1,this._80store=!1,this._page2=!1,this._hires=!1,this._iouDisable=!0}_debug(...e){}_setIntc8rom(e){this._intc8rom=e}_updateBanks(){if(this._auxRamRead)for(let e=2;e<192;e++)this._readPages[e]=this._pages[e][1];else for(let e=2;e<192;e++)this._readPages[e]=this._pages[e][0];if(this._auxRamWrite)for(let e=2;e<192;e++)this._writePages[e]=this._pages[e][1];else for(let e=2;e<192;e++)this._writePages[e]=this._pages[e][0];if(this._80store)if(this._page2){for(let e=4;e<8;e++)this._readPages[e]=this._pages[e][1],this._writePages[e]=this._pages[e][1];if(this._hires)for(let e=32;e<64;e++)this._readPages[e]=this._pages[e][1],this._writePages[e]=this._pages[e][1]}else{for(let e=4;e<8;e++)this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0];if(this._hires)for(let e=32;e<64;e++)this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0]}if(this._intcxrom)for(let e=193;e<208;e++)this._readPages[e]=this._pages[e][1],this._writePages[e]=this._pages[e][1];else{for(let e=193;e<208;e++)this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0];if(this._slot3rom||(this._readPages[195]=this._pages[195][1],this._writePages[195]=this._pages[195][1]),this._intc8rom)for(let e=200;e<208;e++)this._readPages[e]=this._pages[e][1],this._writePages[e]=this._pages[e][1]}if(this._altzp)for(let e=0;e<2;e++)this._readPages[e]=this._pages[e][1],this._writePages[e]=this._pages[e][1];else for(let e=0;e<2;e++)this._readPages[e]=this._pages[e][0],this._writePages[e]=this._pages[e][0];if(this._readbsr){if(this._bank1)for(let e=208;e<224;e++)this._readPages[e]=this._pages[e][this._altzp?2:1];else for(let e=208;e<224;e++)this._readPages[e]=this._pages[e][this._altzp?4:3];for(let e=224;e<256;e++)this._readPages[e]=this._pages[e][this._altzp?2:1]}else for(let e=208;e<256;e++)this._readPages[e]=this._pages[e][0];if(this._writebsr){if(this._bank1)for(let e=208;e<224;e++)this._writePages[e]=this._pages[e][this._altzp?2:1];else for(let e=208;e<224;e++)this._writePages[e]=this._pages[e][this._altzp?4:3];for(let e=224;e<256;e++)this._writePages[e]=this._pages[e][this._altzp?2:1]}else for(let e=208;e<256;e++)this._writePages[e]=this._pages[e][0]}_accessMMUSet(e,t){switch(e){case 0:this._80store=!1,this._debug("80 Store Off",t),this.vm.page(this._page2?2:1);break;case 1:this._80store=!0,this._debug("80 Store On",t);break;case 2:this._auxRamRead=!1,this._debug("Aux RAM Read Off");break;case 3:this._auxRamRead=!0,this._debug("Aux RAM Read On");break;case 4:this._auxRamWrite=!1,this._debug("Aux RAM Write Off");break;case 5:this._auxRamWrite=!0,this._debug("Aux RAM Write On");break;case 6:this._intcxrom=!1,this._slot3rom&&(this._intc8rom=!1),this._debug("Int CX ROM Off");break;case 7:this._intcxrom=!0,this._debug("Int CX ROM On");break;case 8:this._altzp=!1,this._debug("Alt ZP Off");break;case 9:this._altzp=!0,this._debug("Alt ZP On");break;case 10:this._slot3rom=!1,this._debug("Slot 3 ROM Off");break;case 11:this._slot3rom=!0,this._debug("Slot 3 ROM On");break;case 12:this._debug("80 Column Mode off"),this.vm._80col(!1);break;case 13:this._debug("80 Column Mode on"),this.vm._80col(!0);break;case 14:this._debug("Alt Char off"),this.vm.altChar(!1);break;case 15:this._debug("Alt Char on"),this.vm.altChar(!0)}this._updateBanks()}_accessStatus(e,t){let s;switch(e){case 17:this._debug("Bank 2 Read "+!this._bank1),s=this._bank1?0:128;break;case 18:this._debug("Bank SW RAM Read "+this._readbsr),s=this._readbsr?128:0;break;case 19:this._debug("Aux RAM Read "+this._auxRamRead),s=this._auxRamRead?128:0;break;case 20:this._debug("Aux RAM Write "+this._auxRamWrite),s=this._auxRamWrite?128:0;break;case 21:s=this._intcxrom?128:0;break;case 22:this._debug("Alt ZP "+this._altzp),s=this._altzp?128:0;break;case 23:this._debug("Slot C3 ROM "+this._slot3rom),s=this._slot3rom?128:0;break;case 24:this._debug("80 Store "+this._80store),s=this._80store?128:0;break;case 25:s=this.cpu.getCycles()<this._vbEnd?128:0;break;case 26:s=this.vm.isText()?128:0;break;case 27:s=this.vm.isMixed()?128:0;break;case 28:s=this._page2?128:0;break;case 29:s=this.vm.isHires()?128:0;break;case 31:s=this.vm.is80Col()?128:0;break;case 30:s=this.vm.isAltChar()?128:0;break;default:s=this.io.ioSwitch(e,t)}return s}_accessIOUDisable(e,t){const s=void 0!==t;let i;switch(e){case 126:s?this._iouDisable=!0:i=this._iouDisable?0:128;break;case 127:s?this._iouDisable=!1:i=this.vm.isDoubleHires()?128:0;break;default:i=this.io.ioSwitch(e,t)}return i}_accessGraphics(e,t){let s=0;switch(e){case 84:this._page2=!1,this._80store||(s=this.io.ioSwitch(e,t)),this._debug("Page 2 off");break;case 85:this._page2=!0,this._80store||(s=this.io.ioSwitch(e,t)),this._debug("Page 2 on");break;case 86:this._hires=!1,s=this.io.ioSwitch(e,t),this._debug("Hires off");break;case 94:this._iouDisable?this.vm.doubleHires(!0):s=this.io.ioSwitch(e,t);break;case 95:this._iouDisable?this.vm.doubleHires(!1):s=this.io.ioSwitch(e,t);break;case 87:this._hires=!0,s=this.io.ioSwitch(e,t),this._debug("Hires on");break;default:s=this.io.ioSwitch(e,t)}return this._updateBanks(),s}_accessLangCard(e,t){const s=void 0===t,i=s?0:void 0,r=2&e,a=8&e;let o,n;return 1&e?(s&&(this._writebsr=this._prewrite),this._prewrite=s,r?(this._readbsr=!0,n="Read/Write"):(this._readbsr=!1,n="Write")):(this._writebsr=!1,this._prewrite=!1,r?(this._readbsr=!1,n="Off"):(this._readbsr=!0,n="Read")),a?(this._bank1=!0,o="Bank 1"):(this._bank1=!1,o="Bank 2"),this._debug(o,n),this._updateBanks(),i}_access(e,t){let s;const i=void 0!==t;switch(e>>4){case 0:i?this._accessMMUSet(e,t):s=this.io.ioSwitch(e);break;case 1:i?this.io.ioSwitch(e,t):s=this._accessStatus(e,t);break;case 5:s=this._accessGraphics(e,t);break;case 7:s=this._accessIOUDisable(e,t);break;case 8:s=this._accessLangCard(e,t);break;default:s=this.io.ioSwitch(e,t)}return s}start(){return this.lores1.start(),this.lores2.start(),0}end(){return 255}reset(){v("reset"),this._initSwitches(),this._updateBanks(),this.vm.reset(),this.io.reset()}read(e,t){return this._readPages[e].read(e,t)}write(e,t,s){this._writePages[e].write(e,t,s)}writeBank(e,t,s,i){this._pages[t][e].write(t,s,i)}resetVB(){this._vbEnd=this.cpu.getCycles()+1e3}getState(){return{bank1:this._bank1,readbsr:this._readbsr,writebsr:this._writebsr,prewrite:this._prewrite,intcxrom:this._intcxrom,slot3rom:this._slot3rom,intc8rom:this._intc8rom,auxRamRead:this._auxRamRead,auxRamWrite:this._auxRamWrite,altzp:this._altzp,_80store:this._80store,page2:this._page2,hires:this._hires,mem00_01:[this.mem00_01[0].getState(),this.mem00_01[1].getState()],mem02_03:[this.mem02_03[0].getState(),this.mem02_03[1].getState()],mem0C_1F:[this.mem0C_1F[0].getState(),this.mem0C_1F[1].getState()],mem60_BF:[this.mem60_BF[0].getState(),this.mem60_BF[1].getState()],memD0_DF:[this.memD0_DF[0].getState(),this.memD0_DF[1].getState(),this.memD0_DF[2].getState(),this.memD0_DF[3].getState(),this.memD0_DF[4].getState()],memE0_FF:[this.memE0_FF[0].getState(),this.memE0_FF[1].getState(),this.memE0_FF[2].getState()]}}setState(e){this._readbsr=e.readbsr,this._writebsr=e.writebsr,this._bank1=e.bank1,this._prewrite=e.prewrite,this._intcxrom=e.intcxrom,this._slot3rom=e.slot3rom,this._intc8rom=e.intc8rom,this._auxRamRead=e.auxRamRead,this._auxRamWrite=e.auxRamWrite,this._altzp=e.altzp,this._80store=e._80store,this._page2=e.page2,this._hires=e.hires,this.mem00_01[0].setState(e.mem00_01[0]),this.mem00_01[1].setState(e.mem00_01[1]),this.mem02_03[0].setState(e.mem02_03[0]),this.mem02_03[1].setState(e.mem02_03[1]),this.mem0C_1F[0].setState(e.mem0C_1F[0]),this.mem0C_1F[1].setState(e.mem0C_1F[1]),this.mem60_BF[0].setState(e.mem60_BF[0]),this.mem60_BF[1].setState(e.mem60_BF[1]),this.memD0_DF[0].setState(e.memD0_DF[0]),this.memD0_DF[1].setState(e.memD0_DF[1]),this.memD0_DF[2].setState(e.memD0_DF[2]),this.memD0_DF[3].setState(e.memD0_DF[3]),this.memD0_DF[4].setState(e.memD0_DF[4]),this.memE0_FF[0].setState(e.memE0_FF[0]),this.memE0_FF[1].setState(e.memE0_FF[1]),this.memE0_FF[2].setState(e.memE0_FF[2]),this._updateBanks()}}const Ks={49152:"KEYBOARD",49153:"80STOREON",49154:"RAMRDOFF",49155:"RAMRDON",49156:"RAMWROFF",49157:"RAMWRON",49158:"INTCXOFF",49159:"INTCXON",49160:"ALTZPOFF",49161:"ALTZPON",49162:"SLOT3OFF",49163:"SLOT3ON",49164:"CLR80VID",49165:"SET80VID",49166:"CLRALTCH",49167:"SETALTCH",49168:"STROBE",49169:"BSRBANK2",49170:"BSRREAD",49171:"RAMRD",49172:"RAMWRT",49173:"INTCXROM",49174:"ALTZP",49175:"SLOT3ROM",49176:"80STRORE",49177:"VERTBLANK",49178:"RDTEXT",49179:"RDMIXED",49180:"RDPAGE2",49181:"RDHIRES",49182:"RDALTCH",49183:"RD80VID",49184:"TAPEOUT",49200:"SPEAKER",49232:"CLRTEXT",49233:"SETTEXT",49234:"CLRMIXED",49235:"SETMIXED",49236:"PAGE1",49237:"PAGE2",49238:"CLRHIRS",49239:"SETHIRES",49240:"CLRAN0",49241:"SETAN0",49242:"CLRAN1",49243:"SETAN1",49244:"CLRAN2",49245:"SETAN2",49246:"CLRAN3",49247:"SETAN3",49248:"TAPEIN",49249:"PB0",49250:"PB1",49251:"PB2",49252:"PADDLE0",49253:"PADDLE1",49254:"PADDLE2",49255:"PADDLE3",49264:"PDLTRIG",49278:"SETIOUDIS",49279:"CLRIOUDIS",49280:"RDBSR2",49281:"WRBSR2",49282:"OFFBSR2",49283:"RWBSR2",49284:"RDBSR2",49285:"WRBSR2",49286:"OFFBSR2",49287:"RWBSR2",49288:"RDBSR1",49289:"WRBSR1",49290:"OFFBSR1",49291:"RWBSR1",49292:"RDBSR1",49293:"WRBSR1",49294:"OFFBSR1",49295:"RWBSR1",53248:"TOKEN.ADDRESS.TABLE",53376:"UNFNC",53426:"MATHTBL",53447:"M.NEG",53450:"M.EQU",53453:"M.REL",53456:"TOKEN.NAME.TABLE",53856:"ERROR.MESSAGES",54096:"QT.ERROR",54104:"QT.IN",54109:"QT.BREAK",54117:"GTFORPNT",54163:"BLTU",54170:"BLTU2",54230:"CHKMEM",54243:"REASON",54288:"MEMERR",54290:"ERROR",54321:"PRINT.ERROR.LINNUM",54332:"RESTART",54364:"NUMBERED.LINE",54453:"PUT.NEW.LINE",54514:"FIX.LINKS",54572:"INLIN",54574:"INLIN2",54611:"INCHR",54617:"PARSE.INPUT.LINE",54636:"PARSE",54810:"FNDLIN",54814:"FL1",54856:"RTS.1",54857:"NEW",54859:"SCRTCH",54885:"SETPTRS",54890:"CLEAR",54892:"CLEARC",54915:"STKINI",54934:"RTS.2",54935:"STXTPT",54949:"LIST",55002:"LIST.0",55038:"LIST.1",55042:"LIST.2",55076:"LIST.3",55084:"GETCHR",55092:"LIST.4",55142:"FOR",55215:"STEP",55250:"NEWSTT",55301:"TRACE.",55334:"GOEND",55336:"EXECUTE.STATEMENT",55338:"EXECUTE.STATEMENT.1",55362:"COLON.",55366:"SYNERR.1",55369:"RESTORE",55379:"SETDA",55383:"RTS.3",55384:"ISCNTC",55395:"CONTROL.C.TYPED",55406:"STOP",55408:"END",55409:"END2",55434:"END4",55446:"CONT",55471:"RTS.4",55472:"SAVE",55497:"LOAD",55536:"VARTIO",55553:"PROGIO",55570:"RUN",55585:"GOSUB",55605:"GO.TO.LINE",55614:"GOTO",55658:"RTS.5",55659:"POP",55676:"UNDERR",55681:"SYNERR.2",55684:"RETURN",55701:"DATA",55704:"ADDON",55714:"RTS.6",55715:"DATAN",55718:"REMN",55749:"PULL3",55753:"IF",55772:"REM",55777:"IF.TRUE",55788:"ONGOTO",55796:"ON.1",55800:"ON.2",55819:"RTS.7",55820:"LINGET",55878:"LET",55907:"LET2",55930:"LET.STRING",55931:"PUTSTR",56015:"PR.STRING",56021:"PRINT",56023:"PRINT2",56059:"CRDO",56064:"NEGATE",56066:"RTS.8",56067:"PR.COMMA",56086:"PR.TAB.OR.SPC",56108:"NXSPC",56111:"PR.NEXT.CHAR",56117:"DOSPC",56122:"STROUT",56125:"STRPRT",56151:"OUTSP",56154:"OUTQUES",56156:"OUTDO",56177:"INPUTERR",56187:"READERR",56191:"ERLIN",56198:"INPERR",56199:"RESPERR",56224:"GET",56242:"INPUT",56284:"NXIN",56290:"READ",56297:"INPUT.FLAG.ZERO",56299:"PROCESS.INPUT.LIST",56305:"PROCESS.INPUT.ITEM",56363:"INSTART",56425:"INPUT.DATA",56434:"INPUT.MORE",56473:"INPFIN",56480:"FINDATA",56518:"INPDONE",56543:"ERR.EXTRA",56559:"ERR.REENTRY",56569:"NEXT",56575:"NEXT.1",56578:"NEXT.2",56589:"GERR",56591:"NEXT.3",56679:"FRMNUM",56682:"CHKNUM",56684:"CHKSTR",56685:"CHKVAL",56696:"JERROR",56699:"FRMEVL",56710:"FRMEVL.1",56725:"FRMEVL.2",56781:"FRM.PRECEDENCE.TEST",56790:"NXOP",56791:"SAVOP",56804:"FRM.RELATIONAL",56822:"PREFNC",56829:"FRM.RECURSE",56845:"SNTXERR",56848:"FRM.STACK.1",56853:"FRM.STACK.2",56864:"FRM.STACK.3",56885:"NOTMATH",56888:"GOEX",56890:"FRM.PERFORM.1",56899:"FRM.PERFORM.2",56925:"EXIT",56928:"FRM.ELEMENT",56961:"STRTXT",56976:"NOT.",56984:"EQUOP",56996:"FN.",57003:"SGN.",57010:"PARCHK",57016:"CHKCLS",57019:"CHKOPN",57022:"CHKCOM",57024:"SYNCHR",57033:"SYNERR",57038:"MIN",57040:"EQUL",57045:"FRM.VARIABLE",57047:"FRM.VARIABLE.CALL",57081:"SCREEN",57100:"UNARY",57167:"OR",57173:"AND",57181:"FALSE",57184:"TRUE",57189:"RELOPS",57213:"STRCMP",57258:"STRCMP.1",57264:"NUMCMP",57269:"STRCMP.2",57281:"CMPDONE",57293:"PDL",57302:"NXDIM",57305:"DIM",57315:"PTRGET",57320:"PTRGET2",57322:"PTRGET3",57332:"BADNAM",57335:"NAMOK",57351:"PTRGET4",57469:"ISLETC",57479:"NAME.NOT.FOUND",57498:"C.ZERO",57500:"MAKE.NEW.VARIABLE",57566:"SET.VARPNT.AND.YA",57581:"GETARY",57583:"GETARY2",57598:"NEG32768",57602:"MAKINT",57608:"MKINT",57612:"AYINT",57625:"MI1",57627:"MI2",57630:"ARRAY",57750:"SUBERR",57753:"IQERR",57755:"JER",57758:"USE.OLD.ARRAY",57784:"MAKE.NEW.ARRAY",57931:"FIND.ARRAY.ELEMENT",57939:"FAE.1",57961:"GSE",57964:"GME",57967:"FAE.2",57968:"FAE.3",58028:"RTS.9",58029:"MULTIPLY.SUBSCRIPT",58038:"MULTIPLY.SUBS.1",58078:"FRE",58098:"GIVAYF",58111:"POS",58113:"SNGFLT",58118:"ERRDIR",58126:"UNDFNC",58131:"DEF",58177:"FNC.",58196:"FUNCT",58287:"FNCDATA",58309:"STR",58325:"STRINI",58333:"STRSPA",58343:"STRLIT",58349:"STRLT2",58410:"PUTNEW",58418:"JERR",58421:"PUTEMP",58450:"GETSPA",58500:"GARBAG",58504:"FIND.HIGHEST.STRING",58649:"CHECK.SIMPLE.VARIABLE",58659:"CHECK.VARIABLE",58706:"CHECK.BUMP",58717:"CHECK.EXIT",58722:"MOVE.HIGHEST.STRING.TO.TOP",58775:"CAT",58836:"MOVINS",58850:"MOVSTR",58854:"MOVSTR.1",58877:"FRESTR",58880:"FREFAC",58884:"FRETMP",58933:"FRETMS",58950:"CHRSTR",58970:"LEFTSTR",58976:"SUBSTRING.1",58983:"SUBSTRING.2",58984:"SUBSTRING.3",59014:"RIGHTSTR",59025:"MIDSTR",59065:"SUBSTRING.SETUP",59094:"LEN",59100:"GETSTR",59109:"ASC",59122:"GOIQ",59125:"GTBYTC",59128:"GETBYT",59131:"CONINT",59143:"VAL",59197:"POINT",59206:"GTNUM",59212:"COMBYTE",59218:"GETADR",59236:"PEEK",59259:"POKE",59268:"WAIT",59295:"RTS.10",59296:"FADDH",59303:"FSUB",59306:"FSUBT",59321:"FADD.1",59326:"FADD",59329:"FADDT",59342:"FADD.2",59386:"FADD.3",59433:"NORMALIZE.FAC.1",59438:"NORMALIZE.FAC.2",59470:"ZERO.FAC",59472:"STA.IN.FAC.SIGN.AND.EXP",59474:"STA.IN.FAC.SIGN",59477:"FADD.4",59508:"NORMALIZE.FAC.3",59520:"NORMALIZE.FAC.4",59533:"NORMALIZE.FAC.5",59535:"NORMALIZE.FAC.6",59549:"RTS.11",59550:"COMPLEMENT.FAC",59556:"COMPLEMENT.FAC.MANTISSA",59590:"INCREMENT.FAC.MANTISSA",59604:"RTS.12",59605:"OVERFLOW",59610:"SHIFT.RIGHT.1",59612:"SHIFT.RIGHT.2",59632:"SHIFT.RIGHT",59645:"L",59655:"SHIFT.RIGHT.4",59665:"SHIFT.RIGHT.5",59667:"CON.ONE",59672:"POLY.LOG",59693:"CON.SQR.HALF",59698:"CON.SQR.TWO",59703:"CON.NEG.HALF",59708:"CON.LOG.TWO",59713:"LOG",59720:"GIQ",59723:"LOG.2",59775:"FMULT",59778:"FMULTT",59824:"MULTIPLY.1",59829:"MULTIPLY.2",59874:"RTS.13",59875:"LOAD.ARG.FROM.YA",59918:"ADD.EXPONENTS",59920:"ADD.EXPONENTS.1",59947:"OUTOFRNG",59953:"ZERO",59958:"JOV",59961:"MUL10",59984:"CON.TEN",59989:"DIV10",59998:"DIV",60006:"FDIV",60009:"FDIVT",60134:"COPY.RESULT.INTO.FAC",60153:"LOAD.FAC.FROM.YA",60190:"STORE.FAC.IN.TEMP2.ROUNDED",60193:"STORE.FAC.IN.TEMP1.ROUNDED",60199:"SETFOR",60203:"STORE.FAC.AT.YX.ROUNDED",60243:"COPY.ARG.TO.FAC",60245:"MFA",60259:"COPY.FAC.TO.ARG.ROUNDED",60262:"MAF",60273:"RTS.14",60274:"ROUND.FAC",60282:"INCREMENT.MANTISSA",60290:"SIGN",60294:"SIGN1",60296:"SIGN2",60303:"RTS.15",60304:"SGN",60307:"FLOAT",60315:"FLOAT.1",60320:"FLOAT.2",60335:"ABS",60338:"FCOMP",60340:"FCOMP2",60402:"QINT",60433:"RTS.16",60434:"QINT.2",60451:"INT",60480:"QINT.3",60489:"RTS.17",60490:"FIN",60513:"FIN.1",60516:"FIN.2",60518:"FIN.3",60551:"FIN.4",60554:"FIN.5",60556:"FIN.6",60568:"FIN.10",60574:"FIN.7",60576:"FIN.8",60609:"FIN.9",60629:"ADDACC",60648:"GETEXP",60682:"CON.99999999.9",60687:"CON.999999999",60692:"CON.BILLION",60697:"INPRT",60708:"LINPRT",60718:"PRINT.FAC",60721:"GO.STROUT",60724:"FOUT",60726:"FOUT.1",60812:"FOUT.2",60951:"FOUT.3",61015:"FOUT.4",61018:"FOUT.5",61023:"FOUT.6",61028:"CON.HALF",61033:"DECTBL",61069:"SQR",61079:"FPWRT",61136:"NEGOP",61146:"RTS.18",61147:"CON.LOG.E",61152:"POLY.EXP",61193:"EXP",61276:"POLYNOMIAL.ODD",61298:"POLYNOMIAL",61302:"SERMAIN",61349:"RTS.19",61350:"CON.RND.1",61354:"CON.RND.2",61358:"RND",61415:"GO.MOVMF",61418:"COS",61425:"SIN",61475:"SIN.1",61478:"SIN.2",61498:"TAN",61538:"TAN.1",61542:"CON.PI.HALF",61547:"CON.PI.DOUB",61552:"QUARTER",61557:"POLY.SIN",61598:"ATN",61645:"RTS.20",61646:"POLY.ATN",61707:"GENERIC.CHRGET",61736:"COLD.START",61909:"CALL",61918:"IN.NUMBER",61925:"PR.NUMBER",61932:"PLOTFNS",61958:"GOERR",61961:"LINCOOR",61989:"PLOT",62002:"HLIN",62017:"VLIN",62031:"COLOR",62038:"VTAB",62050:"SPEED",62061:"TRACE",62063:"NOTRACE",62067:"NORMAL",62071:"INVERSE",62073:"N.I.",62075:"N.I.F.",62080:"FLASH",62086:"HIMEM",62102:"JMM",62105:"SETHI",62118:"LOMEM",62155:"ONERR",62185:"HANDLERR",62232:"RESUME",62254:"JSYN",62257:"DEL",62352:"GR",62361:"TEXT",62367:"STORE",62396:"RECALL",62424:"HGR2",62434:"HGR",62442:"SETHPG",62450:"HCLR",62454:"BKGND",62481:"HPOSN",62551:"HPLOT0",62565:"MOVE.LEFT.OR.RIGHT",62574:"LR.1",62577:"LR.2",62582:"LR.3",62584:"LR.4",62590:"COLOR.SHIFT",62602:"MOVE.RIGHT",62620:"LRUDX1",62621:"LRUDX2",62643:"LRUD1",62644:"LRUD2",62660:"LRUD3",62664:"LRUD4",62669:"CON.03",62675:"MOVE.UP.OR.DOWN",62721:"UD.1",62725:"MOVE.DOWN",62728:"CON.04",62768:"HLINRL",62778:"HGLIN",62844:"MOVEX",62849:"MOVEX2",62898:"MSKTBL",62905:"CON.1C",62906:"COSINE.TABLE",62923:"HFIND",62976:"RTS.22",62977:"DRAW0",62981:"DRAW1",63069:"XDRAW0",63073:"XDRAW1",63161:"HFNS",63206:"GGERR",63209:"HCOLOR",63221:"RTS.23",63222:"COLORTBL",63230:"HPLOT",63265:"ROT",63271:"SCALE",63277:"DRWPNT",63337:"DRAW",63343:"XDRAW",63349:"SHLOAD",63420:"TAPEPNT",63449:"GETARYPT",63463:"HTAB",63488:"MON.PLOT",63513:"MON.HLINE",63528:"MON.VLINE",63588:"MON.SETCOL",63601:"MON.SCRN",64286:"MON.PREAD",64313:"MON.SETTXT",64320:"MON.SETGR",64347:"MON.TABV",64600:"MON.HOME",64680:"MON.WAIT",64762:"MON.RD2BIT",64780:"MON.RDKEY",64874:"MON.GETLN",65005:"MON.COUT",65163:"MON.INPORT",65173:"MON.OUTPORT",65229:"MON.WRITE",65277:"MON.READ",65282:"MON.READ2"},qs=e=>!0,js=e=>[e&ms?"N":"-",e&us?"V":"-",32&e?"X":"-",e&ps?"B":"-",8&e?"D":"-",4&e?"I":"-",2&e?"Z":"-",1&e?"C":"-"].join("");class Vs{constructor(e){this.container=e,this.verbose=!1,this.maxTrace=256,this.trace=[],this.breakpoints=new Map,this.symbols={},this.break=()=>{this.container.stop()},this.step=()=>{this.cpu.step((()=>{const e=this.cpu.getDebugInfo();v(this.printDebugInfo(e)),this.updateTrace(e)}))},this.continue=()=>{this.container.run()},this.setVerbose=e=>{this.verbose=e},this.setMaxTrace=e=>{this.maxTrace=e},this.getTrace=()=>this.trace.map(this.printDebugInfo).join("\n"),this.printTrace=()=>{v(this.getTrace())},this.setBreakpoint=(e,t)=>{this.breakpoints.set(e,t||qs)},this.clearBreakpoint=e=>{this.breakpoints.delete(e)},this.listBreakpoints=()=>{for(const[e,t]of this.breakpoints.entries())v(T(e,4),t)},this.addSymbols=e=>{this.symbols=Object.assign(Object.assign({},this.symbols),e)},this.printDebugInfo=e=>{const{pc:t,cmd:s}=e,i=this.padWithSymbol(t);return[T(t,4),"- ",i,this.dumpRegisters(e)," ",this.dumpRawOp(s)," ",this.dumpOp(t,s)].join("")},this.dumpPC=e=>{const t=this.cpu.read(e),s=this.cpu.getOpInfo(t),i=ls[s.mode];let r=T(e,4)+"- ";r+=this.padWithSymbol(e);const a=new Array(i);for(let t=0,s=e;t<i;t++,s++)a[t]=this.cpu.read(s);return r+=this.dumpRawOp(a)+" "+this.dumpOp(e,a),r},this.dumpRegisters=e=>{void 0===e&&(e=this.cpu.getDebugInfo());const{ar:t,xr:s,yr:i,sr:r,sp:a}=e;return["A="+T(t)," X="+T(s)," Y="+T(i)," P="+T(r)," S="+T(a)," ",js(r)].join("")},this.dumpPage=(e,t)=>{let s="";void 0===t&&(t=e);for(let i=e;i<=t;i++)for(let e=0;e<16;e++){s+=T(i)+T(e<<4)+": ";for(let t=0;t<16;t++)s+=T(this.cpu.read(i,16*e+t))+" ";s+="        ";for(let t=0;t<16;t++){const r=127&this.cpu.read(i,16*e+t);s+=r>=32&&r<127?String.fromCharCode(r):"."}s+="\n"}return s},this.list=e=>{const t=[];for(let s=0;s<20;s++){const s=this.cpu.read(e),i=this.cpu.getOpInfo(s);t.push(this.dumpPC(e)),e+=ls[i.mode]}return t},this.cpu=e.getCPU()}stepCycles(e){this.cpu.stepCyclesDebug(this.verbose?1:e,(()=>{var e;const t=this.cpu.getDebugInfo();if(null===(e=this.breakpoints.get(t.pc))||void 0===e?void 0:e(t))return v("breakpoint",this.printDebugInfo(t)),this.container.stop(),!0;this.verbose?v(this.printDebugInfo(t)):this.updateTrace(t)}))}updateTrace(e){this.trace.push(e),this.trace.length>this.maxTrace&&this.trace.shift()}padWithSymbol(e){const t="          ",s=this.symbols[e];let i=t;return s&&(i=`${s}${t.substring(s.length)}`),i}dumpRawOp(e){const t=new Array(4);for(let s=0;s<4;s++)s<e.length?t[s]=T(e[s]):t[s]="  ";return t.join(" ")}dumpOp(e,t){const s=this.cpu.getOpInfo(t[0]),i=t[1],r=t[2],a=r<<8|i;let o,n;const h=(e,t)=>this.symbols[e]||"$"+T(e,t);let d=s.name+" ";switch(s.mode){case"implied":break;case"immediate":d+="#"+h(i);break;case"absolute":d+=""+h(a,4);break;case"zeroPage":d+=""+h(i);break;case"relative":n=i,n>127&&(n-=256),d+=h(e+=n+2,4)+" ("+n+")";break;case"absoluteX":d+=h(a,4)+",X";break;case"absoluteY":d+=h(a,4)+",Y";break;case"zeroPageX":d+=h(i)+",X";break;case"zeroPageY":d+=h(i)+",Y";break;case"absoluteIndirect":d+="("+h(a,4)+")";break;case"zeroPageXIndirect":d+="("+h(i)+",X)";break;case"zeroPageIndirectY":d+="("+h(i)+"),Y";break;case"accumulator":d+="A";break;case"zeroPageIndirect":d+="("+h(i)+")";break;case"absoluteXIndirect":d+="("+h(a,4)+",X)";break;case"zeroPage_relative":o=i,n=r,n>127&&(n-=256),e+=n+2,d+=h(o)+","+h(e,4)+" ("+n+")"}return d}}const Js=new s,Qs=Js.readPref("computer_type2e");let $s,ei,ti=!1;switch(Qs){case"apple2e":$s="apple2e",ei="apple2e_char";break;case"apple2rm":$s="apple2e",ei="rmfont_char",ti=!0;break;case"apple2ex":$s="apple2ex",ei="apple2enh_char",ti=!0;break;default:$s="apple2enh",ei="apple2enh_char",ti=!0}const si={gl:"true"===Js.readPref("gl_canvas","true"),canvas:document.querySelector("#screen"),rom:$s,characterRom:ei,e:!0,enhanced:ti,tick:At},ii=new class{constructor(e){this.paused=!1,this.runTimer=null,this.runAnimationFrame=null,this.stats={frames:0,renderedFrames:0},this.ready=this.init(e)}init(e){return t=this,s=void 0,a=function*(){const t=r(190)(`./${e.rom}`),s=r(800)(`./${e.characterRom}`),i=e.gl?zs:Fs,a=e.gl?Xs:Ds,o=e.gl?Hs:Ls;this.cpu=new fs({"65C02":e.enhanced}),this.vm=new o(e.canvas,e.e);const[{default:n},{default:h}]=yield Promise.all([t,s,this.vm.ready]);this.rom=new n,this.characterRom=h,this.gr=new i(this.vm,1,this.characterRom,e.e),this.gr2=new i(this.vm,2,this.characterRom,e.e),this.hgr=new a(this.vm,1),this.hgr2=new a(this.vm,2),this.io=new ys(this.cpu,this.vm),this.tick=e.tick,e.e?(this.mmu=new Ys(this.cpu,this.vm,this.gr,this.gr2,this.hgr,this.hgr2,this.io,this.rom),this.cpu.addPageHandler(this.mmu)):(this.ram=[new Gs(0,3),new Gs(12,31),new Gs(96,191)],this.cpu.addPageHandler(this.ram[0]),this.cpu.addPageHandler(this.gr),this.cpu.addPageHandler(this.gr2),this.cpu.addPageHandler(this.ram[1]),this.cpu.addPageHandler(this.hgr),this.cpu.addPageHandler(this.hgr2),this.cpu.addPageHandler(this.ram[2]),this.cpu.addPageHandler(this.io),this.cpu.addPageHandler(this.rom))},new((i=void 0)||(i=Promise))((function(e,r){function o(e){try{h(a.next(e))}catch(e){r(e)}}function n(e){try{h(a.throw(e))}catch(e){r(e)}}function h(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i((function(e){e(s)}))).then(o,n)}h((a=a.apply(t,s||[])).next())}));var t,s,i,a}run(){if(this.paused=!1,this.runTimer||this.runAnimationFrame)return;this.theDebugger=new Vs(this),this.theDebugger.addSymbols(Ks);let e,t=Date.now();const s=()=>{const i=this.io.getKHz();e=Date.now();const r=30*i;let a=(e-t)*i;if(t=e,a>r&&(a=r),this.theDebugger?this.theDebugger.stepCycles(a):this.cpu.stepCycles(a),this.mmu&&this.mmu.resetVB(),this.io.annunciator(0)){const e=this.io.blit();e&&(this.vm.blit(e),this.stats.renderedFrames++)}else this.vm.blit()&&this.stats.renderedFrames++;this.stats.frames++,this.io.tick(),this.tick(),function(e){if(z=navigator.getGamepads()[0],!z)return;const t=(1.414*z.axes[0]+1)/2,s=(1.414*z.axes[1]+1)/2;e.paddle(0,t),e.paddle(1,s);for(let t=0;t<z.buttons.length;t++){const s=H[t];if(void 0!==s){const i=G[t],r=z.buttons[t];let a;a="object"==typeof r?r.pressed:1===r,a&&!i?s<=0?e.buttonDown(-s):e.keyDown(H[t]):!a&&i&&(s<=0?e.buttonUp(-s):e.keyUp()),G[t]=a}}}(this.io),!this.paused&&requestAnimationFrame&&(this.runAnimationFrame=requestAnimationFrame(s))};requestAnimationFrame?this.runAnimationFrame=requestAnimationFrame(s):this.runTimer=window.setInterval(s,30)}stop(){this.paused=!0,this.runTimer&&clearInterval(this.runTimer),this.runAnimationFrame&&cancelAnimationFrame(this.runAnimationFrame),this.runTimer=null,this.runAnimationFrame=null}getState(){var e,t;return{cpu:this.cpu.getState(),vm:this.vm.getState(),io:this.io.getState(),mmu:null===(e=this.mmu)||void 0===e?void 0:e.getState(),ram:null===(t=this.ram)||void 0===t?void 0:t.map((e=>e.getState()))}}setState(e){this.cpu.setState(e.cpu),this.vm.setState(e.vm),this.io.setState(e.io),this.mmu&&e.mmu&&this.mmu.setState(e.mmu),this.ram&&this.ram.forEach(((t,s)=>{e.ram&&t.setState(e.ram[s])}))}reset(){this.cpu.reset()}getStats(){return this.stats}getCPU(){return this.cpu}getIO(){return this.io}getMMU(){return this.mmu}getROM(){return this.rom}getVideoModes(){return this.vm}getDebugger(){return this.theDebugger}}(si);ii.ready.then((()=>{const e=ii.getIO(),t=ii.getCPU(),s=new Et("#printer-modal .paper"),i=new ns(s),r=new ds(1048576),a=new as(e,Xe),o=new ws,n=new bs(t,{block:!ti});e.setSlot(1,i),e.setSlot(2,r),e.setSlot(5,o),e.setSlot(6,a),e.setSlot(7,n),Rt(ii,a,n,s,si.e)})).catch(console.error);const ri={...e,apple2:ii}})(),a.Apple2})()}));
//# sourceMappingURL=main2e.bundle.js.map