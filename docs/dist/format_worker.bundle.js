!function(){"use strict";function t(t){return new Uint8Array(t)}function e(...t){console.log.apply(console,t)}function n(t,e){e||(e=t<256?2:4);let n="";for(let r=0;r<e;r++)n="0123456789ABCDEF"[15&t]+n,t>>=4;return n}function r(t){let e="";for(let n=0;n<4;n++)e+=String.fromCharCode(255&t),t>>=8;return e}const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function s(t){let e,n,r,s,o,c,i,l,u=0,f=0;const d=[];if(t){do{s=a.indexOf(t.charAt(u++)),o=a.indexOf(t.charAt(u++)),c=a.indexOf(t.charAt(u++)),i=a.indexOf(t.charAt(u++)),l=s<<18|o<<12|c<<6|i,e=l>>16&255,n=l>>8&255,r=255&l,d[f++]=e,64!=c&&(d[f++]=n),64!=i&&(d[f++]=r)}while(u<t.length);return new Uint8Array(d)}}const o="nibble",c=["2mg","d13","do","dsk","po","nib","woz"],i=[0,7,14,6,13,5,12,4,11,3,10,2,9,1,8,15],l=[0,8,1,9,2,10,3,11,4,12,5,13,6,14,7,15],u=[0,10,7,4,1,11,8,5,2,12,9,6,3],f=[171,173,174,175,181,182,183,186,187,189,190,191,214,215,218,219,221,222,223,234,235,237,238,239,245,246,247,250,251,253,254,255],d=[150,151,154,155,157,158,159,166,167,171,172,173,174,175,178,179,180,181,182,183,185,186,187,188,189,190,191,203,205,206,207,211,214,215,217,218,219,220,221,222,223,229,230,231,233,234,235,236,237,238,239,242,243,244,245,246,247,249,250,251,252,253,254,255];function h(t){let e=170&t,n=85&t;return e>>=1,e|=170,n|=170,[e,n]}function w(t,e,n,r){let a,s=[];a=0===n?128:0===e?40:38;for(let t=0;t<a;t++)s.push(255);const o=t^e^n;s=s.concat([213,170,150]),s=s.concat(h(t)),s=s.concat(h(e)),s=s.concat(h(n)),s=s.concat(h(o)),s=s.concat([222,170,235]);for(let t=0;t<5;t++)s.push(255);s=s.concat([213,170,173]);const c=[];for(let t=0;t<342;t++)c[t]=0;let i=85;for(let t=257;t>=0;t--){let e=r[t%256],n=c[0+i];n=n<<1|1&e,e>>=1,n=n<<1|1&e,e>>=1,c[86+t]=e,c[0+i]=n,--i<0&&(i=85)}let l=0;for(let t=0;t<342;t++){const e=c[t];s.push(d[l^e]),l=e}return s.push(d[l]),s=s.concat([222,170,235]),s.push(255),s}function k(t,e,n,r){let a,s=[];a=0===n?128:0===e?40:38;for(let t=0;t<a;t++)s.push(255);const o=t^e^n;s=s.concat([213,170,181]),s=s.concat(h(t)),s=s.concat(h(e)),s=s.concat(h(n)),s=s.concat(h(o)),s=s.concat([222,170,235]);for(let t=0;t<5;t++)s.push(255);s=s.concat([213,170,173]);const c=[];let i=0;for(let t=50;t>=0;t--){const e=r[i]>>3,n=7&r[i];i++;const a=r[i]>>3,s=7&r[i];i++;const o=r[i]>>3,l=7&r[i];i++;const u=r[i]>>3,f=7&r[i];i++;const d=r[i]>>3,h=7&r[i];i++,c[t+0]=e,c[t+51]=a,c[t+102]=o,c[t+153]=u,c[t+204]=d,c[t+256]=n<<2|(4&f)>>1|(4&h)>>2,c[t+307]=s<<2|2&f|(2&h)>>1,c[t+358]=l<<2|(1&f)<<1|1&h}c[255]=r[i]>>3,c[409]=7&r[i];let l=0;for(let t=409;t>=256;t--){const e=c[t];s.push(f[l^e]),l=e}for(let t=0;t<256;t++){const e=c[t];s.push(f[l^e]),l=e}return s.push(f[l]),s=s.concat([222,170,235]),s.push(255),s}function b(t,e){let n=0,r=!0;for(;e<t.length&&(t[e]?(n=n<<1|1,r=!1):r||(n<<=1),!(128&n));)e+=1;return{nibble:n,offset:e}}function g(e){const{data:n,name:r,side:a,rawData:s,volume:c,readOnly:l}=e,u={format:"dsk",encoding:o,name:r,side:a,volume:c,readOnly:l,tracks:[]};for(let e=0;e<35;e++){let r=[];for(let t=0;t<16;t++){const a=i[t];let o;if(s){const t=256*(16*e+a);o=new Uint8Array(s.slice(t,t+256))}else{if(!n)throw new Error("Requires data or rawData");o=new Uint8Array(n[e][a])}r=r.concat(w(c,e,t,o))}u.tracks[e]=t(r)}return u}function y(t){const{data:e,name:n,side:r,rawData:a,volume:s,readOnly:c}=t,i={format:"nib",encoding:o,name:n,side:r,volume:s||254,readOnly:c||!1,tracks:[]};for(let t=0;t<35;t++){let n;if(a){const e=6656*t;n=new Uint8Array(a.slice(e,e+6656))}else{if(!e)throw new Error("Requires data or rawData");n=e[t][0]}i.tracks[t]=n}return i}function p(e){const{data:n,name:r,side:a,rawData:s,volume:c,readOnly:i}=e,u={format:"nib",encoding:o,name:r,side:a,volume:c||254,tracks:[],readOnly:i||!1};for(let e=0;e<35;e++){let r=[];for(let t=0;t<16;t++){const a=l[t];let o;if(s){const t=256*(16*e+a);o=new Uint8Array(s.slice(t,t+256))}else{if(!n)throw new Error("Requires data or rawData");o=n[e][a]}r=r.concat(w(c,e,t,o))}u.tracks[e]=t(r)}return u}function m(t,e,n){return String.fromCharCode.apply(null,new Uint8Array(t.buffer.slice(t.byteOffset+e,t.byteOffset+n)))}class U{constructor(t){this.sides=0,this.bootSector=0,this.bitTiming=0,this.compatibleHardware=0,this.requiredRAM=0,this.largestTrack=0,this.version=t.getUint8(0),this.diskType=t.getUint8(1),this.writeProtected=t.getUint8(2),this.synchronized=t.getUint8(3),this.cleaned=t.getUint8(4),this.creator=m(t,5,37),this.version>1&&(this.sides=t.getUint8(37),this.bootSector=t.getUint8(38),this.bitTiming=t.getUint8(39),this.compatibleHardware=t.getUint16(40,!0),this.requiredRAM=t.getUint16(42,!0),this.largestTrack=t.getUint16(44,!0))}}class O{constructor(t){this.trackMap=[];for(let e=0;e<160;e++)this.trackMap.push(t.getUint8(e))}}class v{}class A extends v{constructor(t){super(),this.rawTracks=[],this.tracks=[];for(let e=0,n=0;n<t.byteLength;n+=6656,e++){let r=[];const a=[],s=t.buffer.slice(t.byteOffset+n,t.byteOffset+n+6656),o=new Uint8Array(s),c=new DataView(s).getUint16(6648,!0);for(let t=0;t<c;t++){const e=t>>3,n=7-(7&t);a[t]=o[e]>>n&1?1:0}r=[];let i=0;for(;i<a.length;){const t=b(a,i);if(!t.nibble)break;r.push(t.nibble),i=t.offset+1}this.tracks[e]=new Uint8Array(r),this.rawTracks[e]=new Uint8Array(a)}}}class D extends v{constructor(t){let e;for(super(),this.trks=[],e=0;e<160;e++){const n=t.getUint16(8*e,!0),r=t.getUint16(8*e+2,!0),a=t.getUint32(8*e+4,!0);if(0===a)break;this.trks.push({startBlock:n,blockCount:r,bitCount:a})}this.tracks=[],this.rawTracks=[];const n=t.buffer;for(e=0;e<this.trks.length;e++){const t=this.trks[e];let r=[];const a=[],s=512*t.startBlock,o=s+512*t.blockCount,c=n.slice(s,o),i=new Uint8Array(c);for(let e=0;e<t.bitCount;e++){const t=e>>3,n=7-(7&e);a[e]=i[t]>>n&1?1:0}r=[];let l=0;for(;l<a.length;){const t=b(a,l);if(!t.nibble)break;r.push(t.nibble),l=t.offset+1}this.tracks[e]=new Uint8Array(r),this.rawTracks[e]=new Uint8Array(a)}}}class S{constructor(t){const e=m(t,0,t.byteLength).split("\n");this.values=e.reduce((function(t,e){const n=e.split("\t");return t[n[0]]=n[1],t}),{})}}function E(t,a){let s=null;switch(t){case"2mg":s=function(t){let n,{rawData:a}=t;if(!a)throw new Error("Requires rawData");const{bytes:s,format:o,offset:c,readOnly:i,volume:l}=function(t){const n=new DataView(t),a=r(n.getInt32(0,!0));if("2IMG"!==a)throw new Error("Unrecognized 2mg signature: "+a);const s=r(n.getInt32(4,!0)),o=n.getInt32(12,!0),c=n.getInt32(28,!0),i=n.getInt32(24,!0),l=n.getInt32(10,!0),u=0!=(2147483648&l);let f=254;return 256&l&&(f=255&l),e("created by",s),{bytes:c,creator:s,format:o,offset:i,readOnly:u,volume:f}}(a);switch(a=a.slice(c,c+s),t=Object.assign(Object.assign({},t),{rawData:a,readOnly:i,volume:l}),o){case 1:n=p(t);break;case 2:n=y(t);break;case 0:default:n=g(t)}return n}(a);break;case"d13":s=function(t){const{data:e,name:n,side:r,rawData:a,volume:s,readOnly:c}=t,i={format:"d13",encoding:o,name:n,side:r,volume:s,readOnly:c,tracks:[]};if(!e&&!a)throw new Error("data or rawData required");for(let t=0;t<35;t++){let n=[];for(let r=0;r<13;r++){const o=u[r];let c;if(a){const e=256*(13*t+o);c=new Uint8Array(a.slice(e,e+256))}else{if(!e)throw new Error("Requires data or rawData");c=e[t][o]}n=n.concat(k(s,t,o,c))}i.tracks.push(new Uint8Array(n))}return i}(a);break;case"do":case"dsk":s=g(a);break;case"nib":s=y(a);break;case"po":s=p(a);break;case"woz":s=function(t){const{rawData:r}=t;if(!r)throw new Error("Requires rawData");const a=new DataView(r,0);let s,o=0;const c={};function i(){if(o>=a.byteLength)return null;const t=a.getUint32(o,!0),e=a.getUint32(o+4,!0),n=new DataView(a.buffer,o+8,e);return o+=e+8,{type:t,size:e,data:n}}if(function(){switch(a.getUint32(0,!0)){case 828002135:s=1;break;case 844779351:s=2;break;default:return!1}return 168626943===a.getUint32(4,!0)}()){o=12;let t=i();for(;t;){switch(t.type){case 1330007625:c.info=new U(t.data);break;case 1346456916:c.tmap=new O(t.data);break;case 1397445204:c.trks=1===s?new A(t.data):new D(t.data);break;case 1096041805:c.meta=new S(t.data);break;case 1414091351:break;default:e("Unsupported chunk",n(t.type,8))}t=i()}}else e("Invalid woz header");e(c);const{meta:l,tmap:u,trks:f}=c;return{encoding:"bitstream",trackMap:(null==u?void 0:u.trackMap)||[],tracks:(null==f?void 0:f.tracks)||[],rawTracks:(null==f?void 0:f.rawTracks)||[],readOnly:!0,name:(null==l?void 0:l.values.title)||t.name,side:(null==l?void 0:l.values.side_name)||(null==l?void 0:l.values.side)}}(a)}return s}e("Worker loaded"),addEventListener("message",(n=>{e("Worker started",n.type);const r=n.data,{drive:a}=r.payload;let u=null;switch(r.type){case"PROCESS_BINARY":{const{fmt:t,options:e}=r.payload;u=E(t,e)}break;case"PROCESS_JSON_DISK":{const{jsonDisk:t}=r.payload;u=function(t){const e=t.type,n=t.readOnly,r=t.name,a=t.disk;if(c.includes(e)){let o;if("base64"==t.encoding){o=[];for(let e=0;e<t.data.length;e++)if(o[e]=[],"nib"===t.type)o[e][0]=s(t.data[e]);else for(let n=0;n<t.data[e].length;n++)o[e][n]=s(t.data[e][n])}else o=t.data;return E(e,{volume:t.volume||254,readOnly:n,name:r,side:a,data:o})}return null}(t)}break;case"PROCESS_JSON":{const{json:e}=r.payload;u=function(e){const n=[],r=JSON.parse(e),a=r.volume,c=r.readOnly;for(let e=0;e<r.data.length;e++){let o=[];for(let t=0;t<r.data[e].length;t++){const n="po"==r.type?l[t]:i[t],c=s(r.data[e][n]);o=o.concat(w(a,e,t,c))}n[e]=t(o)}return{volume:a,format:r.type,encoding:o,name:r.name,tracks:n,readOnly:c}}(e)}}const f={type:"DISK_PROCESSED",payload:{drive:a,disk:u}};self.postMessage(f),e("Worker complete",n.type)}))}();
//# sourceMappingURL=format_worker.bundle.js.map